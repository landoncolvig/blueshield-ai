<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>BlueShield AI | Training Demo</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Barlow+Condensed:wght@400;600;700&family=Source+Sans+3:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
        :root {
            --navy-deep: #0A1628;
            --navy-mid: #132238;
            --navy-light: #1E3A5F;
            --tactical-blue: #2E5A8C;
            --accent-gold: #C9A227;
            --accent-gold-bright: #E8C547;
            --text-primary: #FFFFFF;
            --text-secondary: #A8B8C8;
            --text-muted: #6B7B8B;
            --border-color: rgba(168, 184, 200, 0.15);
            --success: #34D399;
            --warning: #FBBF24;
            --error: #F87171;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html, body {
            height: 100%;
            overflow: hidden;
        }

        body {
            font-family: 'Source Sans 3', -apple-system, sans-serif;
            background: var(--navy-deep);
            color: var(--text-primary);
            line-height: 1.6;
        }

        .demo-container {
            height: 100%;
            display: flex;
            flex-direction: column;
            padding: calc(env(safe-area-inset-top, 20px) + 1rem) 1rem 1rem;
            overflow: hidden;
        }

        /* Header */
        .demo-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--border-color);
            flex-shrink: 0;
        }

        .back-btn {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            background: transparent;
            border: 1px solid var(--border-color);
            color: var(--text-secondary);
            padding: 0.5rem 1rem;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.2s;
        }

        .back-btn:hover {
            border-color: var(--accent-gold);
            color: var(--accent-gold);
        }

        .back-btn svg {
            width: 16px;
            height: 16px;
            stroke: currentColor;
            fill: none;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .logo-icon {
            width: 32px;
            height: 32px;
            background: linear-gradient(135deg, var(--tactical-blue), var(--navy-light));
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 1px solid var(--accent-gold);
        }

        .logo-icon svg {
            width: 18px;
            height: 18px;
            fill: var(--accent-gold);
        }

        .logo-text {
            font-family: 'Barlow Condensed', sans-serif;
            font-size: 1.1rem;
            font-weight: 700;
            letter-spacing: 0.05em;
        }

        .logo-text span {
            color: var(--accent-gold);
        }

        /* Progress Indicator */
        .progress-indicator {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            padding: 1rem 0;
            flex-shrink: 0;
            background: var(--navy-mid);
            border-radius: 8px;
            margin-bottom: 0.5rem;
        }

        .progress-step {
            display: flex;
            align-items: center;
            gap: 0.35rem;
            color: var(--text-muted);
            font-size: 0.8rem;
            font-weight: 500;
        }

        .progress-step.active {
            color: var(--accent-gold);
            font-weight: 600;
        }

        .progress-step.completed {
            color: var(--success);
        }

        .progress-step-number {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
            font-weight: 700;
            background: var(--navy-light);
            border: 2px solid var(--border-color);
            transition: all 0.3s;
        }

        .progress-step.active .progress-step-number {
            border-color: var(--accent-gold);
            background: var(--accent-gold);
            color: var(--navy-deep);
            box-shadow: 0 0 12px rgba(201, 162, 39, 0.4);
        }

        .progress-step.completed .progress-step-number {
            border-color: var(--success);
            background: var(--success);
            color: var(--navy-deep);
        }

        .progress-connector {
            width: 30px;
            height: 2px;
            background: var(--border-color);
            transition: background 0.3s;
        }

        .progress-connector.completed {
            background: var(--success);
        }


        /* === JACK'S SUGGESTIONS === */

        /* Dispatch/Radio text in yellow */
        .message-dispatch .message-content,
        .message-radio .message-content,
        .dispatcher-bubble .dispatch-text {
            color: #FFD700 !important;
        }

        .message-radio {
            border-left: 3px solid #FFD700;
        }

        /* ========== SUBJECT STATUS INDICATORS ========== */

        /* Status badge base style */
        .subject-status-badge {
            position: absolute;
            top: -35px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 11px;
            font-weight: bold;
            padding: 4px 8px;
            border-radius: 4px;
            white-space: nowrap;
            z-index: 150;
            animation: statusPulse 2s ease-in-out infinite;
        }

        @keyframes statusPulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        /* HANDCUFFED - Yellow/Gold */
        .stick-figure.cuffed .subject-status-badge.cuffed-badge,
        .position-marker.subject.cuffed .subject-status-badge.cuffed-badge {
            display: block;
        }

        .subject-status-badge.cuffed-badge {
            display: none;
            background: linear-gradient(135deg, #C9A227, #FFD700);
            color: #0A1628;
            border: 2px solid #FFD700;
            box-shadow: 0 0 10px rgba(201, 162, 39, 0.5);
        }

        /* Handcuff icon on wrists area */
        .stick-figure.cuffed::after,
        .position-marker.subject.cuffed::after {
            content: 'ðŸ”—';
            position: absolute;
            bottom: 15px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 18px;
            z-index: 100;
        }

        /* TAZED - Electric Yellow with shock effect */
        .stick-figure.tazed,
        .position-marker.subject.tazed {
            animation: tazeEffect 0.15s ease-in-out 6;
        }

        @keyframes tazeEffect {
            0%, 100% { filter: brightness(1); transform: translateX(0); }
            25% { filter: brightness(2) hue-rotate(60deg); transform: translateX(-3px); }
            75% { filter: brightness(2) hue-rotate(60deg); transform: translateX(3px); }
        }

        .stick-figure.tazed-status .subject-status-badge.tazed-badge,
        .position-marker.subject.tazed-status .subject-status-badge.tazed-badge {
            display: block;
        }

        .subject-status-badge.tazed-badge {
            display: none;
            background: linear-gradient(135deg, #FCD34D, #FBBF24);
            color: #0A1628;
            border: 2px solid #F59E0B;
            box-shadow: 0 0 15px rgba(251, 191, 36, 0.7);
            animation: electricPulse 0.5s ease-in-out infinite;
        }

        @keyframes electricPulse {
            0%, 100% { box-shadow: 0 0 10px rgba(251, 191, 36, 0.5); }
            50% { box-shadow: 0 0 20px rgba(251, 191, 36, 1), 0 0 30px rgba(251, 191, 36, 0.5); }
        }

        /* Tazed body - stays yellow tinted */
        .stick-figure.tazed-status,
        .position-marker.subject.tazed-status {
            filter: brightness(1.2) saturate(1.5);
        }

        /* OC SPRAYED - Orange/Red */
        .stick-figure.oc-sprayed,
        .position-marker.subject.oc-sprayed {
            animation: ocEffect 0.5s ease-in-out;
        }

        @keyframes ocEffect {
            0% { filter: brightness(1); }
            50% { filter: brightness(1.5) hue-rotate(-30deg); }
            100% { filter: brightness(0.9) saturate(1.3); }
        }

        .stick-figure.oc-status .subject-status-badge.oc-badge,
        .position-marker.subject.oc-status .subject-status-badge.oc-badge {
            display: block;
        }

        .subject-status-badge.oc-badge {
            display: none;
            background: linear-gradient(135deg, #F97316, #EF4444);
            color: white;
            border: 2px solid #DC2626;
            box-shadow: 0 0 10px rgba(239, 68, 68, 0.5);
        }

        /* OC sprayed face effect - stays red/irritated */
        .stick-figure.oc-status,
        .position-marker.subject.oc-status {
            filter: brightness(0.9) saturate(1.3) hue-rotate(-10deg);
        }

        /* SHOT/INJURED - Red with blood */
        .stick-figure.shot .subject-status-badge.shot-badge,
        .position-marker.subject.shot .subject-status-badge.shot-badge {
            display: block;
        }

        .subject-status-badge.shot-badge {
            display: none;
            background: linear-gradient(135deg, #DC2626, #991B1B);
            color: white;
            border: 2px solid #7F1D1D;
            box-shadow: 0 0 15px rgba(220, 38, 38, 0.7);
            animation: criticalPulse 1s ease-in-out infinite;
        }

        @keyframes criticalPulse {
            0%, 100% { transform: translateX(-50%) scale(1); }
            50% { transform: translateX(-50%) scale(1.1); }
        }

        /* Blood pool effect */
        .stick-figure.shot::before,
        .position-marker.subject.shot::before {
            content: '';
            position: absolute;
            bottom: -5px;
            left: 50%;
            transform: translateX(-50%);
            width: 40px;
            height: 20px;
            background: radial-gradient(ellipse, rgba(127, 29, 29, 0.8) 0%, rgba(127, 29, 29, 0.4) 50%, transparent 70%);
            border-radius: 50%;
            z-index: 50;
            animation: bloodSpread 2s ease-out forwards;
        }

        @keyframes bloodSpread {
            0% { width: 10px; height: 5px; opacity: 0; }
            100% { width: 50px; height: 25px; opacity: 1; }
        }

        /* Shot body effect - pale/injured look */
        .stick-figure.shot,
        .position-marker.subject.shot {
            filter: brightness(0.7) saturate(0.5);
        }

        /* Blood splatter on shot */
        .stick-figure.shot::after,
        .position-marker.subject.shot::after {
            content: 'ðŸ©¸';
            position: absolute;
            top: 10px;
            right: -5px;
            font-size: 16px;
            z-index: 100;
        }

        /* COMPLIANT/PRONE - Green */
        .stick-figure.prone .subject-status-badge.prone-badge,
        .position-marker.subject.prone .subject-status-badge.prone-badge {
            display: block;
        }

        .subject-status-badge.prone-badge {
            display: none;
            background: linear-gradient(135deg, #22C55E, #16A34A);
            color: white;
            border: 2px solid #15803D;
            box-shadow: 0 0 10px rgba(34, 197, 94, 0.5);
        }

        /* FLEEING - Blue */
        .stick-figure.fleeing .subject-status-badge.fleeing-badge,
        .position-marker.subject.fleeing .subject-status-badge.fleeing-badge {
            display: block;
        }

        .subject-status-badge.fleeing-badge {
            display: none;
            background: linear-gradient(135deg, #3B82F6, #2563EB);
            color: white;
            border: 2px solid #1D4ED8;
            box-shadow: 0 0 10px rgba(59, 130, 246, 0.5);
            animation: fleeingMove 0.5s ease-in-out infinite;
        }

        @keyframes fleeingMove {
            0%, 100% { transform: translateX(-50%); }
            50% { transform: translateX(-45%); }
        }

        /* Multiple status stacking - offset badges vertically */
        .position-marker.subject .subject-status-badge:nth-of-type(2) { top: -55px; }
        .position-marker.subject .subject-status-badge:nth-of-type(3) { top: -75px; }

        /* Weapon drawn indicator for officer */
        .position-marker.officer.weapon-drawn::before,
        .position-marker.backup.weapon-drawn::before {
            content: 'ðŸ”« DRAWN';
            position: absolute;
            top: -28px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 12px;
            font-weight: bold;
            background: rgba(248, 113, 113, 0.9);
            color: white;
            border-radius: 4px;
            padding: 4px 8px;
            border: 2px solid #F87171;
            animation: weaponPulse 1s ease-in-out infinite;
            white-space: nowrap;
            z-index: 100;
        }

        .position-marker.officer.weapon-drawn[data-weapon="taser"]::before {
            content: 'âš¡ TASER';
            background: rgba(251, 191, 36, 0.9);
            border-color: #FBBF24;
        }

        @keyframes weaponPulse {
            0%, 100% { box-shadow: 0 0 8px rgba(248, 113, 113, 0.6); }
            50% { box-shadow: 0 0 20px rgba(248, 113, 113, 1); }
        }

        /* Second subject hidden inside (for domestic scenarios) */
        .stick-figure.inside-building,
        .position-marker.inside-building {
            opacity: 0;
            pointer-events: none;
            transform: scale(0.5);
            transition: all 0.5s ease-out;
        }

        .stick-figure.stepping-out,
        .position-marker.stepping-out {
            opacity: 1;
            pointer-events: auto;
            transform: scale(1);
            animation: stepOut 0.8s ease-out;
        }

        @keyframes stepOut {
            0% { opacity: 0; transform: scale(0.5) translateY(-20px); }
            50% { transform: scale(1.1) translateY(0); }
            100% { opacity: 1; transform: scale(1) translateY(0); }
        }

        /* Inside indicator */
        .inside-indicator {
            position: absolute;
            top: 80px;
            left: 55%;
            background: rgba(30, 58, 95, 0.9);
            border: 1px solid var(--accent-gold);
            border-radius: 6px;
            padding: 4px 8px;
            font-size: 0.7rem;
            color: var(--accent-gold);
            cursor: pointer;
            transition: all 0.2s;
        }

        .inside-indicator:hover {
            background: rgba(201, 162, 39, 0.2);
        }

        /* Help button */
        .help-toggle-btn {
            position: fixed;
            bottom: 100px;
            right: 20px;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--tactical-blue), var(--navy-light));
            border: 2px solid var(--accent-gold);
            color: var(--accent-gold);
            font-size: 24px;
            cursor: pointer;
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }

        .help-toggle-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 20px rgba(201, 162, 39, 0.4);
        }

        .help-toggle-btn.active {
            background: var(--accent-gold);
            color: var(--navy-deep);
        }

        .help-panel {
            position: fixed;
            bottom: 160px;
            right: 20px;
            width: 280px;
            background: var(--navy-mid);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 1rem;
            z-index: 999;
            display: none;
            box-shadow: 0 8px 32px rgba(0,0,0,0.4);
        }

        .help-panel.visible {
            display: block;
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .help-panel h4 {
            color: var(--accent-gold);
            margin-bottom: 0.75rem;
            font-size: 1rem;
        }

        .help-panel p {
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin-bottom: 0.5rem;
            line-height: 1.4;
        }

        .help-hint {
            background: rgba(201, 162, 39, 0.1);
            border-left: 3px solid var(--accent-gold);
            padding: 0.5rem;
            margin-top: 0.5rem;
            font-size: 0.8rem;
            color: var(--text-primary);
        }

        /* Post-cuff action buttons */
        .post-cuff-actions {
            display: none;
            gap: 0.5rem;
            margin-top: 0.5rem;
            padding: 0.5rem;
            background: rgba(52, 211, 153, 0.1);
            border-radius: 8px;
            border: 1px solid var(--success);
        }

        .post-cuff-actions.visible {
            display: flex;
            flex-wrap: wrap;
        }

        .post-cuff-btn {
            flex: 1;
            min-width: 120px;
            padding: 0.6rem 0.8rem;
            background: var(--navy-light);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            color: var(--text-primary);
            font-size: 0.85rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.4rem;
            transition: all 0.2s;
        }

        .post-cuff-btn:hover {
            border-color: var(--accent-gold);
            background: rgba(201, 162, 39, 0.1);
        }

        .post-cuff-btn.active {
            background: var(--accent-gold);
            color: var(--navy-deep);
            border-color: var(--accent-gold);
        }

        /* Pass/Fail result screens */
        .result-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(10, 22, 40, 0.95);
            z-index: 2000;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            animation: fadeIn 0.5s ease-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .result-icon {
            font-size: 120px;
            margin-bottom: 1rem;
            animation: bounceIn 0.6s ease-out;
        }

        @keyframes bounceIn {
            0% { transform: scale(0); }
            50% { transform: scale(1.2); }
            100% { transform: scale(1); }
        }

        .result-title {
            font-family: 'Barlow Condensed', sans-serif;
            font-size: 3rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
            text-transform: uppercase;
            letter-spacing: 0.1em;
        }

        .result-pass .result-title {
            color: var(--success);
        }

        .result-fail .result-title {
            color: var(--error);
        }

        .result-score {
            font-size: 2rem;
            margin-bottom: 1rem;
        }

        .result-message {
            font-size: 1.2rem;
            color: var(--text-secondary);
            margin-bottom: 2rem;
            text-align: center;
            max-width: 400px;
        }

        .result-continue-btn {
            padding: 1rem 2rem;
            font-size: 1.1rem;
            font-weight: 600;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .result-pass .result-continue-btn {
            background: var(--success);
            color: var(--navy-deep);
        }

        .result-fail .result-continue-btn {
            background: var(--error);
            color: white;
        }

        .result-continue-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        }

        /* Confetti animation for pass */
        .confetti {
            position: absolute;
            width: 10px;
            height: 10px;
            animation: confettiFall 3s ease-out forwards;
        }

        @keyframes confettiFall {
            0% { transform: translateY(-100vh) rotate(0deg); opacity: 1; }
            100% { transform: translateY(100vh) rotate(720deg); opacity: 0; }
        }


        /* Main content area */
        .demo-content {
            flex: 1;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
        }

        /* Scenario Selection */
        .scenario-select {
            padding: 1rem 0;
        }

        .scenario-select-header {
            text-align: center;
            margin-bottom: 1.5rem;
        }

        .scenario-select-header h2 {
            font-family: 'Barlow Condensed', sans-serif;
            font-size: 1.5rem;
            margin-bottom: 0.5rem;
        }

        .scenario-select-header p {
            color: var(--text-secondary);
            font-size: 0.95rem;
        }

        .select-section {
            margin-bottom: 1.5rem;
        }

        .select-label {
            display: block;
            font-size: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            color: var(--text-muted);
            margin-bottom: 0.75rem;
        }

        .scenario-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 0.5rem;
        }

        .scenario-card {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem;
            background: rgba(30, 58, 95, 0.3);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
        }

        .scenario-card:hover {
            border-color: var(--tactical-blue);
            background: rgba(30, 58, 95, 0.5);
        }

        .scenario-card.selected {
            border-color: var(--accent-gold);
            background: rgba(201, 162, 39, 0.1);
        }

        .scenario-card.selected::after {
            content: 'âœ“';
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            width: 20px;
            height: 20px;
            background: var(--accent-gold);
            color: var(--navy-deep);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
            font-weight: bold;
        }

        .scenario-icon-box {
            width: 40px;
            height: 40px;
            background: var(--navy-mid);
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.3rem;
            flex-shrink: 0;
        }

        .scenario-details h4 {
            font-size: 0.95rem;
            font-weight: 600;
            margin-bottom: 0.15rem;
        }

        .scenario-details p {
            font-size: 0.8rem;
            color: var(--text-muted);
            line-height: 1.3;
        }

        .scenario-score {
            position: absolute;
            top: 0.5rem;
            right: 2rem;
            font-size: 0.75rem;
            font-weight: 600;
            padding: 0.15rem 0.4rem;
            border-radius: 4px;
        }

        .scenario-score.no-score {
            color: var(--text-muted);
        }

        .scenario-score.score-high {
            color: var(--success);
            background: rgba(52, 211, 153, 0.15);
        }

        .scenario-score.score-mid {
            color: var(--warning);
            background: rgba(251, 191, 36, 0.15);
        }

        .scenario-score.score-low {
            color: var(--error);
            background: rgba(248, 113, 113, 0.15);
        }

        .difficulty-grid {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .difficulty-card {
            flex: 1;
            min-width: 60px;
            padding: 0.6rem 0.4rem;
            background: rgba(30, 58, 95, 0.3);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
        }

        .difficulty-card:hover {
            border-color: var(--tactical-blue);
        }

        .difficulty-card.selected {
            border-color: var(--accent-gold);
            background: rgba(201, 162, 39, 0.1);
        }

        .difficulty-icon {
            font-size: 1.2rem;
            margin-bottom: 0.25rem;
        }

        .difficulty-card h4 {
            font-size: 0.75rem;
            font-weight: 600;
            margin-bottom: 0.1rem;
        }

        .difficulty-card p {
            font-size: 0.65rem;
            color: var(--text-muted);
        }

        /* Start Button */
        .start-btn-container {
            position: sticky;
            bottom: 0;
            left: 0;
            right: 0;
            padding: 1rem 0;
            background: linear-gradient(to top, var(--navy-deep) 80%, transparent);
        }

        .start-scenario-btn {
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            padding: 1rem;
            background: linear-gradient(135deg, var(--accent-gold) 0%, var(--accent-gold-bright) 100%);
            color: var(--navy-deep);
            border: none;
            border-radius: 8px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .start-scenario-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(201, 162, 39, 0.3);
        }

        .start-scenario-btn svg {
            width: 20px;
            height: 20px;
            fill: currentColor;
        }

        /* Chat Section */
        .demo-chat {
            display: none;
            flex-direction: column;
            height: 100%;
        }

        .chat-header {
            display: none; /* Hidden to maximize scene space */
        }

        .chat-scenario {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .scenario-icon {
            width: 30px;
            height: 30px;
            background: rgba(201, 162, 39, 0.15);
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .scenario-icon svg {
            width: 16px;
            height: 16px;
            stroke: var(--accent-gold);
            fill: none;
        }

        .scenario-info h3 {
            font-size: 0.8rem;
            font-weight: 600;
        }

        .scenario-info span {
            font-size: 0.65rem;
            color: var(--text-muted);
        }

        .mode-badge {
            background: rgba(52, 211, 153, 0.15);
            color: var(--success);
            padding: 0.25rem 0.5rem;
            border-radius: 100px;
            font-size: 0.6rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        /* Subject Panel */
        .subject-panel {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 0.75rem;
            background: var(--navy-mid);
            border-radius: 8px;
            margin-bottom: 0.75rem;
            flex-shrink: 0;
        }

        .subject-portrait {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            background: var(--navy-light);
            border: 2px solid var(--border-color);
        }

        .subject-portrait.mood-calm { border-color: var(--success); }
        .subject-portrait.mood-nervous { border-color: var(--warning); }
        .subject-portrait.mood-agitated { border-color: #F97316; }
        .subject-portrait.mood-hostile { border-color: var(--error); }
        .subject-portrait.mood-defeated { border-color: var(--text-muted); }

        .subject-info {
            flex: 1;
        }

        .subject-name {
            font-weight: 600;
            font-size: 0.95rem;
        }

        .subject-mood {
            display: inline-flex;
            align-items: center;
            gap: 0.35rem;
            font-size: 0.75rem;
            padding: 0.2rem 0.5rem;
            border-radius: 100px;
            background: rgba(251, 191, 36, 0.15);
            color: var(--warning);
        }

        .subject-mood.mood-calm { background: rgba(52, 211, 153, 0.15); color: var(--success); }
        .subject-mood.mood-agitated { background: rgba(249, 115, 22, 0.15); color: #F97316; }
        .subject-mood.mood-hostile { background: rgba(248, 113, 113, 0.15); color: var(--error); }
        .subject-mood.mood-defeated { background: rgba(107, 123, 139, 0.15); color: var(--text-muted); }

        .mood-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: currentColor;
        }

        .subject-action {
            font-size: 0.8rem;
            color: var(--text-muted);
            font-style: italic;
            margin-top: 0.25rem;
        }

        /* Observation Panel */
        .observation-panel {
            padding: 0.75rem;
            background: var(--navy-mid);
            border-radius: 8px;
            margin-bottom: 0.75rem;
            flex-shrink: 0;
        }

        .observation-header {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-muted);
            margin-bottom: 0.5rem;
        }

        .observation-header svg {
            width: 14px;
            height: 14px;
            stroke: var(--tactical-blue);
            fill: none;
        }

        /* Subject/Observation Row - hidden to maximize scene */
        .subject-obs-row {
            display: none;
        }

        .subject-panel-compact {
            flex: 1;
            display: flex;
            align-items: center;
            gap: 0.4rem;
            padding: 0.35rem 0.5rem;
            background: var(--navy-mid);
            border-radius: 6px;
            border: 1px solid var(--border-color);
        }

        .subject-panel-compact .subject-portrait {
            width: 28px;
            height: 28px;
            font-size: 0.9rem;
        }

        .subject-panel-compact .subject-name {
            font-size: 0.7rem;
        }

        .subject-panel-compact .subject-mood {
            font-size: 0.55rem;
            padding: 0.1rem 0.3rem;
        }

        .subject-panel-compact .subject-action {
            font-size: 0.6rem;
            margin-top: 0.1rem;
        }

        .observation-panel-compact {
            flex: 1;
            padding: 0.35rem 0.5rem;
            background: var(--navy-mid);
            border-radius: 6px;
            border: 1px solid var(--border-color);
            max-height: 55px;
            overflow-y: auto;
        }

        .observation-panel-compact .observation-header {
            font-size: 0.55rem;
            margin-bottom: 0.2rem;
        }

        .observation-panel-compact .observation-header svg {
            width: 10px;
            height: 10px;
        }

        .observation-panel-compact .observation-list {
            max-height: none;
        }

        .observation-panel-compact .observation-item {
            font-size: 0.55rem;
            padding: 0.15rem 0.25rem;
            margin-bottom: 0.1rem;
        }

        .observation-list {
            display: flex;
            flex-wrap: wrap;
            gap: 0.35rem;
        }

        .observation-tag {
            display: inline-flex;
            align-items: center;
            gap: 0.35rem;
            padding: 0.25rem 0.5rem;
            background: rgba(46, 90, 140, 0.2);
            border-radius: 4px;
            font-size: 0.75rem;
            color: var(--text-secondary);
        }

        .observation-tag svg {
            width: 12px;
            height: 12px;
            stroke: currentColor;
            fill: none;
        }

        .observation-tag.warning {
            background: rgba(251, 191, 36, 0.15);
            color: var(--warning);
        }

        /* Chat Messages */
        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 0.5rem;
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
            -webkit-overflow-scrolling: touch;
        }

        .message {
            max-width: 90%;
            animation: messageIn 0.4s ease-out;
        }

        @keyframes messageIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .message-system {
            text-align: center;
            max-width: 100%;
        }

        .message-system .message-content {
            display: inline-block;
            background: rgba(46, 90, 140, 0.3);
            color: var(--text-secondary);
            padding: 0.75rem 1rem;
            border-radius: 8px;
            font-size: 0.9rem;
            border: 1px solid var(--border-color);
        }

        .message-subject {
            align-self: flex-start;
        }

        .message-subject .message-content {
            background: var(--navy-light);
            border: 1px solid var(--border-color);
            padding: 0.75rem 1rem;
            border-radius: 4px 12px 12px 12px;
        }

        .message-officer {
            align-self: flex-end;
        }

        .message-officer .message-content {
            background: var(--tactical-blue);
            padding: 0.75rem 1rem;
            border-radius: 12px 4px 12px 12px;
        }

        .message-error .message-content {
            background: rgba(248, 113, 113, 0.15);
            border-color: var(--error);
        }

        .message-dispatch {
            align-self: flex-start;
        }

        .message-dispatch .message-content {
            background: rgba(52, 211, 153, 0.15);
            border: 1px solid rgba(52, 211, 153, 0.3);
            padding: 0.6rem 1rem;
            border-radius: 4px 12px 12px 12px;
            font-style: italic;
        }

        .message-dispatch .message-label {
            color: var(--success);
        }

        .message-label {
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            color: var(--text-muted);
            margin-bottom: 0.25rem;
        }

        .hint-panel {
            margin-top: 0.5rem;
        }

        .hint-box {
            background: rgba(251, 191, 36, 0.1);
            border: 1px solid rgba(251, 191, 36, 0.25);
            border-radius: 8px;
            padding: 0.75rem;
            display: flex;
            gap: 0.75rem;
            font-size: 0.85rem;
        }

        .hint-icon {
            width: 20px;
            height: 20px;
            stroke: var(--warning);
            fill: none;
            flex-shrink: 0;
        }

        /* Input Area */
        .chat-input {
            padding: 0.5rem 0 0.25rem;
            border-top: 1px solid var(--border-color);
            flex-shrink: 0;
        }

        .input-row {
            display: flex;
            gap: 0.35rem;
            margin-bottom: 0.35rem;
            align-items: flex-end;
        }

        .input-field {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 0.15rem;
        }

        .input-field label {
            font-size: 0.55rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-muted);
        }

        .input-field input {
            width: 100%;
            padding: 0.45rem;
            background: var(--navy-mid);
            border: 1px solid var(--border-color);
            border-radius: 5px;
            color: var(--text-primary);
            font-size: 0.85rem;
        }

        .input-field input:focus {
            outline: none;
            border-color: var(--tactical-blue);
        }

        .input-field input::placeholder {
            color: var(--text-muted);
        }

        .send-btn {
            padding: 0.5rem 1rem;
            background: var(--accent-gold);
            color: var(--navy-deep);
            border: none;
            border-radius: 5px;
            font-weight: 600;
            font-size: 0.8rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.4rem;
            transition: all 0.2s;
        }

        .send-btn:hover:not(:disabled) {
            background: var(--accent-gold-bright);
        }

        .send-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .send-btn svg {
            width: 14px;
            height: 14px;
            fill: currentColor;
        }

        .end-scenario-btn {
            padding: 0.5rem 0.75rem;
            background: var(--error);
            color: white;
            border: none;
            border-radius: 5px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.4rem;
            transition: all 0.2s;
            font-size: 0.75rem;
        }

        .end-scenario-btn:hover:not(:disabled) {
            background: #ef4444;
            transform: translateY(-1px);
        }

        .end-scenario-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .end-scenario-btn svg {
            width: 16px;
            height: 16px;
            stroke: currentColor;
            fill: none;
        }

        .btn-row {
            display: flex;
            gap: 0.5rem;
        }

        .btn-row .send-btn {
            flex: 1;
        }

        .timer-display {
            font-size: 0.75rem;
            color: var(--text-muted);
            text-align: center;
            padding-top: 0.25rem;
        }

        .timer-display.active {
            color: var(--accent-gold);
        }

        /* Positioning Panel */
        .positioning-panel {
            margin-bottom: 0.75rem;
            background: var(--navy-mid);
            border-radius: 8px;
            overflow: hidden;
            border: 1px solid var(--border-color);
            flex-shrink: 0;
        }

        .positioning-toggle {
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.75rem;
            background: rgba(46, 90, 140, 0.1);
            border: none;
            color: var(--text-primary);
            cursor: pointer;
            font-size: 0.85rem;
            font-weight: 600;
            transition: all 0.2s;
            -webkit-tap-highlight-color: transparent;
        }

        .positioning-toggle:hover {
            background: rgba(46, 90, 140, 0.25);
        }

        .positioning-toggle:active {
            background: rgba(46, 90, 140, 0.35);
        }

        .positioning-toggle-left {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .positioning-toggle-left svg {
            width: 18px;
            height: 18px;
            stroke: var(--accent-gold);
            fill: none;
        }

        .positioning-toggle svg.chevron {
            width: 16px;
            height: 16px;
            stroke: currentColor;
            fill: none;
            transition: transform 0.2s;
        }

        .positioning-toggle.open svg.chevron {
            transform: rotate(180deg);
        }

        .positioning-content {
            display: none;
            padding: 0.75rem;
            border-top: 1px solid var(--border-color);
        }

        .positioning-content.open {
            display: block;
        }

        .positioning-diagram {
            background: #1a1a1a;
            border-radius: 8px;
            padding: 0.75rem;
            position: relative;
        }

        .position-scene {
            position: relative;
            width: 100%;
            height: 280px;
            background: linear-gradient(90deg,
                #2a2a2a 0%, #2a2a2a 8%,
                #3d3d3d 8%, #3d3d3d 92%,
                #2a2a2a 92%, #2a2a2a 100%
            );
            border-radius: 6px;
            overflow: hidden;
        }

        /* Road lane markings */
        .road-markings {
            position: absolute;
            left: 50%;
            top: 0;
            bottom: 0;
            width: 6px;
            display: flex;
            flex-direction: column;
            gap: 25px;
            padding: 15px 0;
        }

        .lane-dash {
            width: 6px;
            height: 40px;
            background: #f59e0b;
            border-radius: 3px;
            box-shadow: 0 0 8px rgba(245, 158, 11, 0.4);
        }

        /* Road shoulder */
        .road-shoulder {
            position: absolute;
            right: 6%;
            top: 0;
            bottom: 0;
            width: 4px;
            background: repeating-linear-gradient(
                180deg,
                #fff 0px,
                #fff 25px,
                transparent 25px,
                transparent 50px
            );
            opacity: 0.7;
        }

        .road-shoulder.left {
            right: auto;
            left: 6%;
        }

        /* Road texture/asphalt detail */
        .scene-traffic::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background:
                radial-gradient(circle at 20% 30%, rgba(255,255,255,0.02) 1px, transparent 1px),
                radial-gradient(circle at 60% 70%, rgba(255,255,255,0.02) 1px, transparent 1px),
                radial-gradient(circle at 80% 20%, rgba(255,255,255,0.02) 1px, transparent 1px);
            background-size: 30px 30px;
            pointer-events: none;
        }

        /* Street light */
        .street-light {
            position: absolute;
            right: 3%;
            top: 50px;
            width: 8px;
            height: 60px;
            background: linear-gradient(180deg, #555 0%, #333 100%);
            border-radius: 2px;
        }

        .street-light::before {
            content: '';
            position: absolute;
            top: -8px;
            left: 50%;
            transform: translateX(-50%);
            width: 20px;
            height: 12px;
            background: linear-gradient(180deg, #666 0%, #444 100%);
            border-radius: 3px 3px 0 0;
        }

        .street-light::after {
            content: '';
            position: absolute;
            top: -5px;
            left: 50%;
            transform: translateX(-50%);
            width: 16px;
            height: 6px;
            background: rgba(255, 220, 100, 0.6);
            border-radius: 2px;
            box-shadow: 0 0 20px rgba(255, 220, 100, 0.4), 0 20px 40px rgba(255, 220, 100, 0.15);
        }

        /* Direction arrow on road */
        .road-direction {
            position: absolute;
            top: 12px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 0.7rem;
            color: rgba(255,255,255,0.4);
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 3px;
            font-weight: 600;
        }

        .road-direction svg {
            width: 20px;
            height: 20px;
            stroke: rgba(255,255,255,0.4);
            fill: none;
        }

        /* Vehicle styling - suspect vehicle (top-down sedan shape) */
        .position-vehicle {
            position: absolute;
            top: 20px;
            left: 12%;
            width: 78px;
            height: 140px;
            background: transparent;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .vehicle-hood {
            width: 66px;
            height: 30px;
            background: linear-gradient(180deg, #6a6a6a 0%, #4a4a4a 100%);
            border-radius: 18px 18px 4px 4px;
            position: relative;
            box-shadow: 0 3px 12px rgba(0,0,0,0.6);
        }

        .vehicle-headlights {
            position: absolute;
            bottom: 4px;
            left: 0;
            right: 0;
            display: flex;
            justify-content: space-between;
            padding: 0 6px;
        }

        .headlight {
            width: 12px;
            height: 6px;
            background: linear-gradient(180deg, #fff 0%, #ccc 100%);
            border-radius: 3px;
            box-shadow: 0 0 8px rgba(255,255,200,0.5);
        }

        .vehicle-windshield {
            width: 60px;
            height: 16px;
            background: linear-gradient(180deg, #1a4060 0%, #2a5070 100%);
            border-radius: 3px;
            margin: 2px auto;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.3);
        }

        .vehicle-cabin {
            width: 72px;
            height: 42px;
            background: linear-gradient(180deg, #5a5a5a 0%, #4a4a4a 100%);
            border-radius: 4px;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 3px 10px rgba(0,0,0,0.4);
        }

        .vehicle-windows {
            position: absolute;
            top: 4px;
            left: 5px;
            right: 5px;
            bottom: 4px;
            display: flex;
            justify-content: space-between;
        }

        .vehicle-window {
            width: 14px;
            height: 100%;
            background: linear-gradient(180deg, #1a4060 0%, #2a5070 100%);
            border-radius: 3px;
        }

        .vehicle-label {
            font-size: 0.5rem;
            color: #aaa;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            z-index: 1;
            font-weight: 600;
        }

        .vehicle-rear-section {
            width: 60px;
            height: 12px;
            background: linear-gradient(180deg, #2a5070 0%, #1a4060 100%);
            border-radius: 3px;
            margin: 2px auto;
        }

        .vehicle-trunk {
            width: 68px;
            height: 24px;
            background: linear-gradient(180deg, #5a5a5a 0%, #4a4a4a 100%);
            border-radius: 4px 4px 16px 16px;
            position: relative;
            box-shadow: 0 3px 12px rgba(0,0,0,0.6);
        }

        .vehicle-taillights {
            position: absolute;
            bottom: 4px;
            left: 0;
            right: 0;
            display: flex;
            justify-content: space-between;
            padding: 0 6px;
        }

        .taillight {
            width: 12px;
            height: 6px;
            background: #dc2626;
            border-radius: 2px;
            box-shadow: 0 0 8px #dc2626;
        }

        /* Wheels for suspect vehicle */
        .vehicle-wheels {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            pointer-events: none;
        }

        .wheel {
            position: absolute;
            width: 12px;
            height: 24px;
            background: linear-gradient(90deg, #1a1a1a 0%, #333 50%, #1a1a1a 100%);
            border-radius: 4px;
            border: 2px solid #222;
        }

        .wheel.fl { top: 24px; left: -7px; }
        .wheel.fr { top: 24px; right: -7px; }
        .wheel.rl { bottom: 22px; left: -7px; }
        .wheel.rr { bottom: 22px; right: -7px; }

        /* Patrol car (top-down police cruiser shape) */
        .patrol-car {
            position: absolute;
            bottom: 15px;
            left: 10%;
            width: 84px;
            height: 148px;
            background: transparent;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .patrol-hood {
            width: 70px;
            height: 32px;
            background: linear-gradient(180deg, #1e4a6f 0%, #0f3050 100%);
            border-radius: 18px 18px 4px 4px;
            position: relative;
            box-shadow: 0 3px 12px rgba(0,0,0,0.6), 0 0 20px rgba(46, 90, 140, 0.5);
        }

        .patrol-pushbar {
            position: absolute;
            top: -3px;
            left: 50%;
            transform: translateX(-50%);
            width: 54px;
            height: 5px;
            background: linear-gradient(180deg, #444 0%, #222 100%);
            border-radius: 3px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.5);
        }

        .patrol-headlights {
            position: absolute;
            bottom: 5px;
            left: 0;
            right: 0;
            display: flex;
            justify-content: space-between;
            padding: 0 8px;
        }

        .patrol-headlight {
            width: 12px;
            height: 6px;
            background: linear-gradient(180deg, #ffd700 0%, #fbbf24 100%);
            border-radius: 3px;
            box-shadow: 0 0 12px #fbbf24, 0 0 20px rgba(251, 191, 36, 0.5);
        }

        .patrol-windshield {
            width: 64px;
            height: 16px;
            background: linear-gradient(180deg, #1a4060 0%, #2a5070 100%);
            border-radius: 3px;
            margin: 2px auto;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.3);
        }

        .patrol-cabin {
            width: 76px;
            height: 46px;
            background: linear-gradient(180deg, #0f3050 0%, #1e4a6f 100%);
            border-radius: 4px;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 3px 10px rgba(0,0,0,0.4);
        }

        .patrol-windows {
            position: absolute;
            top: 4px;
            left: 5px;
            right: 5px;
            bottom: 4px;
            display: flex;
            justify-content: space-between;
        }

        .patrol-window {
            width: 14px;
            height: 100%;
            background: linear-gradient(180deg, #1a4060 0%, #2a5070 100%);
            border-radius: 3px;
        }

        .lightbar {
            position: absolute;
            top: -8px;
            left: 50%;
            transform: translateX(-50%);
            width: 58px;
            height: 10px;
            background: linear-gradient(90deg, #ef4444 0%, #ef4444 45%, #3b82f6 55%, #3b82f6 100%);
            border-radius: 5px;
            box-shadow: 0 0 16px rgba(239, 68, 68, 0.7), 0 0 16px rgba(59, 130, 246, 0.7);
            animation: lightbarFlash 0.8s ease-in-out infinite;
        }

        @keyframes lightbarFlash {
            0%, 100% { opacity: 1; box-shadow: 0 0 20px rgba(239, 68, 68, 0.9), 0 0 20px rgba(59, 130, 246, 0.9); }
            50% { opacity: 0.6; box-shadow: 0 0 8px rgba(239, 68, 68, 0.4), 0 0 8px rgba(59, 130, 246, 0.4); }
        }

        .patrol-label {
            font-size: 0.5rem;
            color: #6ba3d6;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-weight: 700;
            z-index: 1;
        }

        .patrol-rear-section {
            width: 64px;
            height: 12px;
            background: linear-gradient(180deg, #2a5070 0%, #1a4060 100%);
            border-radius: 3px;
            margin: 2px auto;
        }

        .patrol-trunk {
            width: 72px;
            height: 24px;
            background: linear-gradient(180deg, #0f3050 0%, #1e4a6f 100%);
            border-radius: 4px 4px 16px 16px;
            position: relative;
            box-shadow: 0 3px 12px rgba(0,0,0,0.6);
        }

        .patrol-taillights {
            position: absolute;
            bottom: 4px;
            left: 0;
            right: 0;
            display: flex;
            justify-content: space-between;
            padding: 0 8px;
        }

        .patrol-taillight {
            width: 12px;
            height: 6px;
            background: #dc2626;
            border-radius: 2px;
            box-shadow: 0 0 6px #dc2626;
        }

        /* Patrol wheels */
        .patrol-wheels {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            pointer-events: none;
        }

        .patrol-wheel {
            position: absolute;
            width: 12px;
            height: 24px;
            background: linear-gradient(90deg, #1a1a1a 0%, #333 50%, #1a1a1a 100%);
            border-radius: 4px;
            border: 2px solid #222;
        }

        .patrol-wheel.fl { top: 26px; left: -5px; }
        .patrol-wheel.fr { top: 26px; right: -5px; }
        .patrol-wheel.rl { bottom: 22px; left: -5px; }
        .patrol-wheel.rr { bottom: 22px; right: -5px; }

        /* Draggable patrol car */
        .patrol-car.draggable {
            cursor: grab;
            transition: transform 0.3s, box-shadow 0.2s;
        }

        .patrol-car.draggable:hover {
            filter: brightness(1.2);
        }

        .patrol-car.draggable.dragging {
            cursor: grabbing;
            filter: brightness(1.3);
            z-index: 100;
        }

        /* Rotation states for patrol car */
        .patrol-car.rotate-0 { transform: rotate(0deg); }
        .patrol-car.rotate-45 { transform: rotate(45deg); }
        .patrol-car.rotate-90 { transform: rotate(90deg); }
        .patrol-car.rotate-135 { transform: rotate(135deg); }
        .patrol-car.rotate-180 { transform: rotate(180deg); }
        .patrol-car.rotate-225 { transform: rotate(225deg); }
        .patrol-car.rotate-270 { transform: rotate(270deg); }
        .patrol-car.rotate-315 { transform: rotate(315deg); }

        /* Rotate button on patrol car */
        .patrol-car .rotate-btn {
            position: absolute;
            bottom: -35px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--accent-gold);
            color: var(--navy-deep);
            font-size: 18px;
            font-weight: bold;
            width: 50px;
            height: 30px;
            border-radius: 15px;
            z-index: 200;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.4);
            cursor: pointer;
            user-select: none;
            border: 2px solid var(--navy-deep);
            transition: all 0.2s ease;
        }

        .patrol-car .rotate-btn:hover {
            background: #FFD700;
            transform: translateX(-50%) scale(1.1);
        }

        .patrol-car .rotate-btn:active {
            transform: translateX(-50%) scale(0.95);
            background: #FFA500;
        }

        .patrol-car.backup-car {
            animation: backupCarArrive 0.6s ease-out;
        }

        .patrol-car.backup-car .patrol-label {
            background: rgba(59, 130, 246, 0.9);
        }

        .patrol-car.backup-car .lightbar {
            background: linear-gradient(90deg, #3b82f6, #60a5fa, #3b82f6);
        }

        @keyframes backupCarArrive {
            0% {
                opacity: 0;
                transform: translateY(50px);
            }
            100% {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* ========== RESIDENTIAL SCENE ========== */
        .scene-residential {
            background: linear-gradient(180deg, #1a2530 0%, #2a3540 100%);
        }

        .house {
            position: absolute;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            width: 220px;
            height: 150px;
        }

        .house-roof {
            width: 0;
            height: 0;
            border-left: 120px solid transparent;
            border-right: 120px solid transparent;
            border-bottom: 55px solid #5a4a3a;
            position: relative;
            left: -10px;
            filter: drop-shadow(0 -2px 4px rgba(0,0,0,0.3));
        }

        .house-roof::before {
            content: '';
            position: absolute;
            top: 20px;
            left: 40px;
            width: 20px;
            height: 25px;
            background: linear-gradient(180deg, #6a5a4a 0%, #5a4a3a 100%);
            border: 2px solid #4a3a2a;
        }

        .house-body {
            width: 220px;
            height: 95px;
            background: linear-gradient(180deg, #7a6a5a 0%, #5a4a3a 100%);
            position: relative;
            display: flex;
            justify-content: center;
            align-items: flex-end;
            padding-bottom: 5px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.4);
        }

        .house-body::before {
            content: '';
            position: absolute;
            left: 10px;
            right: 10px;
            bottom: 0;
            height: 3px;
            background: #3a3a3a;
        }

        .house-door {
            width: 42px;
            height: 70px;
            background: linear-gradient(180deg, #5a4a3a 0%, #3a2a1a 100%);
            border: 3px solid #2a1a0a;
            border-radius: 4px 4px 0 0;
            position: relative;
            box-shadow: inset 0 0 10px rgba(0,0,0,0.3);
        }

        .house-door::before {
            content: '';
            position: absolute;
            top: 8px;
            left: 50%;
            transform: translateX(-50%);
            width: 28px;
            height: 20px;
            background: rgba(255, 220, 150, 0.2);
            border: 2px solid #2a1a0a;
        }

        .door-knob {
            position: absolute;
            right: 6px;
            top: 55%;
            width: 8px;
            height: 8px;
            background: linear-gradient(135deg, #d4a030 0%, #a07020 100%);
            border-radius: 50%;
            box-shadow: 0 1px 3px rgba(0,0,0,0.5);
        }

        .house-window {
            position: absolute;
            width: 40px;
            height: 40px;
            background: rgba(255, 220, 150, 0.35);
            border: 3px solid #3a2a1a;
            box-shadow: 0 0 15px rgba(255, 220, 150, 0.3), inset 0 0 10px rgba(255, 220, 150, 0.2);
        }

        .house-window::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 0;
            right: 0;
            height: 2px;
            background: #3a2a1a;
        }

        .house-window::after {
            content: '';
            position: absolute;
            left: 50%;
            top: 0;
            bottom: 0;
            width: 2px;
            background: #3a2a1a;
        }

        .house-window.left { left: 20px; top: 20px; }
        .house-window.right { right: 20px; top: 20px; }

        .house-label {
            position: absolute;
            top: 8px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 0.6rem;
            color: rgba(255,255,255,0.5);
            text-transform: uppercase;
            font-weight: 600;
            letter-spacing: 1px;
        }

        .porch {
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 90px;
            height: 18px;
            background: linear-gradient(180deg, #5a5a5a 0%, #3a3a3a 100%);
            border-radius: 3px 3px 0 0;
            box-shadow: 0 -2px 8px rgba(0,0,0,0.3);
        }

        .sidewalk {
            position: absolute;
            bottom: 25px;
            left: 50%;
            transform: translateX(-50%);
            width: 60px;
            height: 100px;
            background: linear-gradient(90deg, #5a5a5a 0%, #6a6a6a 50%, #5a5a5a 100%);
            box-shadow: 2px 0 4px rgba(0,0,0,0.3);
        }

        .sidewalk::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: repeating-linear-gradient(
                0deg,
                transparent 0px,
                transparent 25px,
                rgba(0,0,0,0.1) 25px,
                rgba(0,0,0,0.1) 27px
            );
        }

        .yard {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 120px;
            background: linear-gradient(180deg, #2a5a2a 0%, #1a4a1a 100%);
        }

        /* Grass texture */
        .yard::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background:
                radial-gradient(circle at 15% 30%, #3a6a3a 2px, transparent 2px),
                radial-gradient(circle at 45% 60%, #2a5a2a 2px, transparent 2px),
                radial-gradient(circle at 75% 20%, #3a6a3a 2px, transparent 2px),
                radial-gradient(circle at 85% 70%, #2a5a2a 2px, transparent 2px);
            background-size: 50px 50px;
            opacity: 0.5;
        }

        /* Bushes near house */
        .bush {
            position: absolute;
            width: 30px;
            height: 25px;
            background: radial-gradient(ellipse at 50% 100%, #2a5a2a 0%, #1a4a1a 100%);
            border-radius: 50% 50% 40% 40%;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }

        .bush.left { left: 25%; bottom: 95px; }
        .bush.right { right: 25%; bottom: 95px; }

        /* Mailbox */
        .mailbox {
            position: absolute;
            right: 20%;
            bottom: 80px;
            width: 8px;
            height: 35px;
            background: linear-gradient(180deg, #444 0%, #222 100%);
        }

        .mailbox::before {
            content: '';
            position: absolute;
            top: -10px;
            left: -6px;
            width: 20px;
            height: 14px;
            background: linear-gradient(180deg, #333 0%, #111 100%);
            border-radius: 3px 3px 2px 2px;
        }

        .street-residential {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 60px;
            background: linear-gradient(180deg, #4a4a4a 0%, #3a3a3a 100%);
        }

        /* Street center line */
        .street-residential::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 0;
            right: 0;
            height: 3px;
            background: repeating-linear-gradient(
                90deg,
                #f59e0b 0px,
                #f59e0b 20px,
                transparent 20px,
                transparent 40px
            );
            transform: translateY(-50%);
        }

        .curb {
            position: absolute;
            bottom: 60px;
            left: 0;
            right: 0;
            height: 6px;
            background: linear-gradient(180deg, #777 0%, #555 100%);
        }

        /* Porch light */
        .porch-light {
            position: absolute;
            top: -15px;
            right: -5px;
            width: 10px;
            height: 10px;
            background: radial-gradient(circle, rgba(255, 220, 100, 0.8) 0%, rgba(255, 220, 100, 0) 70%);
            border-radius: 50%;
            box-shadow: 0 0 15px rgba(255, 220, 100, 0.5);
        }

        /* ========== BUSINESS SCENE ========== */
        .scene-business {
            background: linear-gradient(180deg, #1a1a2a 0%, #2a2a3a 100%);
        }

        .store {
            position: absolute;
            top: 5px;
            left: 50%;
            transform: translateX(-50%);
            width: 280px;
            height: 160px;
        }

        .store-sign {
            width: 100%;
            height: 32px;
            background: linear-gradient(180deg, #2a4a6a 0%, #1a3a5a 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            color: #9bd;
            text-transform: uppercase;
            letter-spacing: 2px;
            font-weight: 700;
            border-radius: 4px 4px 0 0;
            box-shadow: 0 -2px 10px rgba(100, 150, 200, 0.3);
            text-shadow: 0 0 10px rgba(100, 150, 200, 0.5);
        }

        .store-front {
            width: 100%;
            height: 128px;
            background: linear-gradient(180deg, #5a5a6a 0%, #3a3a4a 100%);
            display: flex;
            align-items: flex-end;
            justify-content: center;
            gap: 12px;
            padding-bottom: 0;
            position: relative;
            box-shadow: 0 4px 15px rgba(0,0,0,0.5);
        }

        .store-front::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 8px;
            background: linear-gradient(180deg, #6a6a7a 0%, #4a4a5a 100%);
        }

        .store-window {
            width: 75px;
            height: 90px;
            background: linear-gradient(180deg, rgba(100, 150, 200, 0.25) 0%, rgba(80, 130, 180, 0.15) 100%);
            border: 3px solid #2a2a3a;
            position: relative;
            bottom: 0;
            box-shadow: inset 0 0 20px rgba(100, 150, 200, 0.2);
        }

        .store-window::before {
            content: 'SALE';
            position: absolute;
            top: 10px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 0.6rem;
            color: #ef4444;
            font-weight: 700;
            text-shadow: 0 0 5px #ef4444;
        }

        .store-door {
            width: 55px;
            height: 100px;
            background: linear-gradient(180deg, rgba(100, 150, 200, 0.35) 0%, rgba(80, 130, 180, 0.2) 100%);
            border: 4px solid #2a2a3a;
            position: relative;
            bottom: 0;
            box-shadow: inset 0 0 15px rgba(100, 150, 200, 0.3);
        }

        .store-door::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 10px;
            height: 30px;
            background: #444;
            border-radius: 2px;
        }

        .store-door::after {
            content: 'ENTRANCE';
            position: absolute;
            top: 8px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 0.45rem;
            color: rgba(255,255,255,0.6);
            font-weight: 600;
            letter-spacing: 0.5px;
        }

        .parking-lot {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 150px;
            background: linear-gradient(180deg, #4a4a4a 0%, #3a3a3a 100%);
        }

        .parking-lot::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: #fbbf24;
        }

        .parking-lines {
            position: absolute;
            bottom: 30px;
            left: 25px;
            right: 25px;
            height: 80px;
            display: flex;
            gap: 30px;
        }

        .parking-space {
            width: 2px;
            height: 100%;
            background: #666;
        }

        .lp-office {
            position: absolute;
            top: 130px;
            right: 20px;
            padding: 4px 8px;
            background: rgba(46, 90, 140, 0.3);
            border: 1px solid var(--tactical-blue);
            border-radius: 4px;
            font-size: 0.45rem;
            color: var(--tactical-blue);
        }

        /* ========== OUTDOOR/PARK SCENE ========== */
        .scene-outdoor {
            background: linear-gradient(180deg, #1a2a1a 0%, #2a3a2a 100%);
        }

        .park-ground {
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 200px;
            background: linear-gradient(180deg, #2a4a2a 0%, #1a3a1a 100%);
        }

        .park-path {
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 50px;
            height: 280px;
            background: #5a5a5a;
        }

        .park-bench {
            position: absolute;
            top: 80px;
            left: 30%;
            width: 50px;
            height: 20px;
            background: #5a4030;
            border-radius: 3px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }

        .park-bench::before,
        .park-bench::after {
            content: '';
            position: absolute;
            bottom: -8px;
            width: 6px;
            height: 8px;
            background: #4a3020;
        }

        .park-bench::before { left: 5px; }
        .park-bench::after { right: 5px; }

        .tree {
            position: absolute;
        }

        .tree-trunk {
            width: 12px;
            height: 30px;
            background: #5a4030;
            margin: 0 auto;
        }

        .tree-canopy {
            width: 40px;
            height: 40px;
            background: radial-gradient(circle, #3a6a3a 0%, #2a5a2a 100%);
            border-radius: 50%;
            margin-bottom: -5px;
        }

        .streetlight {
            position: absolute;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .streetlight-pole {
            width: 4px;
            height: 50px;
            background: #666;
        }

        .streetlight-lamp {
            width: 16px;
            height: 8px;
            background: #ffd700;
            border-radius: 4px 4px 0 0;
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.3);
        }

        /* ========== BAR/VENUE SCENE ========== */
        .scene-bar {
            background: linear-gradient(180deg, #1a1520 0%, #2a2530 100%);
        }

        .bar-building {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            width: 160px;
            height: 100px;
        }

        .bar-sign {
            width: 100%;
            height: 22px;
            background: #1a1a1a;
            border: 2px solid #ff4444;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.5rem;
            color: #ff6666;
            text-transform: uppercase;
            letter-spacing: 2px;
            box-shadow: 0 0 15px rgba(255, 68, 68, 0.3);
        }

        .bar-front {
            width: 100%;
            height: 78px;
            background: linear-gradient(180deg, #3a3040 0%, #2a2030 100%);
            display: flex;
            align-items: flex-end;
            justify-content: center;
            position: relative;
        }

        .bar-door {
            width: 40px;
            height: 65px;
            background: #1a1520;
            border: 2px solid #4a4050;
            position: relative;
        }

        .bouncer-area {
            position: absolute;
            left: -30px;
            bottom: 10px;
            width: 25px;
            height: 35px;
            background: rgba(100, 100, 100, 0.3);
            border-radius: 3px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.4rem;
            color: #888;
        }

        .crowd-area {
            position: absolute;
            bottom: 130px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 8px;
        }

        .bystander {
            width: 16px;
            height: 16px;
            background: rgba(150, 150, 150, 0.3);
            border: 1px solid #666;
            border-radius: 50%;
            font-size: 0.4rem;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #888;
        }

        /* Position markers */
        .position-marker {
            position: absolute;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            z-index: 10;
        }

        .position-marker.subject {
            background: rgba(248, 113, 113, 0.3);
            border: 3px solid var(--error);
            color: var(--error);
        }

        .position-marker.officer {
            background: rgba(52, 211, 153, 0.3);
            border: 3px solid var(--success);
            color: var(--success);
            flex-direction: column;
            gap: 2px;
            cursor: grab;
            user-select: none;
            -webkit-user-select: none;
            touch-action: none;
            box-shadow: 0 0 15px rgba(52, 211, 153, 0.4);
        }

        .position-marker.officer:active,
        .position-marker.officer.dragging {
            cursor: grabbing;
            transform: scale(1.15);
            box-shadow: 0 0 25px var(--success), 0 4px 20px rgba(0,0,0,0.5);
            z-index: 100;
            transition: none;
        }

        .officer-facing {
            font-size: 0.55rem;
            opacity: 0.9;
        }

        .officer-facing svg {
            width: 8px;
            height: 8px;
            stroke: var(--success);
            fill: none;
        }

        .position-marker:hover {
            transform: scale(1.1);
        }

        .position-marker.officer.dragging:hover {
            transform: scale(1.15);
        }

        .position-marker.subject.active {
            box-shadow: 0 0 12px var(--error);
        }

        .position-marker.subject {
            cursor: pointer;
        }

        .position-marker.subject:hover {
            box-shadow: 0 0 15px var(--error);
        }

        .position-marker.subject.in-vehicle {
            z-index: 26;
            width: 32px;
            height: 32px;
            font-size: 0.7rem;
            background: rgba(248, 113, 113, 0.5);
            border-width: 2px;
            box-shadow: 0 0 10px rgba(248, 113, 113, 0.6);
        }

        .position-marker.subject.in-vehicle::after {
            display: none;
        }

        /* Second subject (for multi-person scenarios) */
        .position-marker.subject2 {
            background: rgba(251, 146, 60, 0.25);
            border: 2px solid #fb923c;
            color: #fb923c;
            cursor: pointer;
        }

        .position-marker.subject2:hover {
            box-shadow: 0 0 15px rgba(251, 146, 60, 0.6);
        }

        /* Second person marker (blue) - for domestic/multi-person scenes */
        .position-marker.person2 {
            background: rgba(96, 165, 250, 0.25);
            border: 2px solid #60a5fa;
            color: #60a5fa;
            cursor: pointer;
        }

        .position-marker.person2:hover {
            box-shadow: 0 0 15px rgba(96, 165, 250, 0.6);
        }

        /* Force Options Menu */
        .force-options-menu {
            position: absolute;
            background: rgba(30, 30, 40, 0.98);
            border: 1px solid rgba(255,255,255,0.15);
            border-radius: 8px;
            padding: 6px;
            z-index: 200;
            box-shadow: 0 8px 30px rgba(0,0,0,0.6);
            display: none;
            min-width: 120px;
        }

        .force-options-menu.visible {
            display: block;
            animation: menuFadeIn 0.15s ease-out;
        }

        @keyframes menuFadeIn {
            from { opacity: 0; transform: translateY(-5px) scale(0.95); }
            to { opacity: 1; transform: translateY(0) scale(1); }
        }

        .force-option {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.7rem;
            font-weight: 600;
            color: var(--text-secondary);
            transition: all 0.15s ease;
            border: none;
            background: transparent;
            width: 100%;
            text-align: left;
        }

        .force-option:hover {
            background: rgba(255,255,255,0.1);
            color: var(--text-primary);
        }

        .force-option .force-icon {
            width: 18px;
            height: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
            font-size: 0.65rem;
        }

        .force-option.lethal .force-icon {
            background: rgba(248, 113, 113, 0.3);
            color: #f87171;
        }
        .force-option.lethal:hover {
            background: rgba(248, 113, 113, 0.2);
            color: #f87171;
        }

        .force-option.less-lethal .force-icon {
            background: rgba(251, 191, 36, 0.3);
            color: #fbbf24;
        }
        .force-option.less-lethal:hover {
            background: rgba(251, 191, 36, 0.2);
            color: #fbbf24;
        }

        .force-option.control .force-icon {
            background: rgba(96, 165, 250, 0.3);
            color: #60a5fa;
        }
        .force-option.control:hover {
            background: rgba(96, 165, 250, 0.2);
            color: #60a5fa;
        }

        .force-option.arrest .force-icon {
            background: rgba(52, 211, 153, 0.3);
            color: #34d399;
        }
        .force-option.arrest:hover {
            background: rgba(52, 211, 153, 0.2);
            color: #34d399;
        }

        /* Selected states for force options */
        .force-option.selected {
            transform: scale(1.02);
            box-shadow: 0 0 10px currentColor;
        }

        .force-option.lethal.selected {
            background: rgba(248, 113, 113, 0.3);
            border: 2px solid #f87171;
            color: #f87171;
        }

        .force-option.less-lethal.selected {
            background: rgba(251, 191, 36, 0.3);
            border: 2px solid #fbbf24;
            color: #fbbf24;
        }

        .force-option.control.selected {
            background: rgba(96, 165, 250, 0.3);
            border: 2px solid #60a5fa;
            color: #60a5fa;
        }

        .force-option.arrest.selected {
            background: rgba(52, 211, 153, 0.3);
            border: 2px solid #34d399;
            color: #34d399;
        }

        .force-menu-divider {
            height: 1px;
            background: rgba(255,255,255,0.1);
            margin: 4px 0;
        }

        .force-menu-header {
            font-size: 0.55rem;
            color: var(--text-muted);
            padding: 4px 12px 2px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* Officer Action Menu */
        .officer-action-menu {
            position: absolute;
            background: rgba(15, 30, 45, 0.4);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(52, 211, 153, 0.2);
            border-radius: 12px;
            padding: 14px;
            z-index: 200;
            box-shadow: 0 8px 30px rgba(0,0,0,0.3);
            display: none;
            min-width: 280px;
        }

        .officer-action-menu.visible {
            display: block;
            animation: menuFadeIn 0.15s ease-out;
        }

        .officer-menu-header {
            font-size: 0.6rem;
            color: var(--success);
            padding: 0 4px 6px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border-bottom: 1px solid rgba(52, 211, 153, 0.2);
            margin-bottom: 8px;
            font-weight: 700;
        }

        .officer-menu-input {
            margin-bottom: 12px;
        }

        .officer-menu-input label {
            display: block;
            font-size: 0.65rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-muted);
            margin-bottom: 4px;
        }

        .officer-menu-input input,
        .officer-menu-input textarea {
            width: 100%;
            padding: 10px 12px;
            background: rgba(0,0,0,0.2);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 6px;
            color: var(--text-primary);
            font-size: 0.9rem;
            font-family: inherit;
            resize: none;
        }

        .officer-menu-input textarea {
            min-height: 50px;
            max-height: 100px;
            line-height: 1.4;
        }

        .officer-menu-input input:focus,
        .officer-menu-input textarea:focus {
            outline: none;
            border-color: var(--success);
            background: rgba(0,0,0,0.3);
        }

        .officer-menu-input input::placeholder,
        .officer-menu-input textarea::placeholder {
            color: var(--text-muted);
        }

        .officer-menu-divider {
            height: 1px;
            background: rgba(255,255,255,0.1);
            margin: 8px 0;
        }

        .officer-menu-section {
            font-size: 0.5rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 6px;
        }

        .officer-weapon-btns {
            display: flex;
            gap: 6px;
        }

        .officer-weapon-btn {
            flex: 1;
            padding: 8px 10px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.65rem;
            font-weight: 600;
            border: 1px solid rgba(255,255,255,0.15);
            background: rgba(0,0,0,0.2);
            color: var(--text-secondary);
            transition: all 0.15s ease;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
        }

        .officer-weapon-btn:hover {
            background: rgba(255,255,255,0.1);
            color: var(--text-primary);
        }

        .officer-weapon-btn.pistol {
            border-color: rgba(248, 113, 113, 0.4);
        }
        .officer-weapon-btn.pistol:hover {
            background: rgba(248, 113, 113, 0.2);
            color: #f87171;
        }

        .officer-weapon-btn.taser {
            border-color: rgba(251, 191, 36, 0.4);
        }
        .officer-weapon-btn.taser:hover {
            background: rgba(251, 191, 36, 0.2);
            color: #fbbf24;
        }

        /* Backup officer weapon options */
        .officer-weapon-btn.pepperball {
            border-color: rgba(251, 146, 60, 0.4);
        }
        .officer-weapon-btn.pepperball:hover,
        .officer-weapon-btn.pepperball.selected {
            background: rgba(251, 146, 60, 0.2);
            color: #fb923c;
            border-color: #fb923c;
        }

        .officer-weapon-btn.fortymm {
            border-color: rgba(168, 85, 247, 0.4);
        }
        .officer-weapon-btn.fortymm:hover,
        .officer-weapon-btn.fortymm.selected {
            background: rgba(168, 85, 247, 0.2);
            color: #a855f7;
            border-color: #a855f7;
        }

        .officer-weapon-btn.rifle {
            border-color: rgba(239, 68, 68, 0.4);
        }
        .officer-weapon-btn.rifle:hover,
        .officer-weapon-btn.rifle.selected {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
            border-color: #ef4444;
        }

        /* Backup Officer Action Menu */
        .backup-action-menu {
            position: absolute;
            background: rgba(15, 30, 50, 0.9);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            border: 1px solid rgba(59, 130, 246, 0.3);
            border-radius: 10px;
            padding: 12px;
            z-index: 200;
            box-shadow: 0 8px 25px rgba(0,0,0,0.5);
            display: none;
            min-width: 200px;
        }

        .backup-action-menu.visible {
            display: block;
            animation: menuFadeIn 0.15s ease-out;
        }

        .backup-menu-header {
            font-size: 0.65rem;
            font-weight: 700;
            color: #60a5fa;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 10px;
            padding-bottom: 6px;
            border-bottom: 1px solid rgba(59, 130, 246, 0.2);
        }

        .backup-command-section {
            margin-bottom: 8px;
        }

        .backup-command-section label {
            display: block;
            font-size: 0.65rem;
            color: var(--text-muted);
            margin-bottom: 4px;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .backup-command-section textarea {
            width: 100%;
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 6px;
            padding: 8px;
            color: white;
            font-size: 0.8rem;
            resize: none;
            font-family: inherit;
        }

        .backup-command-section textarea:focus {
            outline: none;
            border-color: rgba(59, 130, 246, 0.5);
        }

        .backup-command-section textarea::placeholder {
            color: rgba(255, 255, 255, 0.3);
        }

        .backup-command-send {
            width: 100%;
            margin-top: 6px;
            padding: 8px 12px;
            background: linear-gradient(135deg, #3b82f6, #2563eb);
            border: none;
            border-radius: 6px;
            color: white;
            font-size: 0.75rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .backup-command-send:hover {
            background: linear-gradient(135deg, #60a5fa, #3b82f6);
            transform: translateY(-1px);
        }

        .backup-menu-divider {
            height: 1px;
            background: rgba(255, 255, 255, 0.1);
            margin: 10px 0;
        }

        .backup-menu-section {
            font-size: 0.6rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 6px;
        }

        .backup-weapon-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 6px;
        }

        .officer-weapon-btn.pistol.selected {
            background: rgba(248, 113, 113, 0.3);
            border-color: #f87171;
            color: #f87171;
            box-shadow: 0 0 8px rgba(248, 113, 113, 0.4);
        }

        .officer-weapon-btn.taser.selected {
            background: rgba(251, 191, 36, 0.3);
            border-color: #fbbf24;
            color: #fbbf24;
            box-shadow: 0 0 8px rgba(251, 191, 36, 0.4);
        }

        .officer-weapon-btn .weapon-icon {
            font-size: 1rem;
        }

        .officer-menu-send {
            margin-top: 10px;
            width: 100%;
            padding: 8px;
            background: var(--success);
            color: var(--navy-deep);
            border: none;
            border-radius: 6px;
            font-weight: 700;
            font-size: 0.7rem;
            cursor: pointer;
            transition: all 0.15s;
        }

        .officer-menu-send:hover {
            background: #4ade80;
        }

        /* Speech Bubbles */
        .speech-bubble {
            position: absolute;
            max-width: 280px;
            min-width: 120px;
            max-height: 120px;
            overflow-y: auto;
            padding: 8px 12px;
            border-radius: 12px;
            font-size: 0.75rem;
            line-height: 1.4;
            z-index: 50;
            animation: bubbleFadeIn 0.3s ease-out;
            box-shadow: 0 4px 15px rgba(0,0,0,0.4);
            word-wrap: break-word;
        }

        /* Custom scrollbar for speech bubbles */
        .speech-bubble::-webkit-scrollbar {
            width: 4px;
        }

        .speech-bubble::-webkit-scrollbar-track {
            background: transparent;
        }

        .speech-bubble::-webkit-scrollbar-thumb {
            background: rgba(255,255,255,0.2);
            border-radius: 2px;
        }

        @keyframes bubbleFadeIn {
            from { opacity: 0; transform: scale(0.9) translateY(5px); }
            to { opacity: 1; transform: scale(1) translateY(0); }
        }

        .speech-bubble.subject-bubble {
            background: rgba(248, 113, 113, 0.15);
            border: 1px solid rgba(248, 113, 113, 0.4);
            color: #fca5a5;
        }

        /* Tail pointing DOWN to the subject */
        .speech-bubble.subject-bubble::after {
            content: '';
            position: absolute;
            bottom: -10px;
            left: 50%;
            transform: translateX(-50%);
            width: 0;
            height: 0;
            border-left: 10px solid transparent;
            border-right: 10px solid transparent;
            border-top: 10px solid rgba(248, 113, 113, 0.4);
        }

        .speech-bubble.subject-bubble::before {
            content: '';
            position: absolute;
            bottom: -8px;
            left: 50%;
            transform: translateX(-50%);
            width: 0;
            height: 0;
            border-left: 8px solid transparent;
            border-right: 8px solid transparent;
            border-top: 8px solid rgba(248, 113, 113, 0.15);
            z-index: 1;
        }

        .speech-bubble.officer-bubble {
            background: rgba(52, 211, 153, 0.08);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            border: 1px solid rgba(52, 211, 153, 0.25);
            color: #6ee7b7;
        }

        /* Tail pointing DOWN to the officer */
        .speech-bubble.officer-bubble::after {
            content: '';
            position: absolute;
            bottom: -10px;
            left: 50%;
            transform: translateX(-50%);
            width: 0;
            height: 0;
            border-left: 10px solid transparent;
            border-right: 10px solid transparent;
            border-top: 10px solid rgba(52, 211, 153, 0.25);
        }

        .speech-bubble.officer-bubble::before {
            content: '';
            position: absolute;
            bottom: -8px;
            left: 50%;
            transform: translateX(-50%);
            width: 0;
            height: 0;
            border-left: 8px solid transparent;
            border-right: 8px solid transparent;
            border-top: 8px solid rgba(52, 211, 153, 0.08);
            z-index: 1;
        }

        /* Officer bubble below marker - tail points UP */
        .speech-bubble.officer-bubble.below-marker::after {
            bottom: auto;
            top: -10px;
            border-top: none;
            border-bottom: 10px solid rgba(52, 211, 153, 0.25);
        }

        .speech-bubble.officer-bubble.below-marker::before {
            bottom: auto;
            top: -8px;
            border-top: none;
            border-bottom: 8px solid rgba(52, 211, 153, 0.08);
        }

        /* Backup officer bubble */
        .speech-bubble.backup-bubble {
            background: rgba(96, 165, 250, 0.15);
            border: 1px solid rgba(96, 165, 250, 0.4);
            color: #93c5fd;
            max-width: 220px;
            font-size: 0.7rem;
        }

        .speech-bubble.backup-bubble .bubble-label {
            color: #60a5fa;
        }

        .speech-bubble.backup-bubble::after {
            content: '';
            position: absolute;
            bottom: -10px;
            left: 50%;
            transform: translateX(-50%);
            width: 0;
            height: 0;
            border-left: 10px solid transparent;
            border-right: 10px solid transparent;
            border-top: 10px solid rgba(96, 165, 250, 0.4);
        }

        .speech-bubble.backup-bubble::before {
            content: '';
            position: absolute;
            bottom: -8px;
            left: 50%;
            transform: translateX(-50%);
            width: 0;
            height: 0;
            border-left: 8px solid transparent;
            border-right: 8px solid transparent;
            border-top: 8px solid rgba(96, 165, 250, 0.15);
            z-index: 1;
        }

        /* Subject bubble - positioned dynamically by JavaScript */

        /* Side-positioned bubbles (when not enough room above) */
        .speech-bubble.subject-bubble.side-right::after {
            bottom: auto;
            top: 50%;
            left: -10px;
            right: auto;
            transform: translateY(-50%);
            border-top: 10px solid transparent;
            border-bottom: 10px solid transparent;
            border-right: 10px solid rgba(248, 113, 113, 0.4);
            border-left: none;
        }

        .speech-bubble.subject-bubble.side-right::before {
            bottom: auto;
            top: 50%;
            left: -8px;
            right: auto;
            transform: translateY(-50%);
            border-top: 8px solid transparent;
            border-bottom: 8px solid transparent;
            border-right: 8px solid rgba(248, 113, 113, 0.15);
            border-left: none;
        }

        .speech-bubble.subject-bubble.side-left::after {
            bottom: auto;
            top: 50%;
            right: -10px;
            left: auto;
            transform: translateY(-50%);
            border-top: 10px solid transparent;
            border-bottom: 10px solid transparent;
            border-left: 10px solid rgba(248, 113, 113, 0.4);
            border-right: none;
        }

        .speech-bubble.subject-bubble.side-left::before {
            bottom: auto;
            top: 50%;
            right: -8px;
            left: auto;
            transform: translateY(-50%);
            border-top: 8px solid transparent;
            border-bottom: 8px solid transparent;
            border-left: 8px solid rgba(248, 113, 113, 0.15);
            border-right: none;
        }

        .speech-bubble .bubble-label {
            font-size: 0.55rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            opacity: 0.7;
            margin-bottom: 3px;
        }

        .speech-bubble.subject-bubble .bubble-label {
            color: #f87171;
        }

        .speech-bubble.officer-bubble .bubble-label {
            color: #34d399;
        }

        /* Dispatcher Element - Top Right */
        .dispatcher-element {
            position: absolute;
            top: 8px;
            right: 8px;
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            z-index: 60;
            pointer-events: none;
        }

        .dispatcher-avatar {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, #1e3a5f, #0f2847);
            border: 2px solid rgba(52, 211, 153, 0.5);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.4);
        }

        .dispatcher-label {
            font-size: 0.5rem;
            color: var(--success);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-top: 2px;
            font-weight: 700;
        }

        .dispatcher-bubble {
            position: absolute;
            top: 45px;
            right: 0;
            background: rgba(52, 211, 153, 0.15);
            border: 1px solid rgba(52, 211, 153, 0.4);
            border-radius: 8px;
            padding: 8px 12px;
            max-width: 180px;
            min-width: 120px;
            color: #6ee7b7;
            font-size: 0.7rem;
            display: none;
            animation: dispatchFadeIn 0.3s ease-out;
        }

        .dispatcher-bubble.visible {
            display: block;
        }

        .dispatcher-bubble::before {
            content: '';
            position: absolute;
            top: -8px;
            right: 15px;
            width: 0;
            height: 0;
            border-left: 8px solid transparent;
            border-right: 8px solid transparent;
            border-bottom: 8px solid rgba(52, 211, 153, 0.4);
        }

        .dispatcher-bubble .dispatch-text {
            font-style: italic;
        }

        .dispatcher-bubble .dispatch-time {
            font-size: 0.55rem;
            color: rgba(110, 231, 183, 0.6);
            margin-top: 4px;
            text-align: right;
        }

        @keyframes dispatchFadeIn {
            from { opacity: 0; transform: translateY(-5px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .dispatcher-avatar.active {
            animation: dispatchPulse 0.5s ease-out;
            border-color: var(--success);
            box-shadow: 0 0 12px rgba(52, 211, 153, 0.5);
        }

        @keyframes dispatchPulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        /* Scene-Centric Layout */
        .scene-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
            min-height: 0;
            overflow: hidden;
        }

        .scene-main {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: transparent;
            border-radius: 8px;
            overflow: hidden;
            min-height: 0;
        }

        .scene-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.6rem 0.75rem;
            background: rgba(46, 90, 140, 0.15);
            border-bottom: 1px solid var(--border-color);
            flex-shrink: 0;
        }

        .scene-header-left {
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .scene-title {
            font-family: 'Barlow Condensed', sans-serif;
            font-size: 1rem;
            font-weight: 600;
            color: var(--accent-gold);
        }

        .scene-subtitle {
            font-size: 0.7rem;
            color: var(--text-muted);
        }

        .scene-diagram-wrapper {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 0;
            min-height: 0;
            overflow: hidden;
        }

        .scene-diagram-wrapper .position-scene {
            flex: 1;
            height: auto;
            min-height: 500px;
            border-radius: 8px;
        }

        .scene-controls {
            display: none; /* Hidden - use drag to position */
        }

        .scene-controls .position-btn {
            flex: 1;
            min-width: 70px;
            padding: 0.35rem 0.5rem;
            font-size: 0.65rem;
        }

        /* Info row - hidden to maximize scene */
        .scene-info-row {
            display: none;
        }

        .scene-info-box {
            flex: 1;
            padding: 0.3rem 0.4rem;
            background: rgba(0,0,0,0.2);
            border-radius: 5px;
            border: 1px solid var(--border-color);
        }

        .scene-info-box.current-action-box {
            border-left: 3px solid var(--accent-gold);
        }

        .scene-info-box.position-info-box {
            border-left: 3px solid var(--tactical-blue);
        }

        .scene-info-label {
            font-size: 0.5rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-muted);
            margin-bottom: 1px;
        }

        .scene-info-text {
            font-size: 0.6rem;
            color: var(--text-secondary);
        }

        .position-marker.officer.active {
            box-shadow: 0 0 12px var(--success);
        }

        .position-marker.backup {
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
            border-color: #60a5fa;
            font-size: 0.65rem;
            animation: backupArrive 0.5s ease-out;
        }

        .position-marker.backup::after {
            content: 'BACKUP';
            position: absolute;
            bottom: -14px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 0.45rem;
            color: #60a5fa;
            white-space: nowrap;
            font-weight: 700;
            letter-spacing: 0.5px;
        }

        @keyframes backupArrive {
            0% {
                opacity: 0;
                transform: translate(-50%, -50%) scale(0.3);
            }
            50% {
                transform: translate(-50%, -50%) scale(1.2);
            }
            100% {
                opacity: 1;
                transform: translate(-50%, -50%) scale(1);
            }
        }

        /* Drag hint */
        .drag-hint {
            position: absolute;
            bottom: 5px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 0.5rem;
            color: rgba(255,255,255,0.3);
            pointer-events: none;
        }

        /* Distance indicator */
        .distance-indicator {
            position: absolute;
            font-size: 0.55rem;
            color: rgba(255,255,255,0.4);
            background: rgba(0,0,0,0.5);
            padding: 2px 6px;
            border-radius: 4px;
        }

        /* Legend */
        .positioning-legend {
            display: flex;
            justify-content: center;
            flex-wrap: wrap;
            gap: 0.75rem;
            margin-top: 0.75rem;
            font-size: 0.65rem;
            padding: 0.5rem;
            background: rgba(0,0,0,0.3);
            border-radius: 6px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 0.35rem;
            color: var(--text-muted);
        }

        .legend-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
        }

        .legend-dot.subject {
            background: var(--error);
        }

        .legend-dot.officer {
            background: var(--success);
        }

        .legend-dot.patrol {
            background: var(--tactical-blue);
        }

        .legend-dot.vehicle {
            background: #666;
        }

        /* Current Action Display */
        .current-action {
            margin-top: 0.75rem;
            padding: 0.6rem;
            background: rgba(251, 191, 36, 0.1);
            border-radius: 6px;
            border-left: 3px solid var(--accent-gold);
        }

        .current-action-label {
            font-size: 0.6rem;
            font-weight: 600;
            color: var(--accent-gold);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 0.3rem;
        }

        .current-action-text {
            font-size: 0.75rem;
            color: var(--text-primary);
            font-style: italic;
            line-height: 1.4;
            min-height: 1.2em;
        }

        .current-action-text.action-update {
            animation: actionFlash 0.5s ease-out;
        }

        @keyframes actionFlash {
            0% { background: rgba(251, 191, 36, 0.3); }
            100% { background: transparent; }
        }

        /* Position info panel */
        .position-info {
            margin-top: 0.75rem;
            padding: 0.6rem;
            background: rgba(0,0,0,0.3);
            border-radius: 6px;
            border-left: 3px solid var(--success);
        }

        .position-info-title {
            font-size: 0.7rem;
            font-weight: 600;
            color: var(--success);
            margin-bottom: 0.35rem;
        }

        .position-info-detail {
            font-size: 0.65rem;
            color: var(--text-secondary);
            line-height: 1.4;
        }

        .position-info-detail span {
            color: var(--text-primary);
            font-weight: 500;
        }

        /* Positioning options */
        .positioning-options {
            margin-top: 0.75rem;
        }

        .position-options-label {
            font-size: 0.7rem;
            color: var(--text-muted);
            margin-bottom: 0.5rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .position-btn-group {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        .position-btn {
            flex: 1;
            min-width: 100px;
            padding: 0.6rem 0.5rem;
            background: var(--navy-light);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            color: var(--text-secondary);
            font-size: 0.7rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
            -webkit-tap-highlight-color: transparent;
        }

        .position-btn:hover {
            border-color: var(--tactical-blue);
            color: var(--text-primary);
            background: var(--navy-mid);
        }

        .position-btn:active {
            transform: scale(0.98);
        }

        .position-btn.selected {
            border-color: var(--success);
            background: rgba(52, 211, 153, 0.15);
            color: var(--success);
            font-weight: 600;
        }

        .position-btn-desc {
            display: block;
            font-size: 0.55rem;
            opacity: 0.7;
            margin-top: 2px;
        }

        /* Loading */
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @keyframes dotPulse {
            0%, 80%, 100% { opacity: 0.3; }
            40% { opacity: 1; }
        }

        .loading-spinner {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .loading-spinner::before {
            content: '';
            width: 16px;
            height: 16px;
            border: 2px solid var(--border-color);
            border-top-color: var(--tactical-blue);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        .loading-dots {
            display: inline-flex;
            gap: 3px;
        }

        .loading-dots span {
            width: 6px;
            height: 6px;
            background: var(--tactical-blue);
            border-radius: 50%;
            animation: dotPulse 1.4s ease-in-out infinite;
        }

        .loading-dots span:nth-child(1) { animation-delay: 0s; }
        .loading-dots span:nth-child(2) { animation-delay: 0.2s; }
        .loading-dots span:nth-child(3) { animation-delay: 0.4s; }

        /* Report Section */
        .report-section {
            display: none;
            padding: 1rem 0;
        }

        .report-section.active {
            display: block;
        }

        .report-header {
            text-align: center;
            margin-bottom: 1.5rem;
        }

        .report-header h2 {
            font-family: 'Barlow Condensed', sans-serif;
            font-size: 1.5rem;
            margin-bottom: 0.5rem;
        }

        .report-header p {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .report-form {
            background: var(--navy-mid);
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
        }

        .report-layout {
            display: flex;
            gap: 1rem;
        }

        .report-sidebar {
            width: 200px;
            flex-shrink: 0;
            background: var(--navy-mid);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 1rem;
            position: sticky;
            top: 1rem;
            height: fit-content;
            max-height: calc(100vh - 200px);
            overflow-y: auto;
        }

        .sidebar-title {
            font-weight: 600;
            font-size: 0.9rem;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid var(--border-color);
        }

        .sidebar-section {
            margin-bottom: 1rem;
        }

        .sidebar-label {
            font-size: 0.7rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--accent-gold);
            margin-bottom: 0.35rem;
        }

        .sidebar-section ul {
            margin: 0;
            padding: 0 0 0 1rem;
            font-size: 0.75rem;
            color: var(--text-muted);
            line-height: 1.6;
        }

        .sidebar-section li {
            margin-bottom: 0.15rem;
        }

        .report-main {
            flex: 1;
            min-width: 0;
        }

        .report-box {
            background: var(--navy-mid);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            margin-bottom: 1rem;
            overflow: hidden;
        }

        .report-box-header {
            padding: 0.75rem 1rem;
            background: rgba(201, 162, 39, 0.1);
            border-bottom: 1px solid var(--border-color);
            font-weight: 700;
            font-size: 0.9rem;
            letter-spacing: 0.05em;
            color: var(--accent-gold);
        }

        .report-textarea {
            width: 100%;
            min-height: 100px;
            padding: 1rem;
            background: transparent;
            border: none;
            color: var(--text-primary);
            font-family: 'Source Sans 3', sans-serif;
            font-size: 0.95rem;
            line-height: 1.6;
            resize: vertical;
        }

        .report-textarea-large {
            min-height: 250px;
        }

        .report-textarea:focus {
            outline: none;
            background: rgba(46, 90, 140, 0.1);
        }

        @media (max-width: 768px) {
            .report-layout {
                flex-direction: column;
            }

            .report-sidebar {
                width: 100%;
                position: static;
                max-height: none;
                display: grid;
                grid-template-columns: repeat(2, 1fr);
                gap: 0.5rem;
            }

            .sidebar-title {
                grid-column: 1 / -1;
            }

            .sidebar-section {
                margin-bottom: 0.5rem;
            }

            .report-textarea-large {
                min-height: 200px;
            }
        }

        @media (max-width: 480px) {
            .report-sidebar {
                grid-template-columns: 1fr;
            }
        }

        .report-row {
            display: flex;
            gap: 0.75rem;
            margin-bottom: 0.75rem;
            flex-wrap: wrap;
        }

        .report-field {
            flex: 1;
            min-width: 120px;
        }

        .report-field.full-width {
            flex: 100%;
            min-width: 100%;
        }

        .report-field label {
            display: block;
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-muted);
            margin-bottom: 0.35rem;
        }

        .report-field input,
        .report-field select,
        .report-field textarea {
            width: 100%;
            padding: 0.6rem;
            background: var(--navy-deep);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            color: var(--text-primary);
            font-size: 0.9rem;
            font-family: inherit;
        }

        .report-field textarea {
            min-height: 100px;
            resize: vertical;
        }

        .report-field input:focus,
        .report-field select:focus,
        .report-field textarea:focus {
            outline: none;
            border-color: var(--tactical-blue);
        }

        .report-field input::placeholder,
        .report-field textarea::placeholder {
            color: var(--text-muted);
        }

        .report-checkbox-group {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        .report-checkbox-group label {
            display: flex;
            align-items: center;
            gap: 0.35rem;
            font-size: 0.85rem;
            color: var(--text-secondary);
            cursor: pointer;
            text-transform: none;
            letter-spacing: normal;
        }

        .report-checkbox-group input[type="checkbox"],
        .report-checkbox-group input[type="radio"] {
            width: auto;
            accent-color: var(--accent-gold);
        }

        .report-btn-row {
            display: flex;
            gap: 0.75rem;
            margin-top: 1rem;
        }

        .skip-report-btn {
            padding: 1rem 1.5rem;
            background: transparent;
            color: var(--text-secondary);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-size: 0.95rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .skip-report-btn:hover {
            border-color: var(--error);
            color: var(--error);
        }

        .submit-report-btn {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            padding: 1rem;
            background: linear-gradient(135deg, var(--accent-gold) 0%, var(--accent-gold-bright) 100%);
            color: var(--navy-deep);
            border: none;
            border-radius: 8px;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .submit-report-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(201, 162, 39, 0.3);
        }

        .submit-report-btn svg {
            width: 20px;
            height: 20px;
            fill: currentColor;
        }

        /* FI Card Tab */
        .fi-card-tab {
            position: fixed;
            right: 0;
            top: 50%;
            transform: translateY(-50%);
            background: linear-gradient(135deg, var(--tactical-blue), var(--navy-light));
            color: white;
            padding: 1rem 0.6rem;
            border-radius: 8px 0 0 8px;
            cursor: pointer;
            writing-mode: vertical-rl;
            text-orientation: mixed;
            font-weight: 700;
            font-size: 0.9rem;
            letter-spacing: 0.1em;
            z-index: 1000;
            transition: all 0.2s;
            border: 2px solid var(--accent-gold);
            border-right: none;
            display: none;
            box-shadow: -4px 0 15px rgba(0, 0, 0, 0.4);
        }

        .fi-card-tab::before {
            content: 'ðŸ“‹';
            writing-mode: horizontal-tb;
            display: block;
            margin-bottom: 0.5rem;
            font-size: 1rem;
        }

        .fi-card-tab:hover {
            background: var(--accent-gold);
            color: var(--navy-deep);
            padding-right: 0.8rem;
        }

        .fi-card-tab.active {
            background: var(--accent-gold);
            color: var(--navy-deep);
        }

        /* FI Card Panel */
        .fi-card-panel {
            position: fixed;
            right: -400px;
            top: 0;
            bottom: 0;
            width: 380px;
            max-width: 90vw;
            background: var(--navy-mid);
            border-left: 1px solid var(--border-color);
            z-index: 99;
            transition: right 0.3s ease;
            overflow-y: auto;
            padding: 1rem;
            box-shadow: -4px 0 20px rgba(0, 0, 0, 0.3);
        }

        .fi-card-panel.open {
            right: 0;
        }

        .fi-card-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 1rem;
            padding-bottom: 0.75rem;
            border-bottom: 1px solid var(--border-color);
        }

        .fi-card-header h3 {
            font-family: 'Barlow Condensed', sans-serif;
            font-size: 1.2rem;
            color: var(--accent-gold);
        }

        .fi-card-close {
            background: transparent;
            border: 1px solid var(--border-color);
            color: var(--text-secondary);
            width: 32px;
            height: 32px;
            border-radius: 6px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .fi-card-close:hover {
            border-color: var(--error);
            color: var(--error);
        }

        .fi-card-close svg {
            width: 18px;
            height: 18px;
            stroke: currentColor;
            fill: none;
        }

        .fi-field {
            margin-bottom: 0.75rem;
        }

        .fi-field label {
            display: block;
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-muted);
            margin-bottom: 0.25rem;
        }

        .fi-field input,
        .fi-field textarea,
        .fi-field select {
            width: 100%;
            padding: 0.5rem;
            background: var(--navy-deep);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            color: var(--text-primary);
            font-size: 0.85rem;
            font-family: inherit;
        }

        .fi-field input:focus,
        .fi-field textarea:focus,
        .fi-field select:focus {
            outline: none;
            border-color: var(--tactical-blue);
        }

        .fi-field textarea {
            min-height: 60px;
            resize: vertical;
        }

        .fi-row {
            display: flex;
            gap: 0.5rem;
        }

        .fi-row .fi-field {
            flex: 1;
        }

        .fi-section-label {
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--accent-gold);
            margin: 1rem 0 0.5rem;
            padding-top: 0.75rem;
            border-top: 1px solid var(--border-color);
        }

        .fi-section-label:first-of-type {
            margin-top: 0;
            padding-top: 0;
            border-top: none;
        }

        /* Debrief Section */
        .debrief-section {
            display: none;
            padding: 1rem 0;
        }

        .debrief-section.active {
            display: block;
        }

        .debrief-header {
            text-align: center;
            margin-bottom: 1.5rem;
        }

        .debrief-header h2 {
            font-family: 'Barlow Condensed', sans-serif;
            font-size: 1.5rem;
            margin-bottom: 1rem;
        }

        .debrief-overall-score {
            display: flex;
            align-items: baseline;
            justify-content: center;
            gap: 0.25rem;
            padding: 1.5rem;
            background: var(--navy-mid);
            border-radius: 12px;
            border: 2px solid var(--accent-gold);
        }

        .overall-score-label {
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            color: var(--text-muted);
            margin-right: 0.5rem;
        }

        .overall-score-value {
            font-family: 'Barlow Condensed', sans-serif;
            font-size: 3.5rem;
            font-weight: 700;
            color: var(--accent-gold);
            line-height: 1;
            transition: color 0.3s;
        }

        .overall-score-value.score-low {
            color: var(--error);
        }

        .overall-score-value.score-mid {
            color: var(--warning);
        }

        .overall-score-value.score-high {
            color: var(--success);
        }

        .overall-score-max {
            font-size: 1.5rem;
            color: var(--text-muted);
        }

        .debrief-overall-score.score-low {
            border-color: var(--error);
        }

        .debrief-overall-score.score-mid {
            border-color: var(--warning);
        }

        .debrief-overall-score.score-high {
            border-color: var(--success);
        }

        .category-score.score-low {
            background: rgba(248, 113, 113, 0.15);
            color: var(--error);
        }

        .category-score.score-mid {
            background: rgba(251, 191, 36, 0.15);
            color: var(--warning);
        }

        .category-score.score-high {
            background: rgba(52, 211, 153, 0.15);
            color: var(--success);
        }

        .debrief-category {
            background: var(--navy-mid);
            border-radius: 12px;
            padding: 1.25rem;
            margin-bottom: 1rem;
            border: 1px solid var(--border-color);
        }

        .debrief-category-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 1rem;
            padding-bottom: 0.75rem;
            border-bottom: 1px solid var(--border-color);
        }

        .debrief-category-header h3 {
            font-family: 'Barlow Condensed', sans-serif;
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--text-primary);
            margin: 0;
        }

        .category-score {
            background: rgba(201, 162, 39, 0.15);
            color: var(--accent-gold);
            padding: 0.35rem 0.75rem;
            border-radius: 100px;
            font-size: 0.85rem;
            font-weight: 600;
        }

        .debrief-section-block {
            background: rgba(10, 22, 40, 0.5);
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 0.75rem;
        }

        .debrief-section-block:last-child {
            margin-bottom: 0;
        }

        .debrief-section-block h4 {
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 0.5rem;
            color: var(--text-muted);
        }

        .debrief-section-block p {
            font-size: 0.9rem;
            line-height: 1.6;
            color: var(--text-secondary);
        }

        .debrief-recommendations {
            background: var(--navy-mid);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 1.25rem;
        }

        .debrief-recommendations h3 {
            font-family: 'Barlow Condensed', sans-serif;
            font-size: 1.1rem;
            margin-bottom: 0.75rem;
            color: var(--accent-gold);
        }

        .debrief-item {
            display: flex;
            gap: 0.75rem;
            padding: 0.5rem 0;
            border-bottom: 1px solid rgba(168, 184, 200, 0.1);
        }

        .debrief-item:last-child {
            border-bottom: none;
            padding-bottom: 0;
        }

        .debrief-status {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            font-weight: bold;
            flex-shrink: 0;
        }

        .debrief-status.status-correct {
            background: rgba(52, 211, 153, 0.15);
            color: var(--success);
        }

        .debrief-status.status-needs_improvement {
            background: rgba(251, 191, 36, 0.15);
            color: var(--warning);
        }

        .debrief-status.status-incorrect {
            background: rgba(248, 113, 113, 0.15);
            color: var(--error);
        }

        .debrief-item p {
            font-size: 0.85rem;
            line-height: 1.5;
            color: var(--text-secondary);
        }

        .debrief-item p strong {
            color: var(--text-primary);
        }

        .debrief-section-block ul {
            margin: 0;
            padding: 0 0 0 1.25rem;
            color: var(--text-secondary);
        }

        .debrief-section-block ul li {
            margin-bottom: 0.35rem;
            line-height: 1.5;
            font-size: 0.9rem;
        }

        .empty-state {
            text-align: center;
            padding: 1.5rem 1rem;
            color: var(--text-muted);
            font-style: italic;
            font-size: 0.9rem;
        }

        .empty-state-icon {
            font-size: 2rem;
            margin-bottom: 0.5rem;
            opacity: 0.5;
        }

        .debrief-cta-btn {
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            padding: 1rem;
            background: var(--accent-gold);
            color: var(--navy-deep);
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            margin-top: 1rem;
        }

        /* Desktop styles */
        @media (min-width: 768px) {
            .demo-container {
                max-width: 900px;
                margin: 0 auto;
                padding: 2rem;
            }

            .scenario-grid {
                grid-template-columns: repeat(3, 1fr);
            }

            .message {
                max-width: 75%;
            }
        }

        @media (min-width: 1024px) {
            .scenario-grid {
                grid-template-columns: repeat(4, 1fr);
            }
        }

        /* Mobile-specific styles for touch interaction */
        @media (max-width: 767px) {
            /* Larger touch targets for markers */
            .position-marker {
                width: 44px;
                height: 44px;
                font-size: 1.2rem;
                min-width: 44px;
                min-height: 44px;
            }

            .position-marker.subject,
            .position-marker.officer {
                width: 44px;
                height: 44px;
            }

            .position-marker.subject.in-vehicle {
                width: 36px;
                height: 36px;
            }

            /* Officer action menu mobile styling */
            .officer-action-menu {
                min-width: 260px;
                max-width: calc(100vw - 20px);
                padding: 10px;
            }

            .officer-action-menu textarea {
                font-size: 16px !important; /* Prevents zoom on iOS */
            }

            .officer-weapon-btns {
                gap: 8px;
            }

            .officer-weapon-btn {
                padding: 10px 8px;
                min-height: 44px;
            }

            .officer-menu-send {
                min-height: 44px;
                font-size: 1rem;
            }

            /* Backup action menu mobile styling */
            .backup-action-menu {
                min-width: 220px;
                max-width: calc(100vw - 20px);
            }

            .backup-weapon-grid {
                gap: 8px;
            }

            .backup-weapon-grid .officer-weapon-btn {
                min-height: 50px;
                padding: 8px;
            }

            /* Force options menu mobile */
            .force-options-menu {
                min-width: 140px;
            }

            .force-option {
                min-height: 44px;
                padding: 10px 12px;
            }

            /* Chat input area */
            .input-area {
                padding: 0.5rem;
            }

            .input-row {
                gap: 0.5rem;
            }

            .input-row input,
            .input-row textarea {
                font-size: 16px !important; /* Prevents zoom on iOS */
                padding: 10px;
            }

            #send-btn {
                min-width: 50px;
                min-height: 44px;
            }

            /* Scene container mobile */
            .position-scene {
                min-height: 180px;
            }

            /* Dispatcher bubble mobile */
            .dispatcher-bubble {
                max-width: 140px;
                font-size: 0.7rem;
            }

            /* Speech bubbles mobile */
            .speech-bubble {
                max-width: 220px;
                max-height: 100px;
                font-size: 0.7rem;
                padding: 6px 10px;
            }

            /* Patrol car smaller on mobile */
            .patrol-car {
                transform: scale(0.8);
                transform-origin: bottom left;
            }

            .backup-car {
                transform: scale(0.8);
                transform-origin: bottom right;
            }
        }

        /* Prevent text selection during drag on touch */
        .position-marker,
        .patrol-car,
        .backup-car {
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
            -webkit-touch-callout: none;
            touch-action: none;
        }

        /* ========== STICK FIGURE CHARACTERS ========== */
        .stick-figure {
            position: absolute;
            width: 60px;
            height: 90px;
            cursor: pointer;
            transition: transform 0.2s, filter 0.2s;
            z-index: 20;
        }

        .stick-figure:hover {
            transform: scale(1.1);
            filter: drop-shadow(0 0 12px rgba(255,255,255,0.5));
        }

        .stick-figure.subject1 {
            filter: drop-shadow(0 0 6px rgba(248, 113, 113, 0.7));
        }

        .stick-figure.subject2 {
            filter: drop-shadow(0 0 6px rgba(251, 146, 60, 0.7));
        }

        .stick-figure.subject1:hover {
            filter: drop-shadow(0 0 14px rgba(248, 113, 113, 0.9));
        }

        .stick-figure.subject2:hover {
            filter: drop-shadow(0 0 14px rgba(251, 146, 60, 0.9));
        }

        /* Skin tone colors */
        .stick-figure .skin { fill: #FFDCB5; } /* Default light */
        .stick-figure.skin-light .skin { fill: #FFDCB5; }
        .stick-figure.skin-medium .skin { fill: #D4A574; }
        .stick-figure.skin-tan .skin { fill: #C4956A; }
        .stick-figure.skin-brown .skin { fill: #8D5524; }
        .stick-figure.skin-dark .skin { fill: #5C3A21; }

        /* Hair colors */
        .stick-figure .hair { fill: #4A3728; } /* Default brown */
        .stick-figure.hair-black .hair { fill: #1A1A1A; }
        .stick-figure.hair-brown .hair { fill: #4A3728; }
        .stick-figure.hair-blonde .hair { fill: #D4A857; }
        .stick-figure.hair-red .hair { fill: #8B3A3A; }
        .stick-figure.hair-gray .hair { fill: #888888; }
        .stick-figure.hair-bald .hair { fill: transparent; }

        /* Clothing base */
        .stick-figure .shirt { fill: #3B82F6; }
        .stick-figure .pants { fill: #1E3A5F; }
        .stick-figure .outline { stroke: #333; stroke-width: 1; fill: none; }

        /* Character type clothing */
        .stick-figure.type-business .shirt { fill: #FFFFFF; }
        .stick-figure.type-business .pants { fill: #2D3748; }
        .stick-figure.type-business .tie { fill: #C53030; display: block; }

        .stick-figure.type-casual .shirt { fill: #48BB78; }
        .stick-figure.type-casual .pants { fill: #4A5568; }

        .stick-figure.type-worker .shirt { fill: #ED8936; }
        .stick-figure.type-worker .pants { fill: #2D3748; }

        .stick-figure.type-hoodie .shirt { fill: #718096; }
        .stick-figure.type-hoodie .pants { fill: #1A202C; }

        .stick-figure.type-elderly .shirt { fill: #E2E8F0; }
        .stick-figure.type-elderly .pants { fill: #4A5568; }

        .stick-figure.type-athletic .shirt { fill: #E53E3E; }
        .stick-figure.type-athletic .pants { fill: #1A202C; }

        .stick-figure.type-formal .shirt { fill: #2B6CB0; }
        .stick-figure.type-formal .pants { fill: #1A202C; }

        /* Small label under figure */
        .stick-figure-label {
            position: absolute;
            bottom: -14px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 0.5rem;
            font-weight: 700;
            letter-spacing: 0.5px;
            white-space: nowrap;
            padding: 1px 4px;
            border-radius: 3px;
            background: rgba(0,0,0,0.5);
        }

        .stick-figure.subject1 .stick-figure-label {
            color: #F87171;
        }

        .stick-figure.subject2 .stick-figure-label {
            color: #fb923c;
        }

        /* In-vehicle - figure sitting in driver seat */
        .stick-figure.in-vehicle {
            width: 38px;
            height: 55px;
            z-index: 26;
        }

        .stick-figure.in-vehicle .stick-figure-label {
            display: none;
        }

        @media (max-width: 600px) {
            .stick-figure {
                width: 48px;
                height: 72px;
            }

            .stick-figure.in-vehicle {
                width: 32px;
                height: 46px;
            }

            .stick-figure-label {
                font-size: 0.5rem;
                bottom: -14px;
            }
        }
    </style>
</head>
<body>
    <div class="demo-container">
        <!-- Header -->
        <div class="demo-header">
            <button class="back-btn" id="back-btn">
                <svg viewBox="0 0 24 24" stroke-width="2">
                    <path d="M19 12H5M12 19l-7-7 7-7"/>
                </svg>
                Back
            </button>
            <div class="logo">
                <div class="logo-icon">
                    <svg viewBox="0 0 24 24"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>
                </div>
                <span class="logo-text">BLUE<span>SHIELD</span></span>
            </div>
        </div>

        <!-- Progress Indicator -->
        <div class="progress-indicator">
            <div class="progress-step active" id="step-select">
                <span class="progress-step-number">1</span>
                <span>Select</span>
            </div>
            <div class="progress-connector" id="connector-1"></div>
            <div class="progress-step" id="step-train">
                <span class="progress-step-number">2</span>
                <span>Train</span>
            </div>
            <div class="progress-connector" id="connector-2"></div>
            <div class="progress-step" id="step-report">
                <span class="progress-step-number">3</span>
                <span>Report</span>
            </div>
            <div class="progress-connector" id="connector-3"></div>
            <div class="progress-step" id="step-debrief">
                <span class="progress-step-number">4</span>
                <span>Debrief</span>
            </div>
        </div>

        <!-- Main Content -->
        <div class="demo-content">
            <!-- Scenario Selection -->
            <div class="scenario-select" id="scenario-select-section">
                <div class="scenario-select-header">
                    <h2>Select Training Scenario</h2>
                    <p>Choose a scenario and difficulty level to begin</p>
                </div>

                <div class="select-section">
                    <span class="select-label">Scenario Type</span>
                    <div class="scenario-grid" id="scenario-grid"></div>
                </div>

                <div class="select-section">
                    <span class="select-label">Difficulty Level</span>
                    <div class="difficulty-grid" id="difficulty-grid"></div>
                </div>

                <div class="start-btn-container">
                    <button class="start-scenario-btn" id="start-scenario-btn">
                        <svg viewBox="0 0 24 24"><polygon points="5,3 19,12 5,21"/></svg>
                        Start Scenario
                    </button>
                </div>
            </div>

            <!-- Scene-Centric Chat Section -->
            <div class="demo-chat" id="demo-chat-section">
                <!-- Compact header -->
                <div class="chat-header">
                    <div class="chat-scenario">
                        <div class="scenario-icon">
                            <svg viewBox="0 0 24 24" stroke-width="2">
                                <circle cx="12" cy="12" r="10"/>
                                <path d="M12 6v6l4 2"/>
                            </svg>
                        </div>
                        <div class="scenario-info">
                            <h3 id="chat-scenario-title">Traffic Stop - DUI</h3>
                            <span id="chat-scenario-location">State Route 87, 11:42 PM</span>
                        </div>
                    </div>
                    <span class="mode-badge">Training Mode</span>
                </div>

                <!-- Compact subject/observation row -->
                <div class="subject-obs-row">
                    <div class="subject-panel-compact">
                        <div class="subject-portrait mood-nervous" id="subject-portrait">
                            <span id="portrait-face">ðŸ˜°</span>
                        </div>
                        <div class="subject-info">
                            <div class="subject-name">Unknown Male</div>
                            <div class="subject-mood mood-nervous" id="subject-mood-badge">
                                <span class="mood-dot"></span>
                                <span id="mood-text">Nervous</span>
                            </div>
                            <div class="subject-action" id="subject-action">Gripping steering wheel tightly</div>
                        </div>
                    </div>
                    <div class="observation-panel-compact">
                        <div class="observation-header">
                            <svg viewBox="0 0 24 24" stroke-width="2">
                                <circle cx="12" cy="12" r="3"/>
                                <path d="M12 1v6m0 6v10M1 12h6m6 0h10"/>
                            </svg>
                            <span>Observations</span>
                        </div>
                        <div class="observation-list" id="observation-list"></div>
                    </div>
                </div>

                <!-- MAIN SCENE AREA - Central focus -->
                <div class="scene-area">
                    <div class="scene-main">
                        <div class="scene-diagram-wrapper">
                            <div class="position-scene" id="position-scene">
                                <!-- Scene populated dynamically based on scenario -->
                                <!-- Speech bubbles will be added here -->
                                <div class="speech-bubble subject-bubble" id="subject-speech" style="display: none;">
                                    <div class="bubble-label">Subject</div>
                                    <div class="bubble-text" id="subject-speech-text"></div>
                                </div>
                                <div class="speech-bubble officer-bubble" id="officer-speech" style="display: none;">
                                    <div class="bubble-label">You</div>
                                    <div class="bubble-text" id="officer-speech-text"></div>
                                </div>
                            </div>
                        </div>

                        <!-- Position controls -->
                        <div class="scene-controls" id="scene-controls">
                            <button class="position-btn" data-pos="driver-rear">Driver Rear</button>
                            <button class="position-btn selected" data-pos="passenger-rear">Pass. Rear</button>
                            <button class="position-btn" data-pos="cover">Cover</button>
                            <button class="position-btn" data-pos="contact">Contact</button>
                        </div>

                        <!-- Info row -->
                        <div class="scene-info-row">
                            <div class="scene-info-box current-action-box">
                                <div class="scene-info-label">Current Action</div>
                                <div class="scene-info-text" id="current-action-text">Standing by at patrol vehicle</div>
                            </div>
                            <div class="scene-info-box position-info-box">
                                <div class="scene-info-label" id="position-info-title">Passenger Rear</div>
                                <div class="scene-info-text" id="position-info-detail">~15 ft from subject</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Hidden messages container for history -->
                <div class="chat-messages" id="demo-messages" style="display: none;"></div>

                <!-- Hidden inputs (populated from popups) -->
                <input type="hidden" id="input-say">
                <input type="hidden" id="input-radio">
                <input type="hidden" id="input-do">

                <!-- Minimal bottom bar -->
                <div class="chat-input" style="padding: 0.4rem 0; display: flex; justify-content: space-between; align-items: center;">
                    <div class="timer-display" id="timer-display" style="position: static; margin: 0;">0.0s</div>
                    <div style="display: flex; gap: 0.5rem;">
                        <button class="send-btn" id="send-btn" style="display: none;">Send</button>
                        <button class="end-scenario-btn" id="end-scenario-btn">
                            <svg viewBox="0 0 24 24" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2"/></svg>
                            End Scenario
                        </button>
                    </div>
                </div>
            </div>

            <!-- Report Section -->
            <div class="report-section" id="report-section">
                <div class="report-header">
                    <h2>Write Your Report</h2>
                    <p id="report-scenario-info"></p>
                </div>

                <div class="report-layout">
                    <!-- Sidebar with Tips -->
                    <div class="report-sidebar">
                        <div class="sidebar-title">ðŸ“‹ Checklist</div>

                        <div class="sidebar-section">
                            <div class="sidebar-label">SYNOPSIS</div>
                            <ul>
                                <li>Who</li>
                                <li>What</li>
                                <li>When</li>
                                <li>Where</li>
                                <li>How</li>
                            </ul>
                        </div>

                        <div class="sidebar-section">
                            <div class="sidebar-label">CALL DETAILS</div>
                            <ul>
                                <li>Date/time of response</li>
                                <li>Call type</li>
                                <li>Exact location</li>
                                <li>Time of arrival</li>
                            </ul>
                        </div>

                        <div class="sidebar-section">
                            <div class="sidebar-label">NARRATIVE</div>
                            <ul>
                                <li>Chronological order</li>
                                <li>Grammar & spelling</li>
                                <li>Arrival observations</li>
                                <li>Time of incident</li>
                                <li>Details of injury</li>
                                <li>Video/photo evidence</li>
                                <li>Evidence collection</li>
                                <li>Interview: victim</li>
                                <li>Interview: witness</li>
                                <li>Interview: suspect</li>
                                <li>Miranda warning</li>
                            </ul>
                        </div>

                        <div class="sidebar-section">
                            <div class="sidebar-label">CONCLUSION</div>
                            <ul>
                                <li>Case status</li>
                                <li>Statement to prosecution</li>
                                <li>Victims' Rights</li>
                            </ul>
                        </div>
                    </div>

                    <!-- Main Report Area -->
                    <div class="report-main">
                        <div class="report-box">
                            <div class="report-box-header">*** SYNOPSIS ***</div>
                            <textarea id="report-synopsis" class="report-textarea"></textarea>
                        </div>

                        <div class="report-box">
                            <div class="report-box-header">*** CALL DETAILS ***</div>
                            <textarea id="report-call-details" class="report-textarea"></textarea>
                        </div>

                        <div class="report-box">
                            <div class="report-box-header">*** NARRATIVE ***</div>
                            <textarea id="report-narrative" class="report-textarea report-textarea-large"></textarea>
                        </div>

                        <div class="report-box">
                            <div class="report-box-header">*** CONCLUSION ***</div>
                            <textarea id="report-conclusion" class="report-textarea"></textarea>
                        </div>

                        <div class="report-btn-row">
                            <button class="skip-report-btn" id="skip-report-btn">
                                Skip Report
                            </button>
                            <button class="submit-report-btn" id="submit-report-btn">
                                <svg viewBox="0 0 24 24"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg>
                                Submit Report & Get Debrief
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- FI Card Tab -->
            <div class="fi-card-tab" id="fi-card-tab">FI CARD</div>

            <!-- FI Card Panel -->
            <div class="fi-card-panel" id="fi-card-panel">
                <div class="fi-card-header">
                    <h3>Field Interview Card</h3>
                    <button class="fi-card-close" id="fi-card-close">
                        <svg viewBox="0 0 24 24" stroke-width="2"><path d="M18 6L6 18M6 6l12 12"/></svg>
                    </button>
                </div>

                <div class="fi-section-label">Subject Information</div>
                <div class="fi-row">
                    <div class="fi-field">
                        <label>Last Name</label>
                        <input type="text" id="fi-last-name">
                    </div>
                    <div class="fi-field">
                        <label>First Name</label>
                        <input type="text" id="fi-first-name">
                    </div>
                    <div class="fi-field">
                        <label>MI</label>
                        <input type="text" id="fi-mi" style="max-width: 50px;">
                    </div>
                </div>

                <div class="fi-row">
                    <div class="fi-field">
                        <label>DOB</label>
                        <input type="text" id="fi-dob" placeholder="MM/DD/YYYY">
                    </div>
                    <div class="fi-field">
                        <label>Sex</label>
                        <select id="fi-sex">
                            <option value="">-</option>
                            <option value="M">M</option>
                            <option value="F">F</option>
                        </select>
                    </div>
                    <div class="fi-field">
                        <label>Race</label>
                        <select id="fi-race">
                            <option value="">-</option>
                            <option value="W">W</option>
                            <option value="B">B</option>
                            <option value="H">H</option>
                            <option value="A">A</option>
                            <option value="I">I</option>
                            <option value="O">O</option>
                        </select>
                    </div>
                </div>

                <div class="fi-row">
                    <div class="fi-field">
                        <label>Height</label>
                        <input type="text" id="fi-height" placeholder="5'10&quot;">
                    </div>
                    <div class="fi-field">
                        <label>Weight</label>
                        <input type="text" id="fi-weight" placeholder="180">
                    </div>
                    <div class="fi-field">
                        <label>Hair</label>
                        <input type="text" id="fi-hair" placeholder="BRO">
                    </div>
                    <div class="fi-field">
                        <label>Eyes</label>
                        <input type="text" id="fi-eyes" placeholder="BRO">
                    </div>
                </div>

                <div class="fi-field">
                    <label>Address</label>
                    <input type="text" id="fi-address">
                </div>

                <div class="fi-row">
                    <div class="fi-field">
                        <label>City</label>
                        <input type="text" id="fi-city">
                    </div>
                    <div class="fi-field">
                        <label>State</label>
                        <input type="text" id="fi-state" value="AZ" style="max-width: 60px;">
                    </div>
                    <div class="fi-field">
                        <label>Zip</label>
                        <input type="text" id="fi-zip">
                    </div>
                </div>

                <div class="fi-section-label">ID / Vehicle</div>
                <div class="fi-row">
                    <div class="fi-field">
                        <label>DL #</label>
                        <input type="text" id="fi-dl">
                    </div>
                    <div class="fi-field">
                        <label>DL State</label>
                        <input type="text" id="fi-dl-state" value="AZ" style="max-width: 60px;">
                    </div>
                </div>

                <div class="fi-row">
                    <div class="fi-field">
                        <label>Vehicle</label>
                        <input type="text" id="fi-vehicle" placeholder="Year/Make/Model">
                    </div>
                    <div class="fi-field">
                        <label>Color</label>
                        <input type="text" id="fi-vehicle-color">
                    </div>
                </div>

                <div class="fi-row">
                    <div class="fi-field">
                        <label>License Plate</label>
                        <input type="text" id="fi-plate">
                    </div>
                    <div class="fi-field">
                        <label>Plate State</label>
                        <input type="text" id="fi-plate-state" value="AZ" style="max-width: 60px;">
                    </div>
                </div>

                <div class="fi-section-label">Contact Details</div>
                <div class="fi-row">
                    <div class="fi-field">
                        <label>Location</label>
                        <input type="text" id="fi-location">
                    </div>
                    <div class="fi-field">
                        <label>Date/Time</label>
                        <input type="text" id="fi-datetime">
                    </div>
                </div>

                <div class="fi-field">
                    <label>Reason for Contact</label>
                    <textarea id="fi-reason"></textarea>
                </div>

                <div class="fi-field">
                    <label>Marks / Tattoos / Scars</label>
                    <textarea id="fi-marks"></textarea>
                </div>

                <div class="fi-field">
                    <label>Associates / Additional Info</label>
                    <textarea id="fi-notes"></textarea>
                </div>
            </div>

            <!-- Debrief Section -->
            <div class="debrief-section" id="debrief-section">
                <!-- Overall Score Header -->
                <div class="debrief-header">
                    <h2>Performance Debrief</h2>
                    <div class="debrief-overall-score">
                        <div class="overall-score-label">OVERALL SCORE</div>
                        <div class="overall-score-value" id="debrief-overall-score">0</div>
                        <div class="overall-score-max">/100</div>
                    </div>
                </div>

                <!-- Scenario Review Section -->
                <div class="debrief-category">
                    <div class="debrief-category-header">
                        <h3>Scenario Performance</h3>
                        <div class="category-score" id="scenario-score-badge">0/100</div>
                    </div>

                    <div class="debrief-section-block">
                        <h4>Summary</h4>
                        <p id="scenario-summary-text"></p>
                    </div>

                    <div class="debrief-section-block" id="scenario-analysis">
                        <h4>Analysis</h4>
                    </div>

                    <div class="debrief-section-block">
                        <h4>Strengths</h4>
                        <ul id="scenario-strengths-list"></ul>
                    </div>

                    <div class="debrief-section-block">
                        <h4>Areas for Improvement</h4>
                        <ul id="scenario-improvements-list"></ul>
                    </div>
                </div>

                <!-- Report Review Section -->
                <div class="debrief-category">
                    <div class="debrief-category-header">
                        <h3>Report Writing</h3>
                        <div class="category-score" id="report-score-badge">0/100</div>
                    </div>

                    <div class="debrief-section-block">
                        <h4>Summary</h4>
                        <p id="report-summary-text"></p>
                    </div>

                    <div class="debrief-section-block" id="report-analysis">
                        <h4>Analysis</h4>
                    </div>
                </div>

                <!-- Recommendations -->
                <div class="debrief-section-block debrief-recommendations">
                    <h3>Recommendations</h3>
                    <p id="debrief-rec-text"></p>
                </div>

                <button class="debrief-cta-btn" id="debrief-restart-btn">Try Another Scenario</button>
            </div>
        </div>
    </div>

    <script>
        (function() {
            'use strict';

            var API_URL = 'https://us-central1-blueshield-ai.cloudfunctions.net/blueshield-chat';

            var selectedScenario = 'dui';
            var selectedDifficulty = 'easy';
            var messages = [];
            var isLoading = false;
            var timerInterval = null;
            var timerStart = 0;

            var SCENARIOS = {
                random: { title: 'Unknown Scenario', location: 'Dispatched Location', icon: 'ðŸŽ²', intro: 'Respond to the call. Details will be revealed upon arrival.', observations: ['Awaiting details', 'Stay alert', 'Assess on arrival'] },
                dui: { title: 'Traffic Stop - DUI', location: 'State Route 87, 11:42 PM', icon: 'ðŸš—', intro: 'Vehicle pulled over for weaving between lanes. Driver shows signs of intoxication.', observations: ['Bloodshot eyes', 'Strong odor of alcohol', 'Slurred speech', 'Weaving between lanes'] },
                traffic_warrant: { title: 'Traffic Stop - Warrant', location: 'Main St & 7th Ave, 2:30 PM', icon: 'ðŸš¨', intro: 'Routine traffic stop. Dispatch advises driver has active felony warrant.', observations: ['Expired registration', 'Active warrant on file', 'Driver nervous'] },
                traffic_drugs: { title: 'Traffic Stop - Narcotics', location: 'Interstate 10, 1:15 AM', icon: 'ðŸ’Š', intro: 'Vehicle stopped for equipment violation. Strong odor of marijuana.', observations: ['Marijuana odor', 'Air fresheners visible', 'Nervous behavior'] },
                traffic_suspended: { title: 'Suspended License', location: 'Central Ave, 4:45 PM', icon: 'ðŸªª', intro: 'Vehicle stopped for running red light. Driver unable to produce license.', observations: ['Traffic violation observed', 'No license produced', 'Driver hesitant'] },
                domestic: { title: 'Domestic Violence', location: '1847 W Elm St, 9:15 PM', icon: 'ðŸ ', intro: 'Neighbors called about yelling and breaking glass.', observations: ['Broken glass on porch', 'Yelling from inside', 'Crying heard'] },
                domestic_weapons: { title: 'DV - Weapons Involved', location: '2234 N Desert Dr, 10:30 PM', icon: 'ðŸ”ª', intro: 'Partner threatened with knife. Suspect may still have weapon.', observations: ['Weapon mentioned', 'Victim barricaded', 'Ongoing argument'] },
                assault: { title: 'Assault in Progress', location: 'Circle K Parking Lot, 8:45 PM', icon: 'ðŸ‘Š', intro: 'Two males fighting in parking lot. One appears injured.', observations: ['Physical altercation', 'Visible injuries', 'Crowd present'] },
                threats: { title: 'Threatening/Intimidation', location: 'Sunrise Apartments #204, 6:30 PM', icon: 'âš ï¸', intro: 'Resident reports neighbor threatened to harm them.', observations: ['Verbal threats made', 'Prior disputes', 'Witnesses available'] },
                shoplifting: { title: 'Shoplifting', location: 'Target Store #4521, 3:30 PM', icon: 'ðŸ›’', intro: 'Loss prevention has detained suspect who concealed merchandise.', observations: ['Concealed merchandise', 'Subject detained by LP', 'Store video available'] },
                burglary: { title: 'Burglary in Progress', location: '445 E Commerce St, 3:15 AM', icon: 'ðŸšï¸', intro: 'Silent alarm at closed business. Back door forced open.', observations: ['Forced entry signs', 'Alarm triggered', 'Unknown occupancy'] },
                theft: { title: 'Theft Report', location: 'Victim residence, 5:00 PM', icon: 'ðŸ’°', intro: 'Victim reports items stolen from unlocked vehicle overnight.', observations: ['Vehicle entered', 'Items missing', 'Witness available'] },
                vehicle_theft: { title: 'Vehicle Theft', location: 'Industrial Blvd, 11:30 PM', icon: 'ðŸš™', intro: 'Plate reader hit on stolen vehicle. Vehicle occupied.', observations: ['Stolen vehicle confirmed', 'Occupant present', 'No keys visible'] },
                trespass: { title: 'Criminal Trespass', location: 'Abandoned Warehouse, 2:15 AM', icon: 'ðŸš§', intro: 'Individual refusing to leave private property.', observations: ['No Trespassing signs', 'Prior warning given', 'Personal belongings'] },
                disturbance: { title: 'Disorderly Conduct', location: 'Murphys Bar & Grill, 11:50 PM', icon: 'ðŸ—£ï¸', intro: 'Intoxicated male yelling at patrons and knocking over furniture.', observations: ['Strong alcohol odor', 'Overturned furniture', 'Subject yelling'] },
                noise: { title: 'Noise Complaint', location: '892 W University Dr, 1:30 AM', icon: 'ðŸ”Š', intro: 'Multiple calls about loud party. Third complaint tonight.', observations: ['Loud music audible', 'Multiple complaints', 'Large gathering'] },
                loitering: { title: 'Loitering/Panhandling', location: 'QuikTrip #127, 4:00 PM', icon: 'ðŸš¶', intro: 'Aggressive panhandler blocking entrance and harassing customers.', observations: ['Blocking entrance', 'Prior trespass', 'Customers harassed'] },
                civil_property: { title: 'Civil - Property Dispute', location: '1122 & 1124 Oak Lane, 2:00 PM', icon: 'ðŸ“‹', intro: 'Two neighbors arguing over property line/fence.', observations: ['Property line dispute', 'Both parties present', 'Civil matter'] },
                civil_custody: { title: 'Civil - Custody Exchange', location: 'McDonalds Parking Lot, 6:00 PM', icon: 'ðŸ‘¨â€ðŸ‘©â€ðŸ‘§', intro: 'Mother refusing to release child to father for scheduled visitation.', observations: ['Court order present', 'Child present', 'Custody dispute'] },
                civil_landlord: { title: 'Civil - Landlord/Tenant', location: 'Sunset Apartments #15, 10:00 AM', icon: 'ðŸ”‘', intro: 'Tenant reports landlord changed locks while they were at work.', observations: ['Lockout situation', 'Disputed rent status', 'Belongings inside'] },
                civil_repo: { title: 'Civil - Repossession', location: '567 Pine St, 7:00 AM', icon: 'ðŸš›', intro: 'Repo company requesting standby. Owner blocking tow truck.', observations: ['Valid repo order', 'Owner obstructing', 'Civil matter'] },
                civil_business: { title: 'Civil - Business Dispute', location: 'Auto Repair Shop, 3:30 PM', icon: 'ðŸª', intro: 'Customer refusing to pay repair bill. Shop refusing to release vehicle.', observations: ['Payment dispute', 'Vehicle held', 'Civil matter'] },
                mental_crisis: { title: 'Mental Health Crisis', location: 'Bus Stop - Central Station, 4:15 PM', icon: 'ðŸ§ ', intro: 'Subject talking to themselves, appears agitated, scaring passengers.', observations: ['Erratic behavior', 'Talking to self', 'Agitated state'] },
                welfare_check: { title: 'Welfare Check', location: '789 Maple Ave, 11:00 AM', icon: 'â¤ï¸', intro: 'Family requests welfare check. Elderly resident hasnt answered phone in 3 days.', observations: ['No contact 3 days', 'Mail accumulating', 'Vehicle present'] },
                suicide_threat: { title: 'Suicide Threat', location: '456 River Rd, 8:30 PM', icon: 'ðŸ†˜', intro: 'Friend received text messages about suicide. Subject not answering phone.', observations: ['Suicidal statements', 'Not responding', 'Possible weapons'] },
                intoxicated: { title: 'Intoxicated Person', location: 'City Park Bench, 2:45 PM', icon: 'ðŸº', intro: 'Subject passed out on park bench. Not responsive to passersby.', observations: ['Unresponsive', 'Alcohol containers', 'Medical status unknown'] },
                suspicious: { title: 'Suspicious Person', location: 'Residential neighborhood, 10:30 PM', icon: 'ðŸ‘€', intro: 'Male walking through yards, looking into windows.', observations: ['Looking in windows', 'Dark clothing', 'Backpack'] },
                alarm: { title: 'Alarm Response', location: 'First National Bank, 2:30 AM', icon: 'ðŸš¨', intro: 'Silent alarm triggered at bank. All doors appear secure.', observations: ['Silent alarm', 'Doors appear secure', 'Key holder notified'] },
                harassment: { title: 'Harassment', location: 'Victim workplace, 1:00 PM', icon: 'ðŸ“±', intro: 'Ex-partner sending threatening texts and showing up at workplace.', observations: ['Multiple messages', 'Workplace contact', 'Documentation available'] },
                stalking: { title: 'Stalking', location: 'Victim residence, 7:30 PM', icon: 'ðŸ”', intro: 'Victim reports being followed for past two weeks.', observations: ['Pattern of behavior', 'Vehicle identified', 'Documentation provided'] }
            };

            var DIFFICULTY_MODIFIERS = {
                trainee: 'The subject is very cooperative, immediately compliant, and provides clear answers.',
                easy: 'The subject is mostly cooperative but may ask questions or show mild reluctance.',
                medium: 'The subject is evasive, tries to talk their way out, and requires persistence.',
                hard: 'The subject is resistant, argumentative, and challenges your authority.',
                expert: 'The subject is hostile, potentially volatile, and may attempt to flee or fight.'
            };

            var DIFFICULTIES = [
                { id: 'trainee', icon: 'âšª', name: 'Trainee', desc: 'Very cooperative' },
                { id: 'easy', icon: 'ðŸŸ¢', name: 'Rookie', desc: 'Mostly compliant' },
                { id: 'medium', icon: 'ðŸŸ¡', name: 'Standard', desc: 'Evasive' },
                { id: 'hard', icon: 'ðŸŸ ', name: 'Veteran', desc: 'Resistant' },
                { id: 'expert', icon: 'ðŸ”´', name: 'Expert', desc: 'Hostile/volatile' }
            ];

            var MOOD_CONFIG = {
                calm: { emoji: 'ðŸ˜', label: 'Calm' },
                nervous: { emoji: 'ðŸ˜°', label: 'Nervous' },
                agitated: { emoji: 'ðŸ˜ ', label: 'Agitated' },
                hostile: { emoji: 'ðŸ˜¡', label: 'Hostile' },
                defeated: { emoji: 'ðŸ˜”', label: 'Defeated' }
            };

            // ========== STICK FIGURE CHARACTER SYSTEM ==========
            var SKIN_TONES = ['skin-light', 'skin-medium', 'skin-tan', 'skin-brown', 'skin-dark'];
            var HAIR_COLORS = ['hair-black', 'hair-brown', 'hair-blonde', 'hair-red', 'hair-gray', 'hair-bald'];

            // Character types with their "expected" scenarios
            var CHARACTER_TYPES = {
                business: { name: 'Business', expected: ['civil_business', 'civil_property', 'harassment'] },
                casual: { name: 'Casual', expected: ['domestic', 'domestic_weapons', 'noise', 'civil_custody', 'threats'] },
                worker: { name: 'Worker', expected: ['trespass', 'civil_landlord', 'civil_repo'] },
                hoodie: { name: 'Hoodie', expected: ['burglary', 'theft', 'vehicle_theft', 'suspicious', 'shoplifting'] },
                elderly: { name: 'Elderly', expected: ['welfare_check', 'civil_property'] },
                athletic: { name: 'Athletic', expected: ['assault', 'disturbance', 'intoxicated'] },
                formal: { name: 'Formal', expected: ['dui', 'traffic_warrant', 'traffic_drugs', 'traffic_suspended'] }
            };

            // Store generated characters
            var currentCharacters = {};

            function pickRandom(arr) {
                return arr[Math.floor(Math.random() * arr.length)];
            }

            // Get SVG for stick figure
            function getStickFigureSVG() {
                return '<svg viewBox="0 0 40 60" xmlns="http://www.w3.org/2000/svg">' +
                    '<!-- Head -->' +
                    '<circle cx="20" cy="10" r="8" class="skin"/>' +
                    '<!-- Hair -->' +
                    '<path d="M12 8 Q20 2 28 8 Q28 6 20 4 Q12 6 12 8" class="hair"/>' +
                    '<!-- Body/Shirt -->' +
                    '<rect x="12" y="18" width="16" height="18" rx="2" class="shirt"/>' +
                    '<!-- Arms -->' +
                    '<rect x="4" y="20" width="8" height="4" rx="2" class="shirt"/>' +
                    '<rect x="28" y="20" width="8" height="4" rx="2" class="shirt"/>' +
                    '<!-- Hands -->' +
                    '<circle cx="4" cy="22" r="3" class="skin"/>' +
                    '<circle cx="36" cy="22" r="3" class="skin"/>' +
                    '<!-- Pants -->' +
                    '<rect x="12" y="36" width="7" height="16" rx="2" class="pants"/>' +
                    '<rect x="21" y="36" width="7" height="16" rx="2" class="pants"/>' +
                    '<!-- Feet -->' +
                    '<ellipse cx="15" cy="54" rx="4" ry="2" fill="#333"/>' +
                    '<ellipse cx="25" cy="54" rx="4" ry="2" fill="#333"/>' +
                    '<!-- Face -->' +
                    '<circle cx="17" cy="9" r="1" fill="#333"/>' +
                    '<circle cx="23" cy="9" r="1" fill="#333"/>' +
                    '<path d="M17 13 Q20 15 23 13" stroke="#333" stroke-width="1" fill="none"/>' +
                '</svg>';
            }

            // Select character type based on scenario and difficulty
            function selectCharacterType(scenarioType, difficulty, isSecondary) {
                var allTypes = Object.keys(CHARACTER_TYPES);

                // Find the "expected" type for this scenario
                var expectedType = null;
                for (var type in CHARACTER_TYPES) {
                    if (CHARACTER_TYPES[type].expected.indexOf(scenarioType) !== -1) {
                        expectedType = type;
                        break;
                    }
                }

                // Default to casual if no match
                if (!expectedType) expectedType = 'casual';

                // On easier difficulties, use the expected type
                // On harder difficulties, sometimes use unexpected types
                var mismatchChance = {
                    'trainee': 0,
                    'easy': 0.1,
                    'medium': 0.3,
                    'hard': 0.5,
                    'expert': 0.7
                };

                var shouldMismatch = Math.random() < (mismatchChance[difficulty] || 0.3);

                if (shouldMismatch) {
                    // Pick a random type that's NOT the expected one
                    var otherTypes = allTypes.filter(function(t) { return t !== expectedType; });
                    return pickRandom(otherTypes);
                }

                return expectedType;
            }

            // Generate a character with appearance
            function generateCharacter(id, scenarioType, difficulty, isSecondary) {
                var charType = selectCharacterType(scenarioType, difficulty, isSecondary);

                return {
                    id: id,
                    type: charType,
                    skin: pickRandom(SKIN_TONES),
                    hair: pickRandom(HAIR_COLORS)
                };
            }

            // Create stick figure HTML element
            function createStickFigureElement(character, subjectNum, position, inVehicle) {
                var div = document.createElement('div');
                div.className = 'stick-figure subject' + subjectNum + ' type-' + character.type + ' ' + character.skin + ' ' + character.hair;
                div.id = subjectNum === 1 ? 'subject-pos' : 'subject2-pos';

                if (inVehicle) {
                    div.classList.add('in-vehicle');
                }

                div.style.top = position.top;
                div.style.left = position.left;
                if (position.right) div.style.right = position.right;

                // Status badges HTML
                var statusBadges = '' +
                    '<div class="subject-status-badge cuffed-badge">ðŸ”— HANDCUFFED</div>' +
                    '<div class="subject-status-badge tazed-badge">âš¡ TAZED</div>' +
                    '<div class="subject-status-badge oc-badge">ðŸŒ¶ï¸ OC SPRAYED</div>' +
                    '<div class="subject-status-badge shot-badge">ðŸ©¸ SHOT</div>' +
                    '<div class="subject-status-badge prone-badge">âœ“ COMPLIANT</div>' +
                    '<div class="subject-status-badge fleeing-badge">ðŸƒ FLEEING</div>';

                div.innerHTML = getStickFigureSVG() + '<span class="stick-figure-label">S' + subjectNum + '</span>' + statusBadges;

                div.title = 'Subject ' + subjectNum;

                return div;
            }

            // Generate characters for a scenario
            function generateScenarioCharacters(scenarioType, difficulty) {
                currentCharacters = {};

                // Generate primary subject
                currentCharacters.s1 = generateCharacter('s1', scenarioType, difficulty, false);

                // Check if scenario needs second subject
                var multiPersonScenarios = ['domestic', 'domestic_weapons', 'assault', 'threats', 'civil_custody', 'civil_property'];
                if (multiPersonScenarios.indexOf(scenarioType) !== -1) {
                    currentCharacters.s2 = generateCharacter('s2', scenarioType, difficulty, true);
                }

                return currentCharacters;
            }

            // Inject stick figures into the scene, replacing dot markers
            function injectStickFigures(scenarioType) {
                var scene = document.getElementById('position-scene');
                if (!scene) return;

                // Get the existing subject marker to read its position
                var oldSubject = document.getElementById('subject-pos');
                var oldSubject2 = document.getElementById('subject2-pos');

                // Check if this is a traffic stop (subject in vehicle)
                var trafficScenarios = ['dui', 'traffic_warrant', 'traffic_drugs', 'traffic_suspended', 'vehicle_theft'];
                var inVehicle = trafficScenarios.indexOf(scenarioType) !== -1;

                // Replace subject 1
                if (oldSubject && currentCharacters.s1) {
                    var pos1 = {
                        top: oldSubject.style.top || '130px',
                        left: oldSubject.style.left || '50%',
                        right: oldSubject.style.right
                    };

                    // Create new stick figure
                    var figure1 = createStickFigureElement(currentCharacters.s1, 1, pos1, inVehicle);

                    // Replace old marker
                    oldSubject.parentNode.replaceChild(figure1, oldSubject);
                }

                // Replace subject 2 if exists
                if (oldSubject2 && currentCharacters.s2) {
                    var pos2 = {
                        top: oldSubject2.style.top || '130px',
                        left: oldSubject2.style.left || '58%',
                        right: oldSubject2.style.right
                    };

                    var figure2 = createStickFigureElement(currentCharacters.s2, 2, pos2, false);
                    oldSubject2.parentNode.replaceChild(figure2, oldSubject2);
                }
            }

            // DOM elements
            var scenarioSelectSection = document.getElementById('scenario-select-section');
            var chatSection = document.getElementById('demo-chat-section');
            var reportSection = document.getElementById('report-section');
            var debriefSection = document.getElementById('debrief-section');
            var messagesContainer = document.getElementById('demo-messages');
            var inputSay = document.getElementById('input-say');
            var inputDo = document.getElementById('input-do');
            var inputRadio = document.getElementById('input-radio');
            var sendBtn = document.getElementById('send-btn');
            var endBtn = document.getElementById('end-scenario-btn');
            var timerDisplay = document.getElementById('timer-display');

            // Initialize scenario grid
            function initScenarioGrid() {
                var grid = document.getElementById('scenario-grid');
                var scenarioOrder = ['random', 'dui', 'traffic_warrant', 'traffic_drugs', 'traffic_suspended', 'domestic', 'domestic_weapons', 'assault', 'threats', 'shoplifting', 'burglary', 'theft', 'vehicle_theft', 'trespass', 'disturbance', 'noise', 'loitering', 'civil_property', 'civil_custody', 'civil_landlord', 'civil_repo', 'civil_business', 'mental_crisis', 'welfare_check', 'suicide_threat', 'intoxicated', 'suspicious', 'alarm', 'harassment', 'stalking'];

                scenarioOrder.forEach(function(id) {
                    var scenario = SCENARIOS[id];
                    if (!scenario) return;

                    var card = document.createElement('div');
                    card.className = 'scenario-card' + (id === 'dui' ? ' selected' : '') + (id === 'random' ? ' random-card' : '');
                    card.dataset.scenario = id;

                    var iconBox = document.createElement('div');
                    iconBox.className = 'scenario-icon-box';
                    iconBox.textContent = scenario.icon;

                    var details = document.createElement('div');
                    details.className = 'scenario-details';

                    var h4 = document.createElement('h4');
                    h4.textContent = scenario.title;

                    var p = document.createElement('p');
                    p.textContent = getScenarioDescription(id);

                    details.appendChild(h4);
                    details.appendChild(p);
                    card.appendChild(iconBox);
                    card.appendChild(details);

                    // Add score display
                    var scoreData = getScenarioScore(id);
                    if (scoreData) {
                        var scoreDiv = document.createElement('div');
                        var best = scoreData.best;
                        var scoreClass = best >= 80 ? 'score-high' : (best >= 60 ? 'score-mid' : 'score-low');
                        scoreDiv.className = 'scenario-score ' + scoreClass;
                        scoreDiv.textContent = 'â˜… ' + best;
                        card.appendChild(scoreDiv);
                    }

                    card.addEventListener('click', function() {
                        document.querySelectorAll('.scenario-card').forEach(function(c) {
                            c.classList.remove('selected');
                        });
                        card.classList.add('selected');
                        selectedScenario = id;
                    });

                    grid.appendChild(card);
                });
            }

            function getScenarioDescription(id) {
                var descriptions = {
                    random: 'Test your adaptability',
                    dui: 'Suspected impaired driver',
                    traffic_warrant: 'Driver has outstanding warrant',
                    traffic_drugs: 'Suspected drug possession',
                    traffic_suspended: 'Driver with suspended license',
                    domestic: 'Yelling and breaking glass',
                    domestic_weapons: 'Domestic with weapon',
                    assault: 'Physical altercation',
                    threats: 'Verbal threats made',
                    shoplifting: 'LP detained suspect',
                    burglary: 'Suspect inside business',
                    theft: 'Victim reporting stolen property',
                    vehicle_theft: 'Stolen vehicle recovered',
                    trespass: 'Refusing to leave property',
                    disturbance: 'Disturbance at bar',
                    noise: 'Loud party complaints',
                    loitering: 'Aggressive panhandler',
                    civil_property: 'Property line dispute',
                    civil_custody: 'Disputed custody exchange',
                    civil_landlord: 'Eviction/lockout dispute',
                    civil_repo: 'Vehicle repo standby',
                    civil_business: 'Customer/business dispute',
                    mental_crisis: 'Person in distress',
                    welfare_check: 'Family hasnt heard from resident',
                    suicide_threat: 'Person threatening self-harm',
                    intoxicated: 'Passed out in public',
                    suspicious: 'Subject casing neighborhood',
                    alarm: 'Burglar alarm at business',
                    harassment: 'Ongoing harassment',
                    stalking: 'Victim being followed'
                };
                return descriptions[id] || '';
            }

            // Initialize difficulty grid
            function initDifficultyGrid() {
                var grid = document.getElementById('difficulty-grid');

                DIFFICULTIES.forEach(function(diff) {
                    var card = document.createElement('div');
                    card.className = 'difficulty-card' + (diff.id === 'easy' ? ' selected' : '');
                    card.dataset.difficulty = diff.id;

                    var icon = document.createElement('div');
                    icon.className = 'difficulty-icon';
                    icon.textContent = diff.icon;

                    var h4 = document.createElement('h4');
                    h4.textContent = diff.name;

                    var p = document.createElement('p');
                    p.textContent = diff.desc;

                    card.appendChild(icon);
                    card.appendChild(h4);
                    card.appendChild(p);

                    card.addEventListener('click', function() {
                        document.querySelectorAll('.difficulty-card').forEach(function(c) {
                            c.classList.remove('selected');
                        });
                        card.classList.add('selected');
                        selectedDifficulty = diff.id;
                    });

                    grid.appendChild(card);
                });
            }

            // Score management
            function getScenarioScore(scenarioId) {
                try {
                    var scores = JSON.parse(localStorage.getItem('blueshield_scores') || '{}');
                    return scores[scenarioId] || null;
                } catch (e) {
                    return null;
                }
            }

            function updateScenarioScore(scenarioId, score) {
                try {
                    var scores = JSON.parse(localStorage.getItem('blueshield_scores') || '{}');
                    if (!scores[scenarioId]) {
                        scores[scenarioId] = { best: score, attempts: 1 };
                    } else {
                        scores[scenarioId].attempts++;
                        if (score > scores[scenarioId].best) {
                            scores[scenarioId].best = score;
                        }
                    }
                    localStorage.setItem('blueshield_scores', JSON.stringify(scores));
                } catch (e) {
                    console.error('Error saving score:', e);
                }
            }

            // Progress indicator
            function updateProgress(step) {
                var stepSelect = document.getElementById('step-select');
                var stepTrain = document.getElementById('step-train');
                var stepReport = document.getElementById('step-report');
                var stepDebrief = document.getElementById('step-debrief');
                var connector1 = document.getElementById('connector-1');
                var connector2 = document.getElementById('connector-2');
                var connector3 = document.getElementById('connector-3');

                [stepSelect, stepTrain, stepReport, stepDebrief].forEach(function(el) {
                    el.classList.remove('active', 'completed');
                });
                [connector1, connector2, connector3].forEach(function(el) {
                    el.classList.remove('completed');
                });

                if (step === 'select') {
                    stepSelect.classList.add('active');
                } else if (step === 'train') {
                    stepSelect.classList.add('completed');
                    connector1.classList.add('completed');
                    stepTrain.classList.add('active');
                } else if (step === 'report') {
                    stepSelect.classList.add('completed');
                    stepTrain.classList.add('completed');
                    connector1.classList.add('completed');
                    connector2.classList.add('completed');
                    stepReport.classList.add('active');
                } else if (step === 'debrief') {
                    stepSelect.classList.add('completed');
                    stepTrain.classList.add('completed');
                    stepReport.classList.add('completed');
                    connector1.classList.add('completed');
                    connector2.classList.add('completed');
                    connector3.classList.add('completed');
                    stepDebrief.classList.add('active');
                }
            }

            // Helper to create elements
            function createElement(tag, className, textContent) {
                var el = document.createElement(tag);
                if (className) el.className = className;
                if (textContent) el.textContent = textContent;
                return el;
            }

            // Create SVG element helper
            function createSVG(viewBox, paths) {
                var svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
                svg.setAttribute('viewBox', viewBox);
                svg.setAttribute('stroke-width', '2');
                svg.setAttribute('fill', 'none');
                svg.setAttribute('stroke', 'currentColor');
                paths.forEach(function(pathData) {
                    var path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
                    path.setAttribute('d', pathData);
                    svg.appendChild(path);
                });
                return svg;
            }

            // Subject mood update
            function updateSubjectMood(mood, action) {
                if (!mood) mood = 'nervous';
                var config = MOOD_CONFIG[mood] || MOOD_CONFIG.nervous;

                document.getElementById('subject-portrait').className = 'subject-portrait mood-' + mood;
                document.getElementById('portrait-face').textContent = config.emoji;
                document.getElementById('subject-mood-badge').className = 'subject-mood mood-' + mood;
                document.getElementById('mood-text').textContent = config.label;

                if (action) {
                    document.getElementById('subject-action').textContent = action;
                }
            }

            // Observations
            function addObservations(newObs) {
                var list = document.getElementById('observation-list');
                newObs.forEach(function(obs) {
                    var existing = list.querySelectorAll('.observation-tag');
                    var found = false;
                    for (var i = 0; i < existing.length; i++) {
                        if (existing[i].textContent.trim().toLowerCase() === obs.toLowerCase()) {
                            found = true;
                            break;
                        }
                    }
                    if (!found) {
                        var tag = createElement('span', 'observation-tag');
                        tag.style.animation = 'messageIn 0.4s ease-out';
                        var svg = createSVG('0 0 24 24', ['M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z']);
                        var circle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
                        circle.setAttribute('cx', '12');
                        circle.setAttribute('cy', '12');
                        circle.setAttribute('r', '3');
                        svg.appendChild(circle);
                        tag.appendChild(svg);
                        tag.appendChild(document.createTextNode(' ' + obs));
                        list.appendChild(tag);
                    }
                });
            }

            function renderObservations(observations) {
                var list = document.getElementById('observation-list');
                list.textContent = '';
                observations.forEach(function(obs, i) {
                    var tag = createElement('span', 'observation-tag' + (i < 2 ? ' warning' : ''));
                    var svg = createSVG('0 0 24 24', ['M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z']);
                    var circle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
                    circle.setAttribute('cx', '12');
                    circle.setAttribute('cy', '12');
                    circle.setAttribute('r', '3');
                    svg.appendChild(circle);
                    tag.appendChild(svg);
                    tag.appendChild(document.createTextNode(' ' + obs));
                    list.appendChild(tag);
                });
            }

            // Message handling
            // Speech bubble functions
            function showSubjectSpeech(text) {
                var bubble = document.getElementById('subject-speech');
                var textEl = document.getElementById('subject-speech-text');
                var subjectMarker = document.getElementById('subject-pos');
                var scene = document.getElementById('position-scene');

                if (!bubble || !textEl) return;

                // Show full text - bubble has scroll for long content
                textEl.textContent = text;

                // Reset classes
                bubble.classList.remove('side-left', 'side-right');

                // Position bubble relative to subject marker
                if (subjectMarker && scene) {
                    var sceneRect = scene.getBoundingClientRect();
                    var markerRect = subjectMarker.getBoundingClientRect();

                    // Calculate marker position relative to scene
                    var markerCenterX = markerRect.left - sceneRect.left + markerRect.width / 2;
                    var markerCenterY = markerRect.top - sceneRect.top + markerRect.height / 2;
                    var markerTopY = markerRect.top - sceneRect.top;

                    // Check if bubble fits above (need ~85px space)
                    if (markerTopY > 90) {
                        // Position above the subject
                        bubble.style.top = Math.max(5, markerTopY - 85) + 'px';
                        bubble.style.bottom = 'auto';
                        var bubbleLeft = markerCenterX - 100;
                        bubbleLeft = Math.max(5, Math.min(bubbleLeft, sceneRect.width - 205));
                        bubble.style.left = bubbleLeft + 'px';
                        bubble.style.right = 'auto';
                    } else {
                        // Position to the side of the subject
                        bubble.style.top = Math.max(5, markerCenterY - 40) + 'px';
                        bubble.style.bottom = 'auto';

                        // Decide left or right based on subject position
                        if (markerCenterX > sceneRect.width / 2) {
                            // Subject on right, put bubble on left
                            bubble.classList.add('side-left');
                            bubble.style.left = Math.max(5, markerCenterX - 220) + 'px';
                            bubble.style.right = 'auto';
                        } else {
                            // Subject on left, put bubble on right
                            bubble.classList.add('side-right');
                            bubble.style.left = (markerCenterX + 30) + 'px';
                            bubble.style.right = 'auto';
                        }
                    }
                    bubble.style.transform = 'none';
                }

                bubble.style.display = 'block';
                bubble.style.animation = 'none';
                bubble.offsetHeight; // Trigger reflow
                bubble.style.animation = 'bubbleFadeIn 0.3s ease-out';
            }

            function showOfficerSpeech(text) {
                var bubble = document.getElementById('officer-speech');
                var textEl = document.getElementById('officer-speech-text');
                var officerMarker = document.getElementById('officer-pos');
                var scene = document.getElementById('position-scene');
                var subjectBubble = document.getElementById('subject-speech');

                if (!bubble || !textEl) return;

                // Show full text - bubble has scroll for long content
                textEl.textContent = text;

                // Position bubble directly above officer marker with tail pointing to them
                if (officerMarker && scene) {
                    var sceneRect = scene.getBoundingClientRect();
                    var markerRect = officerMarker.getBoundingClientRect();

                    // Calculate marker center position relative to scene
                    var markerCenterX = markerRect.left - sceneRect.left + markerRect.width / 2;
                    var markerTopY = markerRect.top - sceneRect.top;
                    var markerBottomY = markerTopY + markerRect.height;

                    // Check if subject bubble is visible and would overlap
                    var subjectBubbleVisible = subjectBubble && subjectBubble.style.display !== 'none';
                    var needsAlternatePosition = false;

                    if (subjectBubbleVisible) {
                        var subjectBubbleRect = subjectBubble.getBoundingClientRect();
                        var subjectBubbleBottom = subjectBubbleRect.bottom - sceneRect.top;
                        var officerBubbleTop = markerTopY - 85;

                        // If bubbles would overlap vertically (within 20px of each other)
                        if (officerBubbleTop < subjectBubbleBottom + 20) {
                            needsAlternatePosition = true;
                        }
                    }

                    if (needsAlternatePosition) {
                        // Position bubble BELOW the officer marker instead
                        var bubbleTop = markerBottomY + 15;
                        bubble.style.top = bubbleTop + 'px';
                        bubble.style.bottom = 'auto';
                        bubble.classList.add('below-marker');
                    } else {
                        // Position bubble above the officer (with space for the tail)
                        var bubbleTop = Math.max(5, markerTopY - 85);
                        bubble.style.top = bubbleTop + 'px';
                        bubble.style.bottom = 'auto';
                        bubble.classList.remove('below-marker');
                    }

                    // Center bubble horizontally above the officer
                    // Offset by half bubble width (approx 100px) to center it
                    var bubbleLeft = markerCenterX - 100;
                    // Keep bubble within scene bounds
                    bubbleLeft = Math.max(5, Math.min(bubbleLeft, sceneRect.width - 205));
                    bubble.style.left = bubbleLeft + 'px';
                    bubble.style.right = 'auto';
                    bubble.style.transform = 'none';
                }

                bubble.style.display = 'block';
                bubble.style.animation = 'none';
                bubble.offsetHeight; // Trigger reflow
                bubble.style.animation = 'bubbleFadeIn 0.3s ease-out';
            }

            function hideOfficerSpeech() {
                var bubble = document.getElementById('officer-speech');
                if (bubble) bubble.style.display = 'none';
            }

            function hideSpeechBubbles() {
                var subjectBubble = document.getElementById('subject-speech');
                var officerBubble = document.getElementById('officer-speech');
                var backupBubble = document.getElementById('backup-speech');
                if (subjectBubble) subjectBubble.style.display = 'none';
                if (officerBubble) officerBubble.style.display = 'none';
                if (backupBubble) backupBubble.style.display = 'none';
            }

            // Backup unit tracking
            var backupRequested = false;
            var backupOnScene = false;

            function checkForBackupRequest(radioText) {
                if (!radioText || backupRequested) return;

                var backupKeywords = [
                    'backup', 'back up', 'additional unit', 'cover', 'code 3',
                    'requesting unit', 'need another', 'send another', 'send a unit',
                    'assistance', 'help', 'officer needs'
                ];

                var lowerText = radioText.toLowerCase();
                for (var i = 0; i < backupKeywords.length; i++) {
                    if (lowerText.indexOf(backupKeywords[i]) !== -1) {
                        backupRequested = true;
                        // Backup arrives after a delay (3-5 seconds)
                        var delay = 3000 + Math.random() * 2000;
                        setTimeout(spawnBackupUnit, delay);
                        return;
                    }
                }
            }

            function spawnBackupUnit() {
                if (backupOnScene) return;
                backupOnScene = true;

                var scene = document.getElementById('position-scene');
                if (!scene) return;

                // Create backup patrol car
                var backupCar = document.createElement('div');
                backupCar.className = 'patrol-car draggable backup-car';
                backupCar.id = 'backup-car';
                backupCar.innerHTML = '<div class="patrol-wheels"><div class="patrol-wheel fl"></div><div class="patrol-wheel fr"></div><div class="patrol-wheel rl"></div><div class="patrol-wheel rr"></div></div><div class="patrol-hood"><div class="patrol-pushbar"></div><div class="patrol-headlights"><div class="patrol-headlight"></div><div class="patrol-headlight"></div></div></div><div class="patrol-windshield"></div><div class="patrol-cabin"><div class="lightbar"></div><div class="patrol-windows"><div class="patrol-window"></div><div class="patrol-window"></div></div><div class="patrol-label">Backup</div></div><div class="patrol-rear-section"></div><div class="patrol-trunk"><div class="patrol-taillights"><div class="patrol-taillight"></div><div class="patrol-taillight"></div></div></div>';
                backupCar.style.position = 'absolute';
                backupCar.style.left = '70%';
                backupCar.style.bottom = '15px';
                scene.appendChild(backupCar);

                // Create backup officer marker
                var backup = document.createElement('div');
                backup.className = 'position-marker officer backup';
                backup.id = 'backup-pos';
                backup.innerHTML = 'ðŸ‘®';
                backup.style.position = 'absolute';
                backup.style.left = '72%';
                backup.style.top = '75%';
                backup.style.transform = 'translate(-50%, -50%)';
                scene.appendChild(backup);

                // Add system message about backup arrival
                addMessage('system', 'ðŸš” Backup unit 2-Adam-15 has arrived on scene.');
            }

            function removeBackupUnit() {
                var backup = document.getElementById('backup-pos');
                var backupCar = document.getElementById('backup-car');
                var backupBubble = document.getElementById('backup-speech');
                if (backup) backup.remove();
                if (backupCar) backupCar.remove();
                if (backupBubble) backupBubble.remove();
                backupRequested = false;
                backupOnScene = false;
                backupWeaponDrawn = null;
                backupLastAction = null;
            }

            // ========== AUTONOMOUS BACKUP OFFICER AI ==========
            var backupWeaponDrawn = null;
            var backupLastAction = null;

            // Generate autonomous backup action based on main officer's action
            function generateBackupAction(officerInput) {
                if (!backupOnScene) return null;

                var say = officerInput.say || '';
                var doAction = officerInput.do || '';
                var radio = officerInput.radio || '';
                var lowerSay = say.toLowerCase();
                var lowerDo = doAction.toLowerCase();

                var backupAction = { action: null, speech: null };

                // Backup mirrors tactical positioning
                if (lowerDo.indexOf('cover') !== -1 || lowerDo.indexOf('position') !== -1) {
                    var positions = ['flanking left', 'flanking right', 'covering the exit', 'watching the perimeter', 'maintaining crossfire position'];
                    backupAction.action = 'Backup ' + positions[Math.floor(Math.random() * positions.length)];
                }

                // Backup draws weapon if main officer does
                if (lowerDo.indexOf('draw') !== -1 || lowerDo.indexOf('weapon') !== -1 || lowerDo.indexOf('pistol') !== -1 || lowerDo.indexOf('gun') !== -1) {
                    if (!backupWeaponDrawn) {
                        backupWeaponDrawn = 'pistol';
                        backupAction.action = 'Backup draws sidearm and takes cover position';
                    }
                }

                // Backup deploys less-lethal if situation escalates
                if (lowerDo.indexOf('taser') !== -1 || lowerDo.indexOf('taze') !== -1) {
                    var backupOptions = ['draws pepper spray', 'readies baton', 'prepares to assist with control'];
                    backupAction.action = 'Backup ' + backupOptions[Math.floor(Math.random() * backupOptions.length)];
                }

                // Backup provides verbal support when main officer gives commands
                if (lowerSay.indexOf('hands') !== -1 || lowerSay.indexOf('down') !== -1 || lowerSay.indexOf('ground') !== -1) {
                    var supportPhrases = [
                        'Do what he says!',
                        'Comply now!',
                        'Listen to him!',
                        'Do it!',
                        'You heard him!'
                    ];
                    backupAction.speech = supportPhrases[Math.floor(Math.random() * supportPhrases.length)];
                    if (!backupAction.action) {
                        backupAction.action = 'Backup maintains cover on subject';
                    }
                }

                // Backup watches for threats when officer approaches
                if (lowerDo.indexOf('approach') !== -1 || lowerDo.indexOf('walk') !== -1 || lowerDo.indexOf('move') !== -1 || lowerDo.indexOf('step') !== -1) {
                    var watchActions = [
                        'Backup maintains overwatch position',
                        'Backup scans for additional threats',
                        'Backup covers your approach',
                        'Backup watches subject\'s hands'
                    ];
                    backupAction.action = watchActions[Math.floor(Math.random() * watchActions.length)];
                }

                // Backup assists with arrest
                if (lowerDo.indexOf('cuff') !== -1 || lowerDo.indexOf('arrest') !== -1 || lowerDo.indexOf('handcuff') !== -1 || lowerDo.indexOf('detain') !== -1) {
                    backupAction.action = 'Backup moves in to assist with handcuffing';
                    backupAction.speech = 'I\'ve got the other arm';
                }

                // Backup assists with search
                if (lowerDo.indexOf('search') !== -1 || lowerDo.indexOf('pat down') !== -1 || lowerDo.indexOf('frisk') !== -1) {
                    backupAction.action = 'Backup provides cover during search';
                }

                // Backup watches vehicle during traffic stop actions
                if (lowerDo.indexOf('vehicle') !== -1 || lowerDo.indexOf('car') !== -1 || lowerDo.indexOf('driver') !== -1) {
                    var vehicleActions = [
                        'Backup watches passenger side',
                        'Backup monitors rear of vehicle',
                        'Backup illuminates interior with flashlight'
                    ];
                    backupAction.action = vehicleActions[Math.floor(Math.random() * vehicleActions.length)];
                }

                // If main officer is talking to subject, backup stays alert
                if (say && !backupAction.action) {
                    var alertActions = [
                        'Backup maintains visual on subject',
                        'Backup scanning area',
                        'Backup ready to assist'
                    ];
                    // Only add action 40% of the time to not spam
                    if (Math.random() < 0.4) {
                        backupAction.action = alertActions[Math.floor(Math.random() * alertActions.length)];
                    }
                }

                // Default - backup stays alert if doing something significant
                if (doAction && !backupAction.action && Math.random() < 0.3) {
                    backupAction.action = 'Backup maintains position';
                }

                return (backupAction.action || backupAction.speech) ? backupAction : null;
            }

            // Display backup officer's action
            function showBackupAction(backupAction) {
                if (!backupAction || !backupOnScene) return;

                var scene = document.getElementById('position-scene');
                var backupMarker = document.getElementById('backup-pos');
                if (!scene || !backupMarker) return;

                // Create or get backup speech bubble
                var bubble = document.getElementById('backup-speech');
                if (!bubble) {
                    bubble = document.createElement('div');
                    bubble.id = 'backup-speech';
                    bubble.className = 'speech-bubble backup-bubble';
                    bubble.innerHTML = '<div class="bubble-label">Backup</div><div class="bubble-text"></div>';
                    scene.appendChild(bubble);
                }

                // Build display text
                var displayText = '';
                if (backupAction.speech) {
                    displayText = '"' + backupAction.speech + '"';
                }
                if (backupAction.action) {
                    if (displayText) displayText += ' ';
                    displayText += '(' + backupAction.action + ')';
                }

                bubble.querySelector('.bubble-text').textContent = displayText;

                // Position bubble near backup officer
                var sceneRect = scene.getBoundingClientRect();
                var markerRect = backupMarker.getBoundingClientRect();
                var markerX = markerRect.left - sceneRect.left + markerRect.width / 2;
                var markerY = markerRect.top - sceneRect.top;

                bubble.style.left = Math.max(5, markerX - 100) + 'px';
                bubble.style.top = Math.max(5, markerY - 70) + 'px';
                bubble.style.display = 'block';
                bubble.style.animation = 'none';
                bubble.offsetHeight;
                bubble.style.animation = 'bubbleFadeIn 0.3s ease-out';

                // Flash backup marker
                backupMarker.classList.add('active');
                setTimeout(function() { backupMarker.classList.remove('active'); }, 500);

                // Bubble stays visible until next action (no auto-hide)
            }

            // Get backup action text for including in message to AI
            function getBackupActionText(backupAction) {
                if (!backupAction) return '';
                var text = '';
                if (backupAction.action) {
                    text += '[BACKUP DOES]: ' + backupAction.action;
                }
                if (backupAction.speech) {
                    if (text) text += ' ';
                    text += '[BACKUP SAYS]: "' + backupAction.speech + '"';
                }
                return text;
            }

            // Subject movement system
            var currentSubjectMood = 'nervous';

            function checkForMovementCommand(officerMessage, subjectMood) {
                if (!officerMessage) return false;

                var moveKeywords = [
                    'come here', 'come over', 'step over', 'walk over', 'get over here',
                    'come to me', 'step towards', 'walk towards', 'approach me',
                    'come closer', 'step forward', 'move over here', 'get out',
                    'exit the vehicle', 'step out', 'out of the car', 'out of the vehicle'
                ];

                var lowerText = officerMessage.toLowerCase();
                for (var i = 0; i < moveKeywords.length; i++) {
                    if (lowerText.indexOf(moveKeywords[i]) !== -1) {
                        return true;
                    }
                }
                return false;
            }

            function willSubjectComply(mood, difficulty) {
                // Compliance based on mood and difficulty
                var complianceChance = {
                    'trainee': { calm: 1.0, nervous: 1.0, agitated: 0.95, hostile: 0.9, defeated: 1.0 },
                    'easy': { calm: 1.0, nervous: 0.95, agitated: 0.85, hostile: 0.7, defeated: 1.0 },
                    'medium': { calm: 0.95, nervous: 0.85, agitated: 0.6, hostile: 0.4, defeated: 1.0 },
                    'hard': { calm: 0.85, nervous: 0.7, agitated: 0.4, hostile: 0.2, defeated: 0.95 },
                    'expert': { calm: 0.7, nervous: 0.5, agitated: 0.25, hostile: 0.1, defeated: 0.9 }
                };

                var difficultyLevel = complianceChance[difficulty] || complianceChance['medium'];
                var chance = difficultyLevel[mood] || 0.5;

                return Math.random() < chance;
            }

            function moveSubjectTowardOfficer() {
                var subject = document.getElementById('subject-pos');
                var officer = document.getElementById('officer-pos');
                var scene = document.getElementById('position-scene');

                if (!subject || !officer || !scene) return;

                var sceneRect = scene.getBoundingClientRect();
                var officerRect = officer.getBoundingClientRect();

                // Calculate officer position relative to scene
                var officerX = officerRect.left - sceneRect.left + officerRect.width / 2;
                var officerY = officerRect.top - sceneRect.top + officerRect.height / 2;

                // Get current subject position
                var subjectRect = subject.getBoundingClientRect();
                var subjectX = subjectRect.left - sceneRect.left + subjectRect.width / 2;
                var subjectY = subjectRect.top - sceneRect.top + subjectRect.height / 2;

                // Calculate new position (move 60-70% of the way toward officer)
                var moveRatio = 0.6 + Math.random() * 0.1;
                var newX = subjectX + (officerX - subjectX) * moveRatio;
                var newY = subjectY + (officerY - subjectY) * moveRatio;

                // Keep some distance (about 5 feet / ~40px)
                var dx = officerX - newX;
                var dy = officerY - newY;
                var dist = Math.sqrt(dx * dx + dy * dy);
                if (dist < 40) {
                    // Too close, back off a bit
                    newX = officerX - (dx / dist) * 45;
                    newY = officerY - (dy / dist) * 45;
                }

                // Animate the movement
                subject.style.transition = 'left 0.8s ease-out, top 0.8s ease-out';
                subject.style.left = newX + 'px';
                subject.style.top = newY + 'px';
                subject.style.transform = 'translate(-50%, -50%)';

                // Flash to indicate movement
                subject.classList.add('active');
                setTimeout(function() {
                    subject.classList.remove('active');
                    subject.style.transition = '';
                }, 1000);

                // Update distance indicator
                setTimeout(function() {
                    var distIndicator = document.getElementById('distance-indicator');
                    if (distIndicator) {
                        distIndicator.textContent = '~5 ft';
                        distIndicator.style.left = (newX + 20) + 'px';
                        distIndicator.style.top = (newY - 30) + 'px';
                    }
                }, 800);
            }

            function handleSubjectMovement(officerMessage, subjectMood, difficulty) {
                if (!checkForMovementCommand(officerMessage, subjectMood)) return;

                currentSubjectMood = subjectMood || 'nervous';

                if (willSubjectComply(currentSubjectMood, difficulty)) {
                    // Subject complies - move after a short delay
                    setTimeout(moveSubjectTowardOfficer, 500);
                }
                // If not complying, the AI response will indicate refusal
            }

            // Dispatch response system
            function generateDispatchResponse(radioText) {
                if (!radioText) return null;

                var lowerText = radioText.toLowerCase();
                var responses = [];

                // Check for various radio traffic types and generate appropriate responses
                if (lowerText.indexOf('10-4') !== -1 || lowerText.indexOf('copy') !== -1) {
                    return null; // No response needed for acknowledgments
                }

                if (lowerText.indexOf('backup') !== -1 || lowerText.indexOf('additional unit') !== -1 || lowerText.indexOf('code 3') !== -1) {
                    return '10-4, dispatching backup to your location. ETA 2-3 minutes.';
                }

                if (lowerText.indexOf('run') !== -1 || lowerText.indexOf('check') !== -1 || lowerText.indexOf('plate') !== -1 || lowerText.indexOf('license') !== -1) {
                    return '10-4, running that now. Stand by for return.';
                }

                if (lowerText.indexOf('warrant') !== -1) {
                    return 'Copy, checking warrants. Stand by.';
                }

                if (lowerText.indexOf('location') !== -1 || lowerText.indexOf('scene') !== -1 || lowerText.indexOf('arrived') !== -1 || lowerText.indexOf('on scene') !== -1) {
                    return '10-4, showing you on scene. Time noted.';
                }

                if (lowerText.indexOf('clear') !== -1 || lowerText.indexOf('10-8') !== -1) {
                    return '10-4, showing you clear and available.';
                }

                if (lowerText.indexOf('arrest') !== -1 || lowerText.indexOf('custody') !== -1) {
                    return '10-4, one in custody. Do you need transport?';
                }

                if (lowerText.indexOf('ambulance') !== -1 || lowerText.indexOf('medical') !== -1 || lowerText.indexOf('ems') !== -1 || lowerText.indexOf('fire') !== -1) {
                    return '10-4, dispatching medical to your location.';
                }

                if (lowerText.indexOf('tow') !== -1 || lowerText.indexOf('impound') !== -1) {
                    return '10-4, contacting tow company. Stand by for ETA.';
                }

                if (lowerText.indexOf('supervisor') !== -1 || lowerText.indexOf('sergeant') !== -1) {
                    return '10-4, notifying supervisor. They will contact you on TAC 2.';
                }

                // Generic acknowledgment for other radio traffic
                return '10-4, copy.';
            }

            function showDispatchResponse(radioText) {
                var response = generateDispatchResponse(radioText);
                if (response) {
                    // Delay dispatch response slightly to feel realistic
                    setTimeout(function() {
                        // Show in dispatcher bubble on scene
                        showDispatcherBubble(response);
                    }, 800 + Math.random() * 700);
                }
            }

            function showDispatcherBubble(text) {
                var bubble = document.getElementById('dispatcher-bubble');
                var textEl = document.getElementById('dispatch-text');
                var timeEl = document.getElementById('dispatch-time');
                var avatar = document.getElementById('dispatcher-avatar');

                if (!bubble || !textEl) return;

                // Update text
                textEl.textContent = text;

                // Update time
                if (timeEl) {
                    var now = new Date();
                    var hours = now.getHours();
                    var mins = now.getMinutes().toString().padStart(2, '0');
                    var ampm = hours >= 12 ? 'PM' : 'AM';
                    hours = hours % 12 || 12;
                    timeEl.textContent = hours + ':' + mins + ' ' + ampm;
                }

                // Animate avatar
                if (avatar) {
                    avatar.classList.remove('active');
                    void avatar.offsetWidth; // Trigger reflow
                    avatar.classList.add('active');
                }

                // Show bubble
                bubble.classList.remove('visible');
                void bubble.offsetWidth; // Trigger reflow
                bubble.classList.add('visible');

                // Bubble stays visible until next action (no auto-hide)
            }

            function hideDispatcherBubble() {
                var bubble = document.getElementById('dispatcher-bubble');
                if (bubble) bubble.classList.remove('visible');
            }

            function addMessage(type, text, hint) {
                var messageDiv = createElement('div', 'message');
                messageDiv.style.animation = 'messageIn 0.4s ease-out';

                if (type === 'system') {
                    messageDiv.className = 'message message-system';
                    messageDiv.appendChild(createElement('div', 'message-content', text));
                } else if (type === 'subject') {
                    messageDiv.className = 'message message-subject';
                    messageDiv.appendChild(createElement('div', 'message-label', 'Subject'));
                    messageDiv.appendChild(createElement('div', 'message-content', text));
                    // Show speech bubble on scene
                    showSubjectSpeech(text);
                    // Hide officer speech when subject responds
                    hideOfficerSpeech();
                } else if (type === 'officer') {
                    messageDiv.className = 'message message-officer';
                    messageDiv.appendChild(createElement('div', 'message-label', 'You'));
                    messageDiv.appendChild(createElement('div', 'message-content', text));
                } else if (type === 'loading') {
                    messageDiv.className = 'message message-subject';
                    messageDiv.id = 'loading-message';
                    messageDiv.appendChild(createElement('div', 'message-label', 'Subject'));

                    var content = createElement('div', 'message-content');
                    content.style.display = 'flex';
                    content.style.alignItems = 'center';
                    content.style.gap = '0.75rem';
                    content.style.opacity = '0.8';

                    var spinner = createElement('span', 'loading-spinner', 'Processing');
                    var dots = createElement('div', 'loading-dots');
                    dots.appendChild(createElement('span'));
                    dots.appendChild(createElement('span'));
                    dots.appendChild(createElement('span'));

                    content.appendChild(spinner);
                    content.appendChild(dots);
                    messageDiv.appendChild(content);
                } else if (type === 'error') {
                    messageDiv.className = 'message message-subject message-error';
                    messageDiv.appendChild(createElement('div', 'message-label', 'âš ï¸ Error'));
                    messageDiv.appendChild(createElement('div', 'message-content', text));
                } else if (type === 'dispatch') {
                    messageDiv.className = 'message message-dispatch';
                    messageDiv.appendChild(createElement('div', 'message-label', 'ðŸ“» Dispatch'));
                    messageDiv.appendChild(createElement('div', 'message-content', text));
                }

                messagesContainer.appendChild(messageDiv);

                if (hint) {
                    var hintDiv = createElement('div', 'hint-panel');
                    var hintBox = createElement('div', 'hint-box');
                    hintBox.style.animation = 'hintIn 0.5s ease-out';

                    var iconSvg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
                    iconSvg.setAttribute('class', 'hint-icon');
                    iconSvg.setAttribute('viewBox', '0 0 24 24');
                    var circle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
                    circle.setAttribute('cx', '12');
                    circle.setAttribute('cy', '12');
                    circle.setAttribute('r', '10');
                    var path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
                    path.setAttribute('d', 'M12 16v-4M12 8h.01');
                    iconSvg.appendChild(circle);
                    iconSvg.appendChild(path);

                    var hintContent = createElement('div', 'hint-content');
                    hintContent.appendChild(createElement('strong', null, 'Training Hint'));
                    hintContent.appendChild(document.createTextNode(' ' + hint));

                    hintBox.appendChild(iconSvg);
                    hintBox.appendChild(hintContent);
                    hintDiv.appendChild(hintBox);
                    messagesContainer.appendChild(hintDiv);
                }

                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            }

            function addOfficerMessage(input) {
                var messageDiv = createElement('div', 'message message-officer');
                messageDiv.style.animation = 'messageIn 0.4s ease-out';
                messageDiv.appendChild(createElement('div', 'message-label', 'You'));

                var content = createElement('div', 'message-content');

                if (input.say) {
                    var sayLine = createElement('div');
                    sayLine.style.marginBottom = '0.35rem';
                    sayLine.appendChild(document.createTextNode('ðŸ’¬ "' + input.say + '"'));
                    content.appendChild(sayLine);
                }

                if (input.do) {
                    var doLine = createElement('div');
                    doLine.style.marginBottom = '0.35rem';
                    doLine.style.fontStyle = 'italic';
                    doLine.style.color = 'var(--accent-gold)';
                    doLine.appendChild(document.createTextNode('ðŸ‘ ' + input.do));
                    content.appendChild(doLine);
                }

                if (input.radio) {
                    var radioLine = createElement('div');
                    radioLine.style.color = 'var(--success)';
                    radioLine.appendChild(document.createTextNode('ðŸ“» "' + input.radio + '"'));
                    content.appendChild(radioLine);

                    // Check if requesting backup
                    checkForBackupRequest(input.radio);

                    // Get dispatch response
                    showDispatchResponse(input.radio);
                }

                messageDiv.appendChild(content);
                messagesContainer.appendChild(messageDiv);
                messagesContainer.scrollTop = messagesContainer.scrollHeight;

                // Show officer speech bubble with "Say" and/or "Radio" content
                var bubbleText = '';
                if (input.say) {
                    bubbleText = '"' + input.say + '"';
                }
                if (input.radio) {
                    if (bubbleText) bubbleText += '\n';
                    bubbleText += 'ðŸ“» ' + input.radio;
                }
                if (bubbleText) {
                    showOfficerSpeech(bubbleText);
                }
            }

            function removeLoading() {
                var loading = document.getElementById('loading-message');
                if (loading) loading.remove();
            }

            // Timer
            function startTimer() {
                timerStart = Date.now();
                timerDisplay.classList.add('active');
                timerInterval = setInterval(function() {
                    var elapsed = (Date.now() - timerStart) / 1000;
                    timerDisplay.textContent = elapsed.toFixed(1) + 's';
                }, 100);
            }

            function stopTimer() {
                if (timerInterval) {
                    clearInterval(timerInterval);
                    timerInterval = null;
                }
                timerDisplay.classList.remove('active');
            }

            function setLoading(loading) {
                isLoading = loading;
                inputSay.disabled = loading;
                inputDo.disabled = loading;
                inputRadio.disabled = loading;
                sendBtn.disabled = loading;
                endBtn.disabled = loading;
                if (loading) {
                    addMessage('loading');
                    startTimer();
                } else {
                    removeLoading();
                    stopTimer();
                }
            }

            // API calls
            function sendToAPI(officerMessage) {
                setLoading(true);

                // Clear previous speech bubbles when sending new message
                hideSpeechBubbles();
                hideDispatcherBubble();

                // Apply pending force effect when action is sent
                if (window.pendingForceAction && typeof applyForceEffect === 'function') {
                    applyForceEffect(window.pendingForceAction);
                    window.pendingForceAction = null;
                }

                if (officerMessage) {
                    messages.push({ role: 'officer', content: officerMessage });

                    // Check if officer is asking second person to step out
                    if (typeof checkForStepOutCommand === 'function' && checkForStepOutCommand(officerMessage)) {
                        setTimeout(function() {
                            if (typeof makeSecondPersonStepOut === 'function') {
                                makeSecondPersonStepOut();
                            }
                        }, 1500);
                    }
                }

                fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'chat',
                        messages: messages,
                        message: officerMessage,
                        training_mode: true,
                        scenario: selectedScenario,
                        difficulty: selectedDifficulty,
                        scenario_config: SCENARIOS[selectedScenario],
                        difficulty_modifier: DIFFICULTY_MODIFIERS[selectedDifficulty]
                    })
                })
                .then(function(response) { return response.json(); })
                .then(function(data) {
                    setLoading(false);

                    var subjectResponse = data.subject_response || 'No response';
                    messages.push({
                        role: 'subject',
                        content: subjectResponse,
                        raw_response: data.raw_response,
                        evaluation: data.evaluation
                    });

                    updateSubjectMood(data.subject_mood, data.subject_action);
                    addMessage('subject', subjectResponse, data.hint);

                    // Check for status effects in AI response
                    if (typeof parseResponseForStatusEffects === 'function') {
                        parseResponseForStatusEffects(subjectResponse);
                    }

                    // Check if officer gave movement command and subject should comply
                    handleSubjectMovement(officerMessage, data.subject_mood, selectedDifficulty);

                    if (data.new_observations && data.new_observations.length > 0) {
                        addObservations(data.new_observations);
                    }

                    if (data.scenario_complete) {
                        setTimeout(function() { showReport(); }, 1500);
                    }
                })
                .catch(function(err) {
                    setLoading(false);
                    console.error('API Error:', err);
                    addMessage('error', 'Connection failed. Check your internet and try again.');
                });
            }

            function requestDebrief() {
                // Show loading state on submit button
                var submitBtn = document.getElementById('submit-report-btn');
                var originalText = submitBtn.innerHTML;
                submitBtn.disabled = true;
                submitBtn.innerHTML = '<span class="loading-spinner">Generating Debrief...</span>';

                fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'debrief',
                        messages: messages
                    })
                })
                .then(function(response) { return response.json(); })
                .then(function(data) {
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = originalText;
                    console.log('Debrief data:', data);
                    showDebrief(data);
                })
                .catch(function(err) {
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = originalText;
                    console.error('Debrief Error:', err);
                    showDebrief({ score: 0, summary: 'Error generating debrief. Please try again.', legal_analysis: [], recommendations: 'There was a connection error.' });
                });
            }

            function showReport() {
                chatSection.style.display = 'none';
                reportSection.classList.add('active');
                updateProgress('report');
                stopTimer();

                // Show FI card tab
                document.getElementById('fi-card-tab').style.display = 'block';

                // Update header info only
                var scenario = SCENARIOS[selectedScenario];
                var now = new Date();
                var dateStr = (now.getMonth() + 1) + '/' + now.getDate() + '/' + now.getFullYear();
                var timeStr = now.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
                var caseNum = 'TRN-' + Math.floor(100000 + Math.random() * 900000);

                document.getElementById('report-scenario-info').textContent = scenario.title + ' | ' + scenario.location + ' | Case #' + caseNum + ' | ' + dateStr + ' ' + timeStr;

                // Clear all textboxes (leave blank for user to fill)
                document.getElementById('report-synopsis').value = '';
                document.getElementById('report-call-details').value = '';
                document.getElementById('report-narrative').value = '';
                document.getElementById('report-conclusion').value = '';

                // Scroll to top of report
                document.querySelector('.demo-content').scrollTop = 0;
            }

            function showDebrief(data) {
                reportSection.classList.remove('active');
                chatSection.style.display = 'none';

                // Calculate overall score
                var overallScore = (typeof data.overall_score === 'number') ? data.overall_score :
                                   (typeof data.scenario_score === 'number') ? data.scenario_score : 0;

                // Show pass/fail overlay first (70% threshold)
                showResultOverlay(overallScore >= 70, overallScore);

                // Hide FI card
                document.getElementById('fi-card-tab').style.display = 'none';
                document.getElementById('fi-card-panel').classList.remove('open');
                document.getElementById('fi-card-tab').classList.remove('active');
                debriefSection.classList.add('active');
                updateProgress('debrief');

                // Helper function for score class
                function getScoreClass(score) {
                    if (score < 40) return 'score-low';
                    if (score < 70) return 'score-mid';
                    return 'score-high';
                }

                // Overall Score
                var overallScore = (typeof data.overall_score === 'number') ? data.overall_score :
                                   (typeof data.scenario_score === 'number') ? data.scenario_score : 0;
                updateScenarioScore(selectedScenario, overallScore);

                var overallScoreEl = document.getElementById('debrief-overall-score');
                overallScoreEl.textContent = overallScore;
                overallScoreEl.className = 'overall-score-value ' + getScoreClass(overallScore);

                var overallContainer = document.querySelector('.debrief-overall-score');
                overallContainer.className = 'debrief-overall-score ' + getScoreClass(overallScore);

                // Scenario Score Badge
                var scenarioScore = (typeof data.scenario_score === 'number') ? data.scenario_score : overallScore;
                var scenarioScoreBadge = document.getElementById('scenario-score-badge');
                scenarioScoreBadge.textContent = scenarioScore + '/100';
                scenarioScoreBadge.className = 'category-score ' + getScoreClass(scenarioScore);

                // Scenario Summary
                var scenarioSummary = data.scenario_summary || data.summary || 'No scenario summary available.';
                document.getElementById('scenario-summary-text').textContent = scenarioSummary;

                // Scenario Analysis
                var scenarioAnalysis = document.getElementById('scenario-analysis');
                var analysisHeader = scenarioAnalysis.querySelector('h4');
                while (scenarioAnalysis.lastChild !== analysisHeader) {
                    scenarioAnalysis.removeChild(scenarioAnalysis.lastChild);
                }

                var analysisItems = data.scenario_analysis || data.legal_analysis || [];
                if (analysisItems.length > 0) {
                    analysisItems.forEach(function(item) {
                        var itemDiv = createElement('div', 'debrief-item');
                        var status = item.status || 'incorrect';
                        var statusSpan = createElement('span', 'debrief-status status-' + status);
                        statusSpan.textContent = status === 'correct' ? 'âœ“' : (status === 'needs_improvement' ? '!' : 'âœ—');

                        var p = createElement('p');
                        var category = item.category || item.topic || 'Item';
                        p.appendChild(createElement('strong', null, category + ': '));
                        p.appendChild(document.createTextNode(item.detail || ''));

                        itemDiv.appendChild(statusSpan);
                        itemDiv.appendChild(p);
                        scenarioAnalysis.appendChild(itemDiv);
                    });
                } else {
                    var emptyDiv = createElement('div', 'empty-state');
                    emptyDiv.innerHTML = '<div class="empty-state-icon">ðŸ“Š</div>Not enough interaction to analyze';
                    scenarioAnalysis.appendChild(emptyDiv);
                }

                // Scenario Strengths
                var strengthsList = document.getElementById('scenario-strengths-list');
                strengthsList.innerHTML = '';
                var strengths = data.scenario_strengths || data.strengths || [];
                if (strengths.length > 0) {
                    strengths.forEach(function(strength) {
                        var li = createElement('li', null, strength);
                        strengthsList.appendChild(li);
                    });
                } else {
                    var li = createElement('li', null, 'No notable strengths identified.');
                    li.style.color = 'var(--text-muted)';
                    strengthsList.appendChild(li);
                }

                // Scenario Improvements
                var improvementsList = document.getElementById('scenario-improvements-list');
                improvementsList.innerHTML = '';
                var improvements = data.scenario_improvements || data.areas_for_improvement || [];
                if (improvements.length > 0) {
                    improvements.forEach(function(area) {
                        var li = createElement('li', null, area);
                        improvementsList.appendChild(li);
                    });
                } else {
                    var li = createElement('li', null, 'Review the analysis above for specific areas to work on.');
                    li.style.color = 'var(--text-muted)';
                    improvementsList.appendChild(li);
                }

                // Report Score Badge
                var reportScore = (typeof data.report_score === 'number') ? data.report_score : 0;
                var reportScoreBadge = document.getElementById('report-score-badge');
                reportScoreBadge.textContent = reportScore + '/100';
                reportScoreBadge.className = 'category-score ' + getScoreClass(reportScore);

                // Report Summary
                var reportSummary = data.report_summary || 'Report evaluation not available.';
                document.getElementById('report-summary-text').textContent = reportSummary;

                // Report Analysis
                var reportAnalysis = document.getElementById('report-analysis');
                var reportHeader = reportAnalysis.querySelector('h4');
                while (reportAnalysis.lastChild !== reportHeader) {
                    reportAnalysis.removeChild(reportAnalysis.lastChild);
                }

                var reportItems = data.report_analysis || [];
                if (reportItems.length > 0) {
                    reportItems.forEach(function(item) {
                        var itemDiv = createElement('div', 'debrief-item');
                        var status = item.status || 'incorrect';
                        var statusSpan = createElement('span', 'debrief-status status-' + status);
                        statusSpan.textContent = status === 'correct' ? 'âœ“' : (status === 'needs_improvement' ? '!' : 'âœ—');

                        var p = createElement('p');
                        p.appendChild(createElement('strong', null, (item.category || item.topic || 'Item') + ': '));
                        p.appendChild(document.createTextNode(item.detail || ''));

                        itemDiv.appendChild(statusSpan);
                        itemDiv.appendChild(p);
                        reportAnalysis.appendChild(itemDiv);
                    });
                } else {
                    var emptyDiv = createElement('div', 'empty-state');
                    emptyDiv.innerHTML = '<div class="empty-state-icon">ðŸ“</div>Report evaluation coming soon';
                    reportAnalysis.appendChild(emptyDiv);
                }

                // Recommendations
                var recommendations = data.recommendations || 'No specific recommendations available.';
                document.getElementById('debrief-rec-text').textContent = recommendations;

                // Scroll to top
                document.querySelector('.demo-content').scrollTop = 0;
            }

            // Start scenario
            function startScenario() {
                messages = [];
                messagesContainer.textContent = '';
                updateProgress('train');

                // Handle random scenario
                var actualScenario = selectedScenario;
                if (selectedScenario === 'random') {
                    var scenarioKeys = Object.keys(SCENARIOS).filter(function(k) { return k !== 'random'; });
                    actualScenario = scenarioKeys[Math.floor(Math.random() * scenarioKeys.length)];
                }

                var scenario = SCENARIOS[actualScenario];
                selectedScenario = actualScenario;

                // Load the appropriate scene for this scenario type
                SceneManager.loadSceneForScenario(actualScenario);

                // Generate characters and inject stick figures
                generateScenarioCharacters(actualScenario, selectedDifficulty);
                injectStickFigures(actualScenario);

                // Initialize second person inside for domestic scenarios
                if (typeof initSecondPersonInside === 'function') {
                    initSecondPersonInside(actualScenario);
                }

                // Position officer at patrol car at start
                positionOfficerAtPatrolCar();

                // Initialize patrol car rotation
                initPatrolCarRotation();

                // Update header
                document.getElementById('chat-scenario-title').textContent = scenario.title;
                document.getElementById('chat-scenario-location').textContent = scenario.location;

                // Update observations
                renderObservations(scenario.observations);

                updateSubjectMood('nervous', 'Tense body language');

                messages.push({ role: 'system', content: scenario.intro });
                addMessage('system', scenario.intro);

                scenarioSelectSection.style.display = 'none';
                chatSection.style.display = 'flex';

                // Show FI card tab and clear all fields (user fills in everything)
                document.getElementById('fi-card-tab').style.display = 'block';
                document.getElementById('fi-card-panel').classList.remove('open');
                document.getElementById('fi-card-tab').classList.remove('active');
                var fiFields = document.querySelectorAll('#fi-card-panel input, #fi-card-panel textarea, #fi-card-panel select');
                fiFields.forEach(function(field) {
                    if (field.tagName === 'SELECT') {
                        field.selectedIndex = 0;
                    } else if (field.id === 'fi-state' || field.id === 'fi-dl-state' || field.id === 'fi-plate-state') {
                        field.value = 'AZ';
                    } else {
                        field.value = '';
                    }
                });

                sendToAPI('');
            }

            // Send message
            function buildOfficerMessage() {
                var say = inputSay.value.trim();
                var doAction = inputDo.value.trim();
                var radio = inputRadio.value.trim();

                var parts = [];
                if (say) parts.push('[SAYS]: "' + say + '"');
                if (doAction) parts.push('[DOES]: ' + doAction);
                if (radio) parts.push('[RADIOS]: "' + radio + '"');

                return {
                    combined: parts.join('\n'),
                    say: say,
                    do: doAction,
                    radio: radio
                };
            }

            // Update the current action display in positioning panel
            function updateCurrentAction(doText) {
                var actionTextEl = document.getElementById('current-action-text');
                if (!actionTextEl) return;

                if (doText && doText.trim()) {
                    actionTextEl.textContent = doText;
                    // Flash animation
                    actionTextEl.classList.remove('action-update');
                    void actionTextEl.offsetWidth; // Force reflow
                    actionTextEl.classList.add('action-update');

                    // Open the positioning panel if closed
                    var posToggle = document.getElementById('positioning-toggle');
                    var posContent = document.getElementById('positioning-content');
                    if (posToggle && posContent && !posContent.classList.contains('open')) {
                        posToggle.classList.add('open');
                        posContent.classList.add('open');
                    }
                }
            }

            // Auto-detect officer position from "Do" action text
            function detectAndUpdatePosition(doText) {
                if (!doText) return;

                // Always update the current action display
                updateCurrentAction(doText);

                var text = doText.toLowerCase();

                // Universal keywords that work across all scene types
                var positionKeywords = {
                    // Traffic scene positions
                    'contact': ['approach driver', 'driver window', 'driver door', 'at the driver', 'to the driver', 'walk to driver', 'move to driver', 'step to driver', 'walk up to', 'approach the', 'make contact', 'go to the'],
                    'driver-rear': ['behind driver', 'driver rear', 'driver side rear', 'left rear', 'driver\'s rear'],
                    'passenger-rear': ['passenger rear', 'passenger side', 'right rear', 'approach passenger', 'to passenger'],
                    // Residential scene positions
                    'approach': ['approach', 'walk toward', 'walk to', 'move toward', 'go to', 'walking up'],
                    'door-left': ['left of door', 'hinge side', 'door left', 'stand left', 'position left'],
                    'door-right': ['right of door', 'knob side', 'door right', 'stand right', 'position right'],
                    // Business scene positions
                    'entrance': ['at entrance', 'store entrance', 'front entrance', 'at the door', 'at the front'],
                    'inside': ['go inside', 'enter store', 'inside the', 'walk inside', 'step inside'],
                    'lp-office': ['lp office', 'loss prevention', 'back office', 'security office'],
                    // Bar scene positions
                    'interview': ['interview area', 'separate', 'away from crowd', 'pull aside'],
                    // Outdoor scene positions
                    'flank': ['flank', 'to the side', 'circle around', 'side approach'],
                    // Universal cover position
                    'cover': ['cover position', 'behind patrol', 'behind my car', 'behind cruiser', 'take cover', 'return to patrol', 'back to patrol', 'retreat', 'step back to car', 'return to my', 'back to car', 'at patrol']
                };

                var detectedPos = null;
                for (var pos in positionKeywords) {
                    var keywords = positionKeywords[pos];
                    for (var i = 0; i < keywords.length; i++) {
                        if (text.indexOf(keywords[i]) !== -1) {
                            detectedPos = pos;
                            break;
                        }
                    }
                    if (detectedPos) break;
                }

                if (detectedPos) {
                    // Find and click the corresponding position button
                    var posBtn = document.querySelector('.position-btn[data-pos="' + detectedPos + '"]');
                    if (posBtn && !posBtn.classList.contains('selected')) {
                        posBtn.click();
                    }
                }
            }

            function sendMessage() {
                var input = buildOfficerMessage();
                if (!input.combined || isLoading) return;

                // Auto-detect and update officer position from "Do" text
                detectAndUpdatePosition(input.do);

                inputSay.value = '';
                inputDo.value = '';
                inputRadio.value = '';
                addOfficerMessage(input);

                // Generate autonomous backup action if backup is on scene
                var backupAction = generateBackupAction(input);
                var fullMessage = input.combined;

                if (backupAction) {
                    // Show backup action visually
                    showBackupAction(backupAction);
                    // Include backup action in message to AI
                    var backupText = getBackupActionText(backupAction);
                    if (backupText) {
                        fullMessage += '\n' + backupText;
                    }
                }

                sendToAPI(fullMessage);
            }

            // Restart
            function restart() {
                scenarioSelectSection.style.display = 'block';
                chatSection.style.display = 'none';
                reportSection.classList.remove('active');
                debriefSection.classList.remove('active');
                messages = [];
                messagesContainer.textContent = '';
                updateProgress('select');
                stopTimer();
                timerDisplay.textContent = '0.0s';

                // Hide speech bubbles
                hideSpeechBubbles();

                // Remove backup unit
                removeBackupUnit();

                // Clear report form
                document.getElementById('report-synopsis').value = '';
                document.getElementById('report-call-details').value = '';
                document.getElementById('report-narrative').value = '';
                document.getElementById('report-conclusion').value = '';
                document.getElementById('report-scenario-info').textContent = '';

                // Hide and clear FI card
                document.getElementById('fi-card-tab').style.display = 'none';
                document.getElementById('fi-card-panel').classList.remove('open');
                document.getElementById('fi-card-tab').classList.remove('active');
                var fiFields = document.querySelectorAll('#fi-card-panel input, #fi-card-panel textarea, #fi-card-panel select');
                fiFields.forEach(function(field) {
                    if (field.tagName === 'SELECT') {
                        field.selectedIndex = 0;
                    } else if (field.id === 'fi-state' || field.id === 'fi-dl-state' || field.id === 'fi-plate-state') {
                        field.value = 'AZ';
                    } else {
                        field.value = '';
                    }
                });
            }

            // Event listeners
            document.getElementById('back-btn').addEventListener('click', function() {
                window.location.href = 'index.html';
            });

            document.getElementById('start-scenario-btn').addEventListener('click', startScenario);
            document.getElementById('send-btn').addEventListener('click', sendMessage);
            document.getElementById('end-scenario-btn').addEventListener('click', function() {
                if (!isLoading && messages.length > 1) {
                    showReport();
                }
            });
            document.getElementById('skip-report-btn').addEventListener('click', function() {
                requestDebrief();
            });
            document.getElementById('submit-report-btn').addEventListener('click', function() {
                requestDebrief();
            });
            document.getElementById('debrief-restart-btn').addEventListener('click', restart);

            // FI Card toggle
            var fiCardTab = document.getElementById('fi-card-tab');
            var fiCardPanel = document.getElementById('fi-card-panel');
            var fiCardClose = document.getElementById('fi-card-close');

            function toggleFiCard() {
                fiCardPanel.classList.toggle('open');
                fiCardTab.classList.toggle('active');
            }

            fiCardTab.addEventListener('click', toggleFiCard);
            fiCardClose.addEventListener('click', toggleFiCard);

            // ========== SCENE MANAGEMENT SYSTEM ==========
            var SceneManager = (function() {
                var positionScene = document.getElementById('position-scene');

                // Current scene type and positions
                var currentSceneType = 'traffic';
                var currentPositions = {};

                // Map scenario types to scene types
                var scenarioToScene = {
                    // Traffic scenes
                    'dui': 'traffic',
                    'traffic_warrant': 'traffic',
                    'traffic_drugs': 'traffic',
                    'traffic_suspended': 'traffic',
                    'vehicle_theft': 'traffic',
                    // Domestic scenes (two people - suspect + victim)
                    'domestic': 'domestic',
                    'domestic_weapons': 'domestic',
                    // Residential scenes (single person)
                    'welfare_check': 'residential',
                    'suicide_threat': 'residential',
                    'noise': 'residential',
                    'civil_property': 'residential',
                    'civil_landlord': 'residential',
                    // Custody scene (two parents + child)
                    'civil_custody': 'custody',
                    // Business scenes
                    'shoplifting': 'business',
                    'burglary': 'business',
                    'civil_repo': 'business',
                    'civil_business': 'business',
                    'alarm': 'business',
                    // Bar/venue scenes
                    'disturbance': 'bar',
                    // Fight scenes (two people in conflict)
                    'assault': 'fight',
                    'threats': 'fight',
                    // Outdoor scenes (single person)
                    'trespass': 'outdoor',
                    'loitering': 'outdoor',
                    'mental_crisis': 'outdoor',
                    'intoxicated': 'outdoor',
                    'suspicious': 'outdoor',
                    'harassment': 'outdoor',
                    'stalking': 'outdoor',
                    'theft': 'outdoor'
                };

                // Scene HTML templates
                var sceneTemplates = {
                    traffic: {
                        html: '<div class="road-markings"><div class="lane-dash"></div><div class="lane-dash"></div><div class="lane-dash"></div><div class="lane-dash"></div><div class="lane-dash"></div></div><div class="road-shoulder left"></div><div class="road-shoulder"></div><div class="street-light"></div><div class="road-direction"><svg viewBox="0 0 24 24" stroke-width="2"><path d="M12 19V5M5 12l7-7 7 7"/></svg><span>N</span></div><div class="position-vehicle"><div class="vehicle-wheels"><div class="wheel fl"></div><div class="wheel fr"></div><div class="wheel rl"></div><div class="wheel rr"></div></div><div class="vehicle-hood"><div class="vehicle-headlights"><div class="headlight"></div><div class="headlight"></div></div></div><div class="vehicle-windshield"></div><div class="vehicle-cabin"><div class="vehicle-windows"><div class="vehicle-window"></div><div class="vehicle-window"></div></div><div class="vehicle-label">Suspect</div></div><div class="vehicle-rear-section"></div><div class="vehicle-trunk"><div class="vehicle-taillights"><div class="taillight"></div><div class="taillight"></div></div></div></div><div class="patrol-car draggable" id="my-patrol"><div class="patrol-wheels"><div class="patrol-wheel fl"></div><div class="patrol-wheel fr"></div><div class="patrol-wheel rl"></div><div class="patrol-wheel rr"></div></div><div class="patrol-hood"><div class="patrol-pushbar"></div><div class="patrol-headlights"><div class="patrol-headlight"></div><div class="patrol-headlight"></div></div></div><div class="patrol-windshield"></div><div class="patrol-cabin"><div class="lightbar"></div><div class="patrol-windows"><div class="patrol-window"></div><div class="patrol-window"></div></div><div class="patrol-label">Patrol</div></div><div class="patrol-rear-section"></div><div class="patrol-trunk"><div class="patrol-taillights"><div class="patrol-taillight"></div><div class="patrol-taillight"></div></div></div></div><div class="position-marker subject in-vehicle" id="subject-pos" style="top: 88px; left: calc(12% + 20px);" title="Subject in Vehicle">S</div><div class="position-marker officer" id="officer-pos" style="top: 160px; right: 25%;" title="Your Position"><span>YOU</span><div class="officer-facing" id="officer-facing"><svg viewBox="0 0 24 24" stroke-width="2"><path d="M12 19V5M5 12l7-7 7 7"/></svg></div></div><div class="distance-indicator" id="distance-indicator" style="top: 130px; right: 12%;">~15 ft</div>',
                        legend: '<div class="legend-item"><div class="legend-dot subject"></div><span>Subject</span></div><div class="legend-item"><div class="legend-dot officer"></div><span>You</span></div><div class="legend-item"><div class="legend-dot patrol"></div><span>Patrol</span></div><div class="legend-item"><div class="legend-dot vehicle"></div><span>Suspect Vehicle</span></div>',
                        positions: {
                            'driver-rear': { top: '75px', left: 'calc(18% - 10px)', right: 'auto', facing: 'rotate(45deg)', distance: '~8 ft', distancePos: { top: '55px', left: 'calc(18% + 30px)' }, title: 'Driver Rear', info: '<span>Facing:</span> Toward driver door<br><span>Distance:</span> ~8 feet from subject<br><span>Cover:</span> Limited - exposed to traffic<br><span>Risk:</span> Higher risk - near traffic lane' },
                            'passenger-rear': { top: '100px', left: 'auto', right: '28%', facing: 'rotate(-45deg)', distance: '~15 ft', distancePos: { top: '80px', right: '12%' }, title: 'Passenger Rear', info: '<span>Facing:</span> Toward driver window<br><span>Distance:</span> ~15 feet from subject<br><span>Cover:</span> Engine block protection<br><span>Risk:</span> Recommended - safest approach' },
                            'cover': { top: '180px', left: '22%', right: 'auto', facing: 'rotate(0deg)', distance: '~25 ft', distancePos: { top: '150px', left: '40%' }, title: 'Cover Position', info: '<span>Facing:</span> Toward suspect vehicle<br><span>Distance:</span> ~25 feet from subject<br><span>Cover:</span> Full patrol vehicle protection<br><span>Use:</span> High-risk stops, felony stops' },
                            'contact': { top: '55px', left: 'calc(18% + 58px)', right: 'auto', facing: 'rotate(-90deg)', distance: '~3 ft', distancePos: { top: '35px', left: 'calc(18% + 90px)' }, title: 'Contact Position', info: '<span>Facing:</span> Directly at driver<br><span>Distance:</span> ~3 feet from subject<br><span>Cover:</span> None - fully exposed<br><span>Note:</span> Use after initial assessment' }
                        },
                        buttons: '<button class="position-btn" data-pos="driver-rear">Driver Rear<span class="position-btn-desc">Behind driver door</span></button><button class="position-btn selected" data-pos="passenger-rear">Passenger Rear<span class="position-btn-desc">Safest approach</span></button><button class="position-btn" data-pos="cover">Cover Position<span class="position-btn-desc">Behind patrol car</span></button><button class="position-btn" data-pos="contact">Contact Position<span class="position-btn-desc">At driver window</span></button>',
                        defaultPos: 'passenger-rear'
                    },
                    residential: {
                        html: '<div class="street-residential"></div><div class="curb"></div><div class="yard"></div><div class="sidewalk"></div><div class="house"><div class="house-roof"></div><div class="house-body"><div class="house-window left"></div><div class="house-window right"></div><div class="house-door"><div class="door-knob"></div></div><div class="house-label">Residence</div></div></div><div class="porch" style="top: 120px;"></div><div class="patrol-car draggable" id="my-patrol" style="bottom: 8px; left: 10%;"><div class="patrol-wheels"><div class="patrol-wheel fl"></div><div class="patrol-wheel fr"></div><div class="patrol-wheel rl"></div><div class="patrol-wheel rr"></div></div><div class="patrol-hood"><div class="patrol-pushbar"></div><div class="patrol-headlights"><div class="patrol-headlight"></div><div class="patrol-headlight"></div></div></div><div class="patrol-windshield"></div><div class="patrol-cabin"><div class="lightbar"></div><div class="patrol-windows"><div class="patrol-window"></div><div class="patrol-window"></div></div><div class="patrol-label">Patrol</div></div><div class="patrol-rear-section"></div><div class="patrol-trunk"><div class="patrol-taillights"><div class="patrol-taillight"></div><div class="patrol-taillight"></div></div></div></div><div class="position-marker subject" id="subject-pos" style="top: 130px; left: 50%; transform: translateX(-50%);" title="Subject at Door">S</div><div class="position-marker officer" id="officer-pos" style="top: 200px; left: 35%;" title="Your Position"><span>YOU</span><div class="officer-facing" id="officer-facing"><svg viewBox="0 0 24 24" stroke-width="2"><path d="M12 19V5M5 12l7-7 7 7"/></svg></div></div><div class="distance-indicator" id="distance-indicator" style="top: 165px; left: 42%;">~10 ft</div>',
                        legend: '<div class="legend-item"><div class="legend-dot subject"></div><span>Subject</span></div><div class="legend-item"><div class="legend-dot officer"></div><span>You</span></div><div class="legend-item"><div class="legend-dot patrol"></div><span>Patrol</span></div>',
                        positions: {
                            'approach': { top: '200px', left: '35%', right: 'auto', facing: 'rotate(0deg)', distance: '~10 ft', distancePos: { top: '165px', left: '42%' }, title: 'Approach Position', info: '<span>Facing:</span> Toward front door<br><span>Distance:</span> ~10 feet from door<br><span>Cover:</span> None in open<br><span>Visibility:</span> Full view of door and windows' },
                            'door-left': { top: '130px', left: '38%', right: 'auto', facing: 'rotate(90deg)', distance: '~3 ft', distancePos: { top: '110px', left: '42%' }, title: 'Door Left (Hinge Side)', info: '<span>Facing:</span> Away from door swing<br><span>Distance:</span> ~3 feet from subject<br><span>Cover:</span> Wall provides some cover<br><span>Note:</span> Standard knock-and-talk position' },
                            'door-right': { top: '130px', left: '58%', right: 'auto', facing: 'rotate(-90deg)', distance: '~3 ft', distancePos: { top: '110px', left: '52%' }, title: 'Door Right (Knob Side)', info: '<span>Facing:</span> Toward door opening<br><span>Distance:</span> ~3 feet from subject<br><span>Cover:</span> Limited - in door swing path<br><span>Risk:</span> Higher exposure' },
                            'cover': { top: '230px', left: '15%', right: 'auto', facing: 'rotate(30deg)', distance: '~25 ft', distancePos: { top: '200px', left: '25%' }, title: 'Cover Position', info: '<span>Facing:</span> Toward residence<br><span>Distance:</span> ~25 feet from door<br><span>Cover:</span> Patrol vehicle<br><span>Use:</span> Observe or wait for backup' }
                        },
                        buttons: '<button class="position-btn selected" data-pos="approach">Approach<span class="position-btn-desc">Walking to door</span></button><button class="position-btn" data-pos="door-left">Door Left<span class="position-btn-desc">Hinge side</span></button><button class="position-btn" data-pos="door-right">Door Right<span class="position-btn-desc">Knob side</span></button><button class="position-btn" data-pos="cover">Cover<span class="position-btn-desc">At patrol car</span></button>',
                        defaultPos: 'approach'
                    },
                    business: {
                        html: '<div class="parking-lot"></div><div class="parking-lines"><div class="parking-space"></div><div class="parking-space"></div><div class="parking-space"></div><div class="parking-space"></div></div><div class="store"><div class="store-sign">RETAIL STORE</div><div class="store-front"><div class="store-window"></div><div class="store-door"></div><div class="store-window"></div></div></div><div class="lp-office">LP Office</div><div class="patrol-car draggable" id="my-patrol" style="bottom: 15px; left: 8%;"><div class="patrol-wheels"><div class="patrol-wheel fl"></div><div class="patrol-wheel fr"></div><div class="patrol-wheel rl"></div><div class="patrol-wheel rr"></div></div><div class="patrol-hood"><div class="patrol-pushbar"></div><div class="patrol-headlights"><div class="patrol-headlight"></div><div class="patrol-headlight"></div></div></div><div class="patrol-windshield"></div><div class="patrol-cabin"><div class="lightbar"></div><div class="patrol-windows"><div class="patrol-window"></div><div class="patrol-window"></div></div><div class="patrol-label">Patrol</div></div><div class="patrol-rear-section"></div><div class="patrol-trunk"><div class="patrol-taillights"><div class="patrol-taillight"></div><div class="patrol-taillight"></div></div></div></div><div class="position-marker subject" id="subject-pos" style="top: 130px; left: 50%; transform: translateX(-50%);" title="Subject at Entrance">S</div><div class="position-marker officer" id="officer-pos" style="top: 180px; left: 40%;" title="Your Position"><span>YOU</span><div class="officer-facing" id="officer-facing"><svg viewBox="0 0 24 24" stroke-width="2"><path d="M12 19V5M5 12l7-7 7 7"/></svg></div></div><div class="distance-indicator" id="distance-indicator" style="top: 155px; left: 48%;">~8 ft</div>',
                        legend: '<div class="legend-item"><div class="legend-dot subject"></div><span>Subject</span></div><div class="legend-item"><div class="legend-dot officer"></div><span>You</span></div><div class="legend-item"><div class="legend-dot patrol"></div><span>Patrol</span></div>',
                        positions: {
                            'entrance': { top: '180px', left: '40%', right: 'auto', facing: 'rotate(0deg)', distance: '~8 ft', distancePos: { top: '155px', left: '48%' }, title: 'At Entrance', info: '<span>Facing:</span> Toward store entrance<br><span>Distance:</span> ~8 feet from subject<br><span>Cover:</span> None in parking lot<br><span>Visibility:</span> Full view of entrance' },
                            'inside': { top: '115px', left: '35%', right: 'auto', facing: 'rotate(90deg)', distance: '~5 ft', distancePos: { top: '100px', left: '42%' }, title: 'Inside Store', info: '<span>Facing:</span> Toward subject<br><span>Distance:</span> ~5 feet from subject<br><span>Cover:</span> Aisles/displays<br><span>Note:</span> Maintain reactionary gap' },
                            'lp-office': { top: '130px', left: '75%', right: 'auto', facing: 'rotate(-90deg)', distance: '~15 ft', distancePos: { top: '115px', left: '65%' }, title: 'LP Office', info: '<span>Facing:</span> Toward subject<br><span>Distance:</span> ~15 feet from subject<br><span>Cover:</span> Office walls<br><span>Use:</span> Interview location' },
                            'cover': { top: '220px', left: '12%', right: 'auto', facing: 'rotate(45deg)', distance: '~30 ft', distancePos: { top: '195px', left: '25%' }, title: 'Cover Position', info: '<span>Facing:</span> Toward entrance<br><span>Distance:</span> ~30 feet from subject<br><span>Cover:</span> Patrol vehicle<br><span>Use:</span> Observe or wait for backup' }
                        },
                        buttons: '<button class="position-btn selected" data-pos="entrance">Entrance<span class="position-btn-desc">At store front</span></button><button class="position-btn" data-pos="inside">Inside Store<span class="position-btn-desc">With LP staff</span></button><button class="position-btn" data-pos="lp-office">LP Office<span class="position-btn-desc">Interview area</span></button><button class="position-btn" data-pos="cover">Cover<span class="position-btn-desc">At patrol car</span></button>',
                        defaultPos: 'entrance'
                    },
                    bar: {
                        html: '<div class="parking-lot"></div><div class="bar-building"><div class="bar-sign">BAR & GRILL</div><div class="bar-front"><div class="bouncer-area">SEC</div><div class="bar-door"></div></div></div><div class="crowd-area"><div class="bystander">B</div><div class="bystander">B</div><div class="bystander">B</div></div><div class="patrol-car draggable" id="my-patrol" style="bottom: 15px; left: 8%;"><div class="patrol-wheels"><div class="patrol-wheel fl"></div><div class="patrol-wheel fr"></div><div class="patrol-wheel rl"></div><div class="patrol-wheel rr"></div></div><div class="patrol-hood"><div class="patrol-pushbar"></div><div class="patrol-headlights"><div class="patrol-headlight"></div><div class="patrol-headlight"></div></div></div><div class="patrol-windshield"></div><div class="patrol-cabin"><div class="lightbar"></div><div class="patrol-windows"><div class="patrol-window"></div><div class="patrol-window"></div></div><div class="patrol-label">Patrol</div></div><div class="patrol-rear-section"></div><div class="patrol-trunk"><div class="patrol-taillights"><div class="patrol-taillight"></div><div class="patrol-taillight"></div></div></div></div><div class="position-marker subject" id="subject-pos" style="top: 145px; left: 55%;" title="Intoxicated Subject">S</div><div class="position-marker officer" id="officer-pos" style="top: 190px; left: 35%;" title="Your Position"><span>YOU</span><div class="officer-facing" id="officer-facing"><svg viewBox="0 0 24 24" stroke-width="2"><path d="M12 19V5M5 12l7-7 7 7"/></svg></div></div><div class="distance-indicator" id="distance-indicator" style="top: 165px; left: 45%;">~10 ft</div>',
                        legend: '<div class="legend-item"><div class="legend-dot subject"></div><span>Subject</span></div><div class="legend-item"><div class="legend-dot officer"></div><span>You</span></div><div class="legend-item"><div class="legend-dot" style="background:#666;"></div><span>Bystanders</span></div>',
                        positions: {
                            'approach': { top: '190px', left: '35%', right: 'auto', facing: 'rotate(30deg)', distance: '~10 ft', distancePos: { top: '165px', left: '45%' }, title: 'Approach', info: '<span>Facing:</span> Toward subject<br><span>Distance:</span> ~10 feet from subject<br><span>Cover:</span> None in open<br><span>Note:</span> Watch for crowd reaction' },
                            'contact': { top: '150px', left: '45%', right: 'auto', facing: 'rotate(45deg)', distance: '~5 ft', distancePos: { top: '130px', left: '52%' }, title: 'Contact', info: '<span>Facing:</span> Toward subject<br><span>Distance:</span> ~5 feet from subject<br><span>Cover:</span> None<br><span>Risk:</span> Close to intoxicated subject' },
                            'interview': { top: '180px', left: '70%', right: 'auto', facing: 'rotate(-45deg)', distance: '~8 ft', distancePos: { top: '160px', left: '62%' }, title: 'Interview Area', info: '<span>Facing:</span> Toward subject<br><span>Distance:</span> ~8 feet from crowd<br><span>Cover:</span> Away from crowd<br><span>Use:</span> Separate subject from scene' },
                            'cover': { top: '230px', left: '12%', right: 'auto', facing: 'rotate(45deg)', distance: '~25 ft', distancePos: { top: '205px', left: '25%' }, title: 'Cover Position', info: '<span>Facing:</span> Toward scene<br><span>Distance:</span> ~25 feet from subject<br><span>Cover:</span> Patrol vehicle<br><span>Use:</span> Observe or control crowd' }
                        },
                        buttons: '<button class="position-btn selected" data-pos="approach">Approach<span class="position-btn-desc">Initial contact</span></button><button class="position-btn" data-pos="contact">Contact<span class="position-btn-desc">Close to subject</span></button><button class="position-btn" data-pos="interview">Interview<span class="position-btn-desc">Away from crowd</span></button><button class="position-btn" data-pos="cover">Cover<span class="position-btn-desc">At patrol car</span></button>',
                        defaultPos: 'approach'
                    },
                    outdoor: {
                        html: '<div class="park-ground"></div><div class="park-path"></div><div class="park-bench"></div><div class="tree" style="top: 30px; left: 15%;"><div class="tree-canopy"></div><div class="tree-trunk"></div></div><div class="tree" style="top: 50px; right: 20%;"><div class="tree-canopy"></div><div class="tree-trunk"></div></div><div class="streetlight" style="top: 20px; right: 35%;"><div class="streetlight-lamp"></div><div class="streetlight-pole"></div></div><div class="patrol-car draggable" id="my-patrol" style="bottom: 15px; left: 8%;"><div class="patrol-wheels"><div class="patrol-wheel fl"></div><div class="patrol-wheel fr"></div><div class="patrol-wheel rl"></div><div class="patrol-wheel rr"></div></div><div class="patrol-hood"><div class="patrol-pushbar"></div><div class="patrol-headlights"><div class="patrol-headlight"></div><div class="patrol-headlight"></div></div></div><div class="patrol-windshield"></div><div class="patrol-cabin"><div class="lightbar"></div><div class="patrol-windows"><div class="patrol-window"></div><div class="patrol-window"></div></div><div class="patrol-label">Patrol</div></div><div class="patrol-rear-section"></div><div class="patrol-trunk"><div class="patrol-taillights"><div class="patrol-taillight"></div><div class="patrol-taillight"></div></div></div></div><div class="position-marker subject" id="subject-pos" style="top: 90px; left: 35%;" title="Subject on Bench">S</div><div class="position-marker officer" id="officer-pos" style="top: 160px; left: 50%;" title="Your Position"><span>YOU</span><div class="officer-facing" id="officer-facing"><svg viewBox="0 0 24 24" stroke-width="2"><path d="M12 19V5M5 12l7-7 7 7"/></svg></div></div><div class="distance-indicator" id="distance-indicator" style="top: 125px; left: 42%;">~15 ft</div>',
                        legend: '<div class="legend-item"><div class="legend-dot subject"></div><span>Subject</span></div><div class="legend-item"><div class="legend-dot officer"></div><span>You</span></div><div class="legend-item"><div class="legend-dot patrol"></div><span>Patrol</span></div>',
                        positions: {
                            'approach': { top: '160px', left: '50%', right: 'auto', facing: 'rotate(-30deg)', distance: '~15 ft', distancePos: { top: '125px', left: '42%' }, title: 'Approach', info: '<span>Facing:</span> Toward subject<br><span>Distance:</span> ~15 feet from subject<br><span>Cover:</span> None in open<br><span>Visibility:</span> Full view of subject' },
                            'contact': { top: '100px', left: '50%', right: 'auto', facing: 'rotate(-90deg)', distance: '~6 ft', distancePos: { top: '80px', left: '42%' }, title: 'Contact', info: '<span>Facing:</span> Toward subject<br><span>Distance:</span> ~6 feet from subject<br><span>Cover:</span> None<br><span>Note:</span> Maintain reactionary gap' },
                            'flank': { top: '90px', left: '60%', right: 'auto', facing: 'rotate(-135deg)', distance: '~8 ft', distancePos: { top: '75px', left: '52%' }, title: 'Flank Position', info: '<span>Facing:</span> Toward subject from side<br><span>Distance:</span> ~8 feet from subject<br><span>Cover:</span> None<br><span>Use:</span> Better angle of observation' },
                            'cover': { top: '220px', left: '12%', right: 'auto', facing: 'rotate(30deg)', distance: '~30 ft', distancePos: { top: '190px', left: '25%' }, title: 'Cover Position', info: '<span>Facing:</span> Toward subject<br><span>Distance:</span> ~30 feet from subject<br><span>Cover:</span> Patrol vehicle<br><span>Use:</span> Observe or wait for backup' }
                        },
                        buttons: '<button class="position-btn selected" data-pos="approach">Approach<span class="position-btn-desc">Walking toward</span></button><button class="position-btn" data-pos="contact">Contact<span class="position-btn-desc">Face to face</span></button><button class="position-btn" data-pos="flank">Flank<span class="position-btn-desc">Side approach</span></button><button class="position-btn" data-pos="cover">Cover<span class="position-btn-desc">At patrol car</span></button>',
                        defaultPos: 'approach'
                    },
                    // Domestic scene - two people at residence
                    domestic: {
                        html: '<div class="street-residential"></div><div class="curb"></div><div class="yard"></div><div class="sidewalk"></div><div class="house"><div class="house-roof"></div><div class="house-body"><div class="house-window left"></div><div class="house-window right"></div><div class="house-door"><div class="door-knob"></div></div><div class="house-label">Residence</div></div></div><div class="porch" style="top: 120px;"></div><div class="patrol-car draggable" id="my-patrol" style="bottom: 8px; left: 10%;"><div class="patrol-wheels"><div class="patrol-wheel fl"></div><div class="patrol-wheel fr"></div><div class="patrol-wheel rl"></div><div class="patrol-wheel rr"></div></div><div class="patrol-hood"><div class="patrol-pushbar"></div><div class="patrol-headlights"><div class="patrol-headlight"></div><div class="patrol-headlight"></div></div></div><div class="patrol-windshield"></div><div class="patrol-cabin"><div class="lightbar"></div><div class="patrol-windows"><div class="patrol-window"></div><div class="patrol-window"></div></div><div class="patrol-label">Patrol</div></div><div class="patrol-rear-section"></div><div class="patrol-trunk"><div class="patrol-taillights"><div class="patrol-taillight"></div><div class="patrol-taillight"></div></div></div></div><div class="position-marker subject" id="subject-pos" style="top: 125px; left: 42%;" title="Party 1">S1</div><div class="position-marker person2" id="subject2-pos" style="top: 125px; left: 58%;" title="Party 2" data-label="PARTY 2">S2</div><div class="position-marker officer" id="officer-pos" style="top: 200px; left: 35%;" title="Your Position"><span>YOU</span><div class="officer-facing" id="officer-facing"><svg viewBox="0 0 24 24" stroke-width="2"><path d="M12 19V5M5 12l7-7 7 7"/></svg></div></div><div class="distance-indicator" id="distance-indicator" style="top: 165px; left: 42%;">~10 ft</div>',
                        legend: '<div class="legend-item"><div class="legend-dot subject"></div><span>Party 1</span></div><div class="legend-item"><div class="legend-dot" style="background:#60a5fa;border-color:#60a5fa;"></div><span>Party 2</span></div><div class="legend-item"><div class="legend-dot officer"></div><span>You</span></div>',
                        positions: {
                            'approach': { top: '200px', left: '35%', right: 'auto', facing: 'rotate(0deg)', distance: '~10 ft', distancePos: { top: '165px', left: '42%' }, title: 'Approach Position', info: '<span>Facing:</span> Toward front door<br><span>Distance:</span> ~10 feet from door<br><span>Cover:</span> None in open<br><span>Note:</span> Can see both parties' },
                            'door-left': { top: '130px', left: '35%', right: 'auto', facing: 'rotate(90deg)', distance: '~5 ft', distancePos: { top: '110px', left: '40%' }, title: 'Near Party 1', info: '<span>Facing:</span> Toward Party 1<br><span>Distance:</span> ~5 feet<br><span>Cover:</span> Wall provides some cover<br><span>Note:</span> Position to separate parties' },
                            'door-right': { top: '130px', left: '62%', right: 'auto', facing: 'rotate(-90deg)', distance: '~5 ft', distancePos: { top: '110px', left: '55%' }, title: 'Near Party 2', info: '<span>Facing:</span> Toward Party 2<br><span>Distance:</span> ~5 feet<br><span>Cover:</span> Limited<br><span>Note:</span> Good for interview' },
                            'cover': { top: '230px', left: '15%', right: 'auto', facing: 'rotate(30deg)', distance: '~25 ft', distancePos: { top: '200px', left: '25%' }, title: 'Cover Position', info: '<span>Facing:</span> Toward residence<br><span>Distance:</span> ~25 feet from door<br><span>Cover:</span> Patrol vehicle<br><span>Use:</span> Wait for backup on weapons calls' }
                        },
                        buttons: '<button class="position-btn selected" data-pos="approach">Approach<span class="position-btn-desc">Walking to door</span></button><button class="position-btn" data-pos="door-left">Near P1<span class="position-btn-desc">Left side</span></button><button class="position-btn" data-pos="door-right">Near P2<span class="position-btn-desc">Right side</span></button><button class="position-btn" data-pos="cover">Cover<span class="position-btn-desc">At patrol car</span></button>',
                        defaultPos: 'approach'
                    },
                    // Fight/assault scene - two people in conflict
                    fight: {
                        html: '<div class="parking-lot"></div><div class="parking-lines"><div class="parking-space"></div><div class="parking-space"></div><div class="parking-space"></div><div class="parking-space"></div></div><div class="store"><div class="store-sign">CIRCLE K</div><div class="store-front"><div class="store-window"></div><div class="store-door"></div><div class="store-window"></div></div></div><div class="crowd-area" style="top: 80px; right: 10%;"><div class="bystander">B</div><div class="bystander">B</div></div><div class="patrol-car draggable" id="my-patrol" style="bottom: 15px; left: 8%;"><div class="patrol-wheels"><div class="patrol-wheel fl"></div><div class="patrol-wheel fr"></div><div class="patrol-wheel rl"></div><div class="patrol-wheel rr"></div></div><div class="patrol-hood"><div class="patrol-pushbar"></div><div class="patrol-headlights"><div class="patrol-headlight"></div><div class="patrol-headlight"></div></div></div><div class="patrol-windshield"></div><div class="patrol-cabin"><div class="lightbar"></div><div class="patrol-windows"><div class="patrol-window"></div><div class="patrol-window"></div></div><div class="patrol-label">Patrol</div></div><div class="patrol-rear-section"></div><div class="patrol-trunk"><div class="patrol-taillights"><div class="patrol-taillight"></div><div class="patrol-taillight"></div></div></div></div><div class="position-marker subject" id="subject-pos" style="top: 140px; left: 40%;" title="Subject 1">S1</div><div class="position-marker subject2" id="subject2-pos" style="top: 140px; left: 55%;" title="Subject 2" data-label="PARTY 2">S2</div><div class="position-marker officer" id="officer-pos" style="top: 200px; left: 48%;" title="Your Position"><span>YOU</span><div class="officer-facing" id="officer-facing"><svg viewBox="0 0 24 24" stroke-width="2"><path d="M12 19V5M5 12l7-7 7 7"/></svg></div></div><div class="distance-indicator" id="distance-indicator" style="top: 170px; left: 45%;">~10 ft</div>',
                        legend: '<div class="legend-item"><div class="legend-dot subject"></div><span>Party 1</span></div><div class="legend-item"><div class="legend-dot" style="background:#fb923c;border-color:#fb923c;"></div><span>Party 2</span></div><div class="legend-item"><div class="legend-dot officer"></div><span>You</span></div><div class="legend-item"><div class="legend-dot" style="background:#666;"></div><span>Bystanders</span></div>',
                        positions: {
                            'approach': { top: '200px', left: '48%', right: 'auto', facing: 'rotate(0deg)', distance: '~10 ft', distancePos: { top: '170px', left: '45%' }, title: 'Approach', info: '<span>Facing:</span> Toward both subjects<br><span>Distance:</span> ~10 feet from conflict<br><span>Cover:</span> None<br><span>Note:</span> Command presence position' },
                            'between': { top: '145px', left: '48%', right: 'auto', facing: 'rotate(0deg)', distance: '~3 ft', distancePos: { top: '125px', left: '45%' }, title: 'Between Parties', info: '<span>Facing:</span> Can see both<br><span>Distance:</span> ~3 feet from each<br><span>Cover:</span> None<br><span>Risk:</span> High - between combatants' },
                            'flank-left': { top: '145px', left: '30%', right: 'auto', facing: 'rotate(45deg)', distance: '~5 ft', distancePos: { top: '125px', left: '35%' }, title: 'Flank Left', info: '<span>Facing:</span> Toward Party 1<br><span>Distance:</span> ~5 feet from Party 1<br><span>Cover:</span> None<br><span>Use:</span> Focus on primary aggressor' },
                            'cover': { top: '230px', left: '12%', right: 'auto', facing: 'rotate(30deg)', distance: '~25 ft', distancePos: { top: '200px', left: '25%' }, title: 'Cover Position', info: '<span>Facing:</span> Toward scene<br><span>Distance:</span> ~25 feet<br><span>Cover:</span> Patrol vehicle<br><span>Use:</span> Give commands from distance' }
                        },
                        buttons: '<button class="position-btn selected" data-pos="approach">Approach<span class="position-btn-desc">Initial contact</span></button><button class="position-btn" data-pos="between">Between<span class="position-btn-desc">Separate parties</span></button><button class="position-btn" data-pos="flank-left">Flank Left<span class="position-btn-desc">Near Party 1</span></button><button class="position-btn" data-pos="cover">Cover<span class="position-btn-desc">At patrol car</span></button>',
                        defaultPos: 'approach'
                    },
                    // Custody exchange scene - two parents
                    custody: {
                        html: '<div class="parking-lot"></div><div class="parking-lines"><div class="parking-space"></div><div class="parking-space"></div><div class="parking-space"></div></div><div class="store"><div class="store-sign">McDONALDS</div><div class="store-front"><div class="store-window"></div><div class="store-door"></div><div class="store-window"></div></div></div><div class="civilian-car" style="position: absolute; top: 60px; left: 20%; width: 50px; height: 25px; background: #4a5568; border-radius: 4px;"><div style="font-size: 0.5rem; color: #a0aec0; text-align: center; padding-top: 5px;">CAR</div></div><div class="civilian-car" style="position: absolute; top: 60px; right: 20%; width: 50px; height: 25px; background: #718096; border-radius: 4px;"><div style="font-size: 0.5rem; color: #a0aec0; text-align: center; padding-top: 5px;">CAR</div></div><div class="patrol-car draggable" id="my-patrol" style="bottom: 15px; left: 8%;"><div class="patrol-wheels"><div class="patrol-wheel fl"></div><div class="patrol-wheel fr"></div><div class="patrol-wheel rl"></div><div class="patrol-wheel rr"></div></div><div class="patrol-hood"><div class="patrol-pushbar"></div><div class="patrol-headlights"><div class="patrol-headlight"></div><div class="patrol-headlight"></div></div></div><div class="patrol-windshield"></div><div class="patrol-cabin"><div class="lightbar"></div><div class="patrol-windows"><div class="patrol-window"></div><div class="patrol-window"></div></div><div class="patrol-label">Patrol</div></div><div class="patrol-rear-section"></div><div class="patrol-trunk"><div class="patrol-taillights"><div class="patrol-taillight"></div><div class="patrol-taillight"></div></div></div></div><div class="position-marker subject" id="subject-pos" style="top: 100px; left: 30%;" title="Parent 1 (Has Child)">P1</div><div class="position-marker subject2" id="subject2-pos" style="top: 100px; left: 65%;" title="Parent 2" data-label="PARENT 2">P2</div><div class="position-marker" style="top: 100px; left: 38%; width: 24px; height: 24px; font-size: 0.6rem; background: rgba(167, 139, 250, 0.25); border: 2px solid #a78bfa; color: #a78bfa;" title="Child">C</div><div class="position-marker officer" id="officer-pos" style="top: 170px; left: 48%;" title="Your Position"><span>YOU</span><div class="officer-facing" id="officer-facing"><svg viewBox="0 0 24 24" stroke-width="2"><path d="M12 19V5M5 12l7-7 7 7"/></svg></div></div><div class="distance-indicator" id="distance-indicator" style="top: 135px; left: 45%;">~12 ft</div>',
                        legend: '<div class="legend-item"><div class="legend-dot subject"></div><span>Parent 1</span></div><div class="legend-item"><div class="legend-dot" style="background:#fb923c;border-color:#fb923c;"></div><span>Parent 2</span></div><div class="legend-item"><div class="legend-dot" style="background:#a78bfa;border-color:#a78bfa;"></div><span>Child</span></div><div class="legend-item"><div class="legend-dot officer"></div><span>You</span></div>',
                        positions: {
                            'center': { top: '170px', left: '48%', right: 'auto', facing: 'rotate(0deg)', distance: '~12 ft', distancePos: { top: '135px', left: '45%' }, title: 'Center Position', info: '<span>Facing:</span> Both parties visible<br><span>Distance:</span> ~12 feet from both<br><span>Cover:</span> None<br><span>Note:</span> Neutral mediator position' },
                            'near-p1': { top: '120px', left: '25%', right: 'auto', facing: 'rotate(45deg)', distance: '~5 ft', distancePos: { top: '100px', left: '30%' }, title: 'Near Parent 1', info: '<span>Facing:</span> Toward Parent 1 and child<br><span>Distance:</span> ~5 feet<br><span>Cover:</span> None<br><span>Use:</span> Interview custodial parent' },
                            'near-p2': { top: '120px', left: '70%', right: 'auto', facing: 'rotate(-45deg)', distance: '~5 ft', distancePos: { top: '100px', left: '62%' }, title: 'Near Parent 2', info: '<span>Facing:</span> Toward Parent 2<br><span>Distance:</span> ~5 feet<br><span>Cover:</span> None<br><span>Use:</span> Interview requesting parent' },
                            'cover': { top: '220px', left: '12%', right: 'auto', facing: 'rotate(30deg)', distance: '~25 ft', distancePos: { top: '190px', left: '25%' }, title: 'Cover Position', info: '<span>Facing:</span> Toward scene<br><span>Distance:</span> ~25 feet<br><span>Cover:</span> Patrol vehicle<br><span>Use:</span> Review court documents' }
                        },
                        buttons: '<button class="position-btn selected" data-pos="center">Center<span class="position-btn-desc">Between both</span></button><button class="position-btn" data-pos="near-p1">Near P1<span class="position-btn-desc">Custodial parent</span></button><button class="position-btn" data-pos="near-p2">Near P2<span class="position-btn-desc">Other parent</span></button><button class="position-btn" data-pos="cover">Cover<span class="position-btn-desc">At patrol car</span></button>',
                        defaultPos: 'center'
                    }
                };

                // Scene is now always visible - no toggle needed

                // Load a scene by type
                function loadScene(sceneType) {
                    var template = sceneTemplates[sceneType] || sceneTemplates.traffic;
                    currentSceneType = sceneType;
                    currentPositions = template.positions;

                    // Update scene HTML and add speech bubbles + dispatcher
                    if (positionScene) {
                        positionScene.className = 'position-scene scene-' + sceneType;
                        positionScene.innerHTML = template.html +
                            '<div class="speech-bubble subject-bubble" id="subject-speech" style="display: none;">' +
                                '<div class="bubble-label">Subject</div>' +
                                '<div class="bubble-text" id="subject-speech-text"></div>' +
                            '</div>' +
                            '<div class="speech-bubble officer-bubble" id="officer-speech" style="display: none;">' +
                                '<div class="bubble-label">You</div>' +
                                '<div class="bubble-text" id="officer-speech-text"></div>' +
                            '</div>' +
                            '<div class="dispatcher-element" id="dispatcher-element">' +
                                '<div class="dispatcher-avatar" id="dispatcher-avatar">ðŸ‘©â€ðŸ’¼</div>' +
                                '<div class="dispatcher-label">Dispatch</div>' +
                                '<div class="dispatcher-bubble" id="dispatcher-bubble">' +
                                    '<div class="dispatch-text" id="dispatch-text"></div>' +
                                    '<div class="dispatch-time" id="dispatch-time"></div>' +
                                '</div>' +
                            '</div>';
                    }

                    // Update position buttons in scene-controls
                    var sceneControls = document.getElementById('scene-controls');
                    if (sceneControls) {
                        // Create compact button HTML
                        var compactButtons = '';
                        Object.keys(template.positions).forEach(function(posKey) {
                            var pos = template.positions[posKey];
                            var isDefault = posKey === template.defaultPos;
                            compactButtons += '<button class="position-btn' + (isDefault ? ' selected' : '') + '" data-pos="' + posKey + '">' + pos.title.replace(' Position', '').replace('At ', '') + '</button>';
                        });
                        sceneControls.innerHTML = compactButtons;
                        // Rebind click handlers
                        bindPositionButtons();
                    }

                    // Set default position
                    var defaultBtn = document.querySelector('.position-btn[data-pos="' + template.defaultPos + '"]');
                    if (defaultBtn) {
                        defaultBtn.click();
                    }
                }

                // Bind position button click handlers
                function bindPositionButtons() {
                    document.querySelectorAll('.position-btn').forEach(function(btn) {
                        btn.addEventListener('click', function(e) {
                            e.preventDefault();
                            e.stopPropagation();
                            var pos = this.getAttribute('data-pos');

                            // Update button states
                            document.querySelectorAll('.position-btn').forEach(function(b) {
                                b.classList.remove('selected');
                            });
                            this.classList.add('selected');

                            // Get current position data
                            var posData = currentPositions[pos];
                            if (!posData) return;

                            // Get elements (they may have been replaced)
                            var officerMarker = document.getElementById('officer-pos');
                            var officerFacing = document.getElementById('officer-facing');
                            var positionInfo = document.getElementById('position-info');
                            var distanceIndicator = document.getElementById('distance-indicator');

                            // Update officer position
                            if (officerMarker) {
                                officerMarker.style.top = posData.top;
                                officerMarker.style.left = posData.left;
                                officerMarker.style.right = posData.right;

                                // Flash the marker
                                officerMarker.classList.add('active');
                                setTimeout(function() {
                                    officerMarker.classList.remove('active');
                                }, 500);
                            }

                            // Update facing direction
                            if (officerFacing) {
                                officerFacing.style.transform = posData.facing;
                            }

                            // Update distance indicator
                            if (distanceIndicator) {
                                distanceIndicator.textContent = posData.distance;
                                if (posData.distancePos.left) {
                                    distanceIndicator.style.left = posData.distancePos.left;
                                    distanceIndicator.style.right = 'auto';
                                } else if (posData.distancePos.right) {
                                    distanceIndicator.style.right = posData.distancePos.right;
                                    distanceIndicator.style.left = 'auto';
                                }
                                distanceIndicator.style.top = posData.distancePos.top;
                            }

                            // Update position info panel (new compact layout)
                            var positionTitle = document.getElementById('position-info-title');
                            var positionDetail = document.getElementById('position-info-detail');
                            if (positionTitle) positionTitle.textContent = posData.title;
                            if (positionDetail) positionDetail.textContent = posData.distance + ' from subject';
                        });
                    });
                }

                // Get scene type for a scenario
                function getSceneType(scenarioType) {
                    return scenarioToScene[scenarioType] || 'traffic';
                }

                // Initialize with traffic scene
                loadScene('traffic');

                // Public API
                return {
                    loadScene: loadScene,
                    getSceneType: getSceneType,
                    loadSceneForScenario: function(scenarioType) {
                        var sceneType = getSceneType(scenarioType);
                        loadScene(sceneType);
                    }
                };
            })();

            // ========== DRAG AND DROP FOR OFFICER MARKER ==========
            (function() {
                var isDragging = false;
                var dragOffsetX = 0;
                var dragOffsetY = 0;

                function getOfficerMarker() {
                    return document.getElementById('officer-pos');
                }

                function getPositionScene() {
                    return document.getElementById('position-scene');
                }

                function getSubjectMarker() {
                    return document.getElementById('subject-pos');
                }

                // Calculate distance between officer and subject
                function calculateDistance(officerEl, subjectEl, sceneEl) {
                    if (!officerEl || !subjectEl || !sceneEl) return null;

                    var sceneRect = sceneEl.getBoundingClientRect();
                    var officerRect = officerEl.getBoundingClientRect();
                    var subjectRect = subjectEl.getBoundingClientRect();

                    // Get center points relative to scene
                    var officerX = (officerRect.left + officerRect.width/2) - sceneRect.left;
                    var officerY = (officerRect.top + officerRect.height/2) - sceneRect.top;
                    var subjectX = (subjectRect.left + subjectRect.width/2) - sceneRect.left;
                    var subjectY = (subjectRect.top + subjectRect.height/2) - sceneRect.top;

                    // Calculate pixel distance
                    var pixelDist = Math.sqrt(Math.pow(officerX - subjectX, 2) + Math.pow(officerY - subjectY, 2));

                    // Convert to approximate feet (assuming scene is ~50 feet wide)
                    var sceneWidthFeet = 50;
                    var feetPerPixel = sceneWidthFeet / sceneRect.width;
                    var distFeet = Math.round(pixelDist * feetPerPixel);

                    return distFeet;
                }

                // Update distance indicator
                function updateDistanceIndicator(officerEl, subjectEl, sceneEl) {
                    var distanceEl = document.getElementById('distance-indicator');
                    if (!distanceEl) return;

                    var dist = calculateDistance(officerEl, subjectEl, sceneEl);
                    if (dist !== null) {
                        distanceEl.textContent = '~' + dist + ' ft';

                        // Position the indicator between officer and subject
                        var sceneRect = sceneEl.getBoundingClientRect();
                        var officerRect = officerEl.getBoundingClientRect();
                        var subjectRect = subjectEl.getBoundingClientRect();

                        var midX = ((officerRect.left + officerRect.width/2) + (subjectRect.left + subjectRect.width/2)) / 2 - sceneRect.left;
                        var midY = ((officerRect.top + officerRect.height/2) + (subjectRect.top + subjectRect.height/2)) / 2 - sceneRect.top;

                        distanceEl.style.left = midX + 'px';
                        distanceEl.style.top = midY + 'px';
                        distanceEl.style.right = 'auto';
                        distanceEl.style.transform = 'translate(-50%, -50%)';
                    }
                }

                // Update position info for custom position
                function updateCustomPositionInfo(dist) {
                    var positionInfo = document.getElementById('position-info');
                    if (!positionInfo) return;

                    var titleEl = positionInfo.querySelector('.position-info-title');
                    var detailEl = positionInfo.querySelector('.position-info-detail');

                    if (titleEl) titleEl.textContent = 'Custom Position';

                    var coverStatus = 'None - open area';
                    var riskLevel = 'Assess your surroundings';
                    if (dist > 20) {
                        coverStatus = 'Distance provides reaction time';
                        riskLevel = 'Good standoff distance';
                    } else if (dist < 6) {
                        riskLevel = 'Close contact - stay alert';
                    }

                    if (detailEl) {
                        detailEl.innerHTML = '<span>Distance:</span> ~' + dist + ' feet from subject<br><span>Cover:</span> ' + coverStatus + '<br><span>Note:</span> ' + riskLevel;
                    }

                    // Deselect position buttons
                    document.querySelectorAll('.position-btn').forEach(function(btn) {
                        btn.classList.remove('selected');
                    });
                }

                // Mouse/Touch start
                function onDragStart(e) {
                    var officer = getOfficerMarker();
                    if (!officer) return;

                    e.preventDefault();
                    e.stopPropagation();

                    isDragging = true;
                    officer.classList.add('dragging');

                    var rect = officer.getBoundingClientRect();
                    var clientX = e.type.includes('touch') ? e.touches[0].clientX : e.clientX;
                    var clientY = e.type.includes('touch') ? e.touches[0].clientY : e.clientY;

                    dragOffsetX = clientX - rect.left - rect.width/2;
                    dragOffsetY = clientY - rect.top - rect.height/2;

                    document.addEventListener('mousemove', onDragMove);
                    document.addEventListener('mouseup', onDragEnd);
                    document.addEventListener('touchmove', onDragMove, { passive: false });
                    document.addEventListener('touchend', onDragEnd);
                }

                // Mouse/Touch move
                function onDragMove(e) {
                    if (!isDragging) return;

                    e.preventDefault();

                    var officer = getOfficerMarker();
                    var scene = getPositionScene();
                    var subject = getSubjectMarker();
                    if (!officer || !scene) return;

                    var sceneRect = scene.getBoundingClientRect();
                    var clientX = e.type.includes('touch') ? e.touches[0].clientX : e.clientX;
                    var clientY = e.type.includes('touch') ? e.touches[0].clientY : e.clientY;

                    // Calculate new position relative to scene
                    var newX = clientX - sceneRect.left - dragOffsetX - 18; // 18 = half marker width
                    var newY = clientY - sceneRect.top - dragOffsetY - 18;

                    // Constrain to scene bounds
                    var maxX = sceneRect.width - 36;
                    var maxY = sceneRect.height - 36;
                    newX = Math.max(0, Math.min(newX, maxX));
                    newY = Math.max(0, Math.min(newY, maxY));

                    // Apply position
                    officer.style.left = newX + 'px';
                    officer.style.top = newY + 'px';
                    officer.style.right = 'auto';
                    officer.style.transform = 'none';

                    // Update distance indicator in real-time
                    updateDistanceIndicator(officer, subject, scene);
                }

                // Mouse/Touch end
                function onDragEnd(e) {
                    if (!isDragging) return;

                    isDragging = false;

                    var officer = getOfficerMarker();
                    var scene = getPositionScene();
                    var subject = getSubjectMarker();

                    if (officer) {
                        officer.classList.remove('dragging');

                        // Flash to confirm drop
                        officer.classList.add('active');
                        setTimeout(function() {
                            officer.classList.remove('active');
                        }, 300);
                    }

                    // Update position info
                    if (officer && subject && scene) {
                        var dist = calculateDistance(officer, subject, scene);
                        if (dist !== null) {
                            updateCustomPositionInfo(dist);
                        }
                    }

                    document.removeEventListener('mousemove', onDragMove);
                    document.removeEventListener('mouseup', onDragEnd);
                    document.removeEventListener('touchmove', onDragMove);
                    document.removeEventListener('touchend', onDragEnd);
                }

                // Bind drag events to main officer marker only (not backup)
                document.addEventListener('mousedown', function(e) {
                    var marker = e.target.closest('.position-marker.officer');
                    if (marker && marker.id === 'officer-pos') {
                        onDragStart(e);
                    }
                });

                document.addEventListener('touchstart', function(e) {
                    var marker = e.target.closest('.position-marker.officer');
                    if (marker && marker.id === 'officer-pos') {
                        onDragStart(e);
                    }
                }, { passive: false });
            })();

            // ========== PATROL CAR & BACKUP UNIT DRAG ==========
            (function() {
                var dragTarget = null;
                var isDragging = false;
                var dragOffsetX = 0;
                var dragOffsetY = 0;

                function onDragStart(e, target) {
                    e.preventDefault();
                    e.stopPropagation();

                    dragTarget = target;
                    isDragging = true;
                    target.classList.add('dragging');

                    var rect = target.getBoundingClientRect();
                    var clientX = e.type.includes('touch') ? e.touches[0].clientX : e.clientX;
                    var clientY = e.type.includes('touch') ? e.touches[0].clientY : e.clientY;

                    dragOffsetX = clientX - rect.left;
                    dragOffsetY = clientY - rect.top;

                    document.addEventListener('mousemove', onDragMove);
                    document.addEventListener('mouseup', onDragEnd);
                    document.addEventListener('touchmove', onDragMove, { passive: false });
                    document.addEventListener('touchend', onDragEnd);
                }

                function onDragMove(e) {
                    if (!isDragging || !dragTarget) return;
                    e.preventDefault();

                    var scene = document.getElementById('position-scene');
                    if (!scene) return;

                    var sceneRect = scene.getBoundingClientRect();
                    var clientX = e.type.includes('touch') ? e.touches[0].clientX : e.clientX;
                    var clientY = e.type.includes('touch') ? e.touches[0].clientY : e.clientY;

                    var newX = clientX - sceneRect.left - dragOffsetX;
                    var newY = clientY - sceneRect.top - dragOffsetY;

                    // Constrain to scene bounds
                    var targetRect = dragTarget.getBoundingClientRect();
                    var maxX = sceneRect.width - targetRect.width;
                    var maxY = sceneRect.height - targetRect.height;
                    newX = Math.max(0, Math.min(newX, maxX));
                    newY = Math.max(0, Math.min(newY, maxY));

                    // Apply position
                    dragTarget.style.left = newX + 'px';
                    dragTarget.style.top = newY + 'px';
                    dragTarget.style.right = 'auto';
                    dragTarget.style.bottom = 'auto';
                    dragTarget.style.transform = 'none';
                }

                function onDragEnd() {
                    if (dragTarget) {
                        dragTarget.classList.remove('dragging');
                    }
                    isDragging = false;
                    dragTarget = null;

                    document.removeEventListener('mousemove', onDragMove);
                    document.removeEventListener('mouseup', onDragEnd);
                    document.removeEventListener('touchmove', onDragMove);
                    document.removeEventListener('touchend', onDragEnd);
                }

                // Bind to patrol cars and backup officer
                document.addEventListener('mousedown', function(e) {
                    var patrolCar = e.target.closest('.patrol-car.draggable');
                    var backupOfficer = e.target.closest('#backup-pos');
                    if (patrolCar) {
                        onDragStart(e, patrolCar);
                    } else if (backupOfficer) {
                        onDragStart(e, backupOfficer);
                    }
                });

                document.addEventListener('touchstart', function(e) {
                    var patrolCar = e.target.closest('.patrol-car.draggable');
                    var backupOfficer = e.target.closest('#backup-pos');
                    if (patrolCar) {
                        onDragStart(e, patrolCar);
                    } else if (backupOfficer) {
                        onDragStart(e, backupOfficer);
                    }
                }, { passive: false });
            })();

            // ========== BACKUP OFFICER ACTION MENU ==========
            (function() {
                var backupMenu = null;
                var isBackupMenuOpen = false;
                var backupWeapon = null;
                var clickStartTime = 0;
                var clickStartPos = { x: 0, y: 0 };

                function createBackupMenu() {
                    var menu = document.createElement('div');
                    menu.className = 'backup-action-menu';
                    menu.id = 'backup-action-menu';
                    menu.innerHTML = `
                        <div class="backup-menu-header">Backup Officer</div>
                        <div class="backup-command-section">
                            <label>Give Command</label>
                            <textarea id="backup-command-input" placeholder="Tell backup what to do..." rows="2"></textarea>
                            <button class="backup-command-send" id="backup-command-send">Send Command</button>
                        </div>
                        <div class="backup-menu-divider"></div>
                        <div class="backup-menu-section">Deploy Weapon</div>
                        <div class="backup-weapon-grid">
                            <button class="officer-weapon-btn pepperball" data-weapon="pepperball">
                                <span class="weapon-icon">ðŸ”´</span>
                                <span>Pepper Ball</span>
                            </button>
                            <button class="officer-weapon-btn fortymm" data-weapon="40mm">
                                <span class="weapon-icon">ðŸ’¥</span>
                                <span>40mm</span>
                            </button>
                            <button class="officer-weapon-btn rifle" data-weapon="rifle">
                                <span class="weapon-icon">ðŸ”«</span>
                                <span>Rifle</span>
                            </button>
                        </div>
                    `;
                    document.body.appendChild(menu);
                    return menu;
                }

                function getBackupMenu() {
                    if (!backupMenu) {
                        backupMenu = document.getElementById('backup-action-menu') || createBackupMenu();
                    }
                    return backupMenu;
                }

                function showBackupMenu(x, y) {
                    var menu = getBackupMenu();
                    menu.style.left = x + 'px';
                    menu.style.top = y + 'px';
                    menu.classList.add('visible');
                    isBackupMenuOpen = true;

                    // Adjust if off screen
                    setTimeout(function() {
                        var rect = menu.getBoundingClientRect();
                        if (rect.right > window.innerWidth) {
                            menu.style.left = (x - rect.width) + 'px';
                        }
                        if (rect.bottom > window.innerHeight) {
                            menu.style.top = (y - rect.height) + 'px';
                        }
                    }, 0);
                }

                function hideBackupMenu() {
                    var menu = getBackupMenu();
                    menu.classList.remove('visible');
                    isBackupMenuOpen = false;
                }

                function handleBackupWeapon(weapon) {
                    var inputDo = document.getElementById('input-do');
                    var allBtns = document.querySelectorAll('.backup-action-menu .officer-weapon-btn');

                    // Toggle off if clicking same weapon
                    if (backupWeapon === weapon) {
                        backupWeapon = null;
                        allBtns.forEach(function(btn) { btn.classList.remove('selected'); });
                        if (inputDo) {
                            inputDo.value = 'Backup holsters weapon';
                        }
                    } else {
                        backupWeapon = weapon;
                        allBtns.forEach(function(btn) {
                            btn.classList.toggle('selected', btn.dataset.weapon === weapon);
                        });

                        var weaponNames = {
                            'pepperball': 'Backup deploys pepper ball launcher',
                            '40mm': 'Backup deploys 40mm less-lethal launcher',
                            'rifle': 'Backup deploys patrol rifle'
                        };

                        if (inputDo) {
                            inputDo.value = weaponNames[weapon] || 'Backup readies weapon';
                        }
                    }

                    // Visual feedback on backup officer
                    var backup = document.getElementById('backup-pos');
                    if (backup) {
                        backup.classList.add('active');
                        setTimeout(function() { backup.classList.remove('active'); }, 500);
                    }
                }

                // Track mouse/touch down for click vs drag detection
                function handleBackupPointerStart(e) {
                    if (e.target.closest('#backup-pos')) {
                        clickStartTime = Date.now();
                        var clientX = e.touches ? e.touches[0].clientX : e.clientX;
                        var clientY = e.touches ? e.touches[0].clientY : e.clientY;
                        clickStartPos = { x: clientX, y: clientY };
                    }
                }

                // Handle click/tap on backup officer
                function handleBackupPointerEnd(e) {
                    var backupMarker = e.target.closest('#backup-pos');
                    if (backupMarker && !isBackupMenuOpen) {
                        var timeDiff = Date.now() - clickStartTime;
                        var clientX = e.changedTouches ? e.changedTouches[0].clientX : e.clientX;
                        var clientY = e.changedTouches ? e.changedTouches[0].clientY : e.clientY;
                        var distX = Math.abs(clientX - clickStartPos.x);
                        var distY = Math.abs(clientY - clickStartPos.y);

                        if (timeDiff < 300 && distX < 10 && distY < 10) {
                            var rect = backupMarker.getBoundingClientRect();
                            // On mobile, position menu below marker
                            var menuX = rect.left - 50;
                            var menuY = rect.top - 120;
                            if (window.innerWidth < 768) {
                                menuX = Math.max(10, Math.min(rect.left - 100, window.innerWidth - 220));
                                menuY = rect.bottom + 10;
                            }
                            showBackupMenu(menuX, menuY);
                        }
                    }
                }

                document.addEventListener('mousedown', handleBackupPointerStart);
                document.addEventListener('touchstart', handleBackupPointerStart, { passive: true });
                document.addEventListener('mouseup', handleBackupPointerEnd);
                document.addEventListener('touchend', handleBackupPointerEnd);

                // Handle sending backup command
                function handleBackupCommand() {
                    var commandInput = document.getElementById('backup-command-input');
                    var inputDo = document.getElementById('input-do');
                    if (!commandInput || !commandInput.value.trim()) return;

                    var command = commandInput.value.trim();
                    if (inputDo) {
                        inputDo.value = 'Tell backup officer: "' + command + '"';
                    }

                    // Visual feedback on backup officer
                    var backupMarker = document.getElementById('backup-pos');
                    if (backupMarker) {
                        backupMarker.classList.add('active');
                        setTimeout(function() { backupMarker.classList.remove('active'); }, 500);
                    }

                    // Clear input and close menu
                    commandInput.value = '';
                    hideBackupMenu();
                }

                // Handle weapon button clicks and command send
                document.addEventListener('click', function(e) {
                    // Handle send command button
                    if (e.target.closest('.backup-command-send')) {
                        e.preventDefault();
                        handleBackupCommand();
                        return;
                    }

                    var weaponBtn = e.target.closest('.backup-action-menu .officer-weapon-btn');
                    if (weaponBtn) {
                        e.preventDefault();
                        handleBackupWeapon(weaponBtn.dataset.weapon);
                        return;
                    }

                    // Click elsewhere - close menu
                    if (isBackupMenuOpen && !e.target.closest('.backup-action-menu') && !e.target.closest('#backup-pos')) {
                        hideBackupMenu();
                    }
                });

                // Escape to close
                document.addEventListener('keydown', function(e) {
                    if (e.key === 'Escape' && isBackupMenuOpen) {
                        hideBackupMenu();
                    }
                });
            })();

            // ========== FORCE OPTIONS MENU FOR SUBJECT MARKER ==========
            (function() {
                var forceMenu = null;
                var isMenuOpen = false;

                // Create the force options menu HTML
                function createForceMenu() {
                    var menu = document.createElement('div');
                    menu.className = 'force-options-menu';
                    menu.id = 'force-options-menu';
                    menu.innerHTML = `
                        <div class="force-menu-header">Force Options</div>
                        <button class="force-option lethal" data-action="shoot">
                            <span class="force-icon">ðŸ”«</span>
                            <span>Shoot</span>
                        </button>
                        <div class="force-menu-divider"></div>
                        <button class="force-option less-lethal" data-action="taze">
                            <span class="force-icon">âš¡</span>
                            <span>Taze</span>
                        </button>
                        <button class="force-option less-lethal" data-action="oc-spray">
                            <span class="force-icon">ðŸŒ¶</span>
                            <span>OC Spray</span>
                        </button>
                        <div class="force-menu-divider"></div>
                        <button class="force-option control" data-action="fight">
                            <span class="force-icon">ðŸ‘Š</span>
                            <span>Fight</span>
                        </button>
                        <button class="force-option arrest" data-action="cuff">
                            <span class="force-icon">ðŸ”—</span>
                            <span>Cuff</span>
                        </button>
                    `;
                    document.body.appendChild(menu);
                    return menu;
                }

                // Get or create the menu
                function getForceMenu() {
                    if (!forceMenu) {
                        forceMenu = document.getElementById('force-options-menu') || createForceMenu();
                    }
                    return forceMenu;
                }

                // Show menu at position
                function showMenu(x, y) {
                    var menu = getForceMenu();

                    // Position menu
                    menu.style.left = x + 'px';
                    menu.style.top = y + 'px';

                    // Show menu
                    menu.classList.add('visible');
                    isMenuOpen = true;

                    // Adjust if off screen
                    setTimeout(function() {
                        var rect = menu.getBoundingClientRect();
                        if (rect.right > window.innerWidth) {
                            menu.style.left = (x - rect.width) + 'px';
                        }
                        if (rect.bottom > window.innerHeight) {
                            menu.style.top = (y - rect.height) + 'px';
                        }
                    }, 0);
                }

                // Hide menu
                function hideMenu() {
                    var menu = getForceMenu();
                    menu.classList.remove('visible');
                    isMenuOpen = false;
                    // Reset selection when closing
                    selectedForceAction = null;
                    var allBtns = document.querySelectorAll('.force-option');
                    allBtns.forEach(function(btn) { btn.classList.remove('selected'); });
                }

                // Track currently selected force action
                var selectedForceAction = null;

                // Handle force action selection (toggle on/off)
                function handleForceAction(action, buttonEl) {
                    // Get the clicked subject info
                    var clickedSubject = window.lastClickedSubject || { element: document.getElementById('subject-pos'), label: 'subject' };
                    var subjectLabel = clickedSubject.label || 'subject';
                    var inputDo = document.getElementById('input-do');

                    // Get all force option buttons
                    var allBtns = document.querySelectorAll('.force-option');

                    // Toggle off if clicking same action
                    if (selectedForceAction === action) {
                        selectedForceAction = null;
                        window.pendingForceAction = null;
                        allBtns.forEach(function(btn) { btn.classList.remove('selected'); });
                        if (inputDo) {
                            inputDo.value = '';
                        }
                        return;
                    }

                    // Select this action
                    selectedForceAction = action;
                    allBtns.forEach(function(btn) {
                        btn.classList.toggle('selected', btn.dataset.action === action);
                    });

                    var actionTexts = {
                        'shoot': 'Draw weapon and fire at ' + subjectLabel,
                        'taze': 'Deploy taser on ' + subjectLabel,
                        'oc-spray': 'Deploy OC spray on ' + subjectLabel,
                        'fight': 'Engage ' + subjectLabel + ' with physical control techniques',
                        'cuff': 'Place ' + subjectLabel + ' in handcuffs'
                    };

                    var actionText = actionTexts[action] || action;

                    // Store the pending force action (effect applied on send, not on select)
                    window.pendingForceAction = action;

                    // Populate the "Do" input with the action
                    if (inputDo) {
                        inputDo.value = actionText;

                        // Trigger the action update
                        if (typeof updateCurrentAction === 'function') {
                            updateCurrentAction();
                        }
                    }

                    // Visual feedback on the clicked subject
                    if (clickedSubject.element) {
                        clickedSubject.element.classList.add('active');
                        setTimeout(function() {
                            clickedSubject.element.classList.remove('active');
                        }, 500);
                    }
                }

                // Reset force selection when menu is hidden
                function resetForceSelection() {
                    selectedForceAction = null;
                    var allBtns = document.querySelectorAll('.force-option');
                    allBtns.forEach(function(btn) { btn.classList.remove('selected'); });
                }

                // Click on any subject marker (S1, S2, etc.) or stick figure
                document.addEventListener('click', function(e) {
                    // Check for any subject-type marker (subject, subject2, person2) or stick figure
                    var subjectMarker = e.target.closest('.position-marker.subject, .position-marker.subject2, .position-marker.person2, .stick-figure.subject1, .stick-figure.subject2');

                    if (subjectMarker) {
                        e.preventDefault();
                        e.stopPropagation();

                        // Store which subject was clicked for the action
                        var subjectLabel = (subjectMarker.id === 'subject-pos' || subjectMarker.classList.contains('subject1')) ? 'Party 1' : 'Party 2';
                        window.lastClickedSubject = { element: subjectMarker, label: subjectLabel };

                        var rect = subjectMarker.getBoundingClientRect();
                        showMenu(rect.right + 5, rect.top);
                        return;
                    }

                    // Click on force option
                    var forceOption = e.target.closest('.force-option');
                    if (forceOption) {
                        e.preventDefault();
                        var action = forceOption.dataset.action;
                        handleForceAction(action);
                        return;
                    }

                    // Click elsewhere - close menu
                    if (isMenuOpen && !e.target.closest('.force-options-menu')) {
                        hideMenu();
                    }
                });

                // Close on escape key
                document.addEventListener('keydown', function(e) {
                    if (e.key === 'Escape' && isMenuOpen) {
                        hideMenu();
                    }
                });
            })();

            // ========== OFFICER ACTION MENU ==========
            (function() {
                var officerMenu = null;
                var isOfficerMenuOpen = false;
                var clickStartTime = 0;
                var clickStartPos = { x: 0, y: 0 };
                var currentWeapon = null; // Track currently drawn weapon

                // Create the officer action menu HTML
                function createOfficerMenu() {
                    var menu = document.createElement('div');
                    menu.className = 'officer-action-menu';
                    menu.id = 'officer-action-menu';
                    menu.innerHTML = `
                        <div class="officer-menu-header">Officer Actions</div>
                        <div class="officer-menu-input">
                            <label>Say</label>
                            <textarea id="officer-menu-say" placeholder="What do you say..." rows="2"></textarea>
                        </div>
                        <div class="officer-menu-input">
                            <label>Radio</label>
                            <textarea id="officer-menu-radio" placeholder="Dispatch..." rows="2"></textarea>
                        </div>
                        <div class="officer-menu-divider"></div>
                        <div class="officer-menu-section">Draw & Ready</div>
                        <div class="officer-weapon-btns">
                            <button class="officer-weapon-btn pistol" data-weapon="pistol">
                                <span class="weapon-icon">ðŸ”«</span>
                                <span>Pistol</span>
                            </button>
                            <button class="officer-weapon-btn taser" data-weapon="taser">
                                <span class="weapon-icon">âš¡</span>
                                <span>Taser</span>
                            </button>
                        </div>
                        <button class="officer-menu-send" id="officer-menu-send">Send</button>
                    `;
                    document.body.appendChild(menu);
                    return menu;
                }

                function getOfficerMenu() {
                    if (!officerMenu) {
                        officerMenu = document.getElementById('officer-action-menu') || createOfficerMenu();
                    }
                    return officerMenu;
                }

                function showOfficerMenu(x, y) {
                    var menu = getOfficerMenu();
                    menu.style.left = x + 'px';
                    menu.style.top = y + 'px';
                    menu.classList.add('visible');
                    isOfficerMenuOpen = true;

                    // Focus the say input
                    setTimeout(function() {
                        var sayInput = document.getElementById('officer-menu-say');
                        if (sayInput) sayInput.focus();
                    }, 100);

                    // Adjust if off screen
                    setTimeout(function() {
                        var rect = menu.getBoundingClientRect();
                        if (rect.right > window.innerWidth) {
                            menu.style.left = (x - rect.width) + 'px';
                        }
                        if (rect.bottom > window.innerHeight) {
                            menu.style.top = (y - rect.height) + 'px';
                        }
                    }, 0);
                }

                function hideOfficerMenu() {
                    var menu = getOfficerMenu();
                    menu.classList.remove('visible');
                    isOfficerMenuOpen = false;
                }

                function handleWeaponDraw(weapon) {
                    var inputDo = document.getElementById('input-do');
                    var pistolBtn = document.querySelector('.officer-weapon-btn.pistol');
                    var taserBtn = document.querySelector('.officer-weapon-btn.taser');

                    // Toggle off if clicking same weapon
                    if (currentWeapon === weapon) {
                        currentWeapon = null;
                        if (inputDo) {
                            inputDo.value = 'Holster weapon';
                            if (typeof updateCurrentAction === 'function') {
                                updateCurrentAction();
                            }
                        }
                        // Remove selected state from both buttons
                        if (pistolBtn) pistolBtn.classList.remove('selected');
                        if (taserBtn) taserBtn.classList.remove('selected');
                    } else {
                        // Draw the weapon
                        currentWeapon = weapon;
                        var actionText = weapon === 'pistol' ? 'Draw service pistol and aim at subject' : 'Draw taser and aim at subject';
                        if (inputDo) {
                            inputDo.value = actionText;
                            if (typeof updateCurrentAction === 'function') {
                                updateCurrentAction();
                            }
                        }
                        // Update button states
                        if (pistolBtn) pistolBtn.classList.toggle('selected', weapon === 'pistol');
                        if (taserBtn) taserBtn.classList.toggle('selected', weapon === 'taser');
                    }

                    // Visual feedback on officer + weapon drawn indicator
                    var officer = document.getElementById('officer-pos');
                    if (officer) {
                        officer.classList.add('active');
                        setTimeout(function() { officer.classList.remove('active'); }, 500);

                        // Show/hide weapon drawn indicator
                        if (currentWeapon) {
                            officer.classList.add('weapon-drawn');
                            officer.setAttribute('data-weapon', currentWeapon);
                        } else {
                            officer.classList.remove('weapon-drawn');
                            officer.removeAttribute('data-weapon');
                        }
                    }
                }

                function handleOfficerSend() {
                    var sayInput = document.getElementById('officer-menu-say');
                    var radioInput = document.getElementById('officer-menu-radio');
                    var mainSayInput = document.getElementById('input-say');
                    var mainRadioInput = document.getElementById('input-radio');

                    // Transfer values to main inputs
                    if (sayInput && mainSayInput) {
                        mainSayInput.value = sayInput.value;
                    }
                    if (radioInput && mainRadioInput) {
                        mainRadioInput.value = radioInput.value;
                    }

                    // Clear menu inputs
                    if (sayInput) sayInput.value = '';
                    if (radioInput) radioInput.value = '';

                    hideOfficerMenu();

                    // Trigger send
                    var sendBtn = document.getElementById('send-btn');
                    if (sendBtn) sendBtn.click();
                }

                // Track mouse/touch down on officer to distinguish click from drag
                function handleOfficerPointerStart(e) {
                    var marker = e.target.closest('.position-marker.officer');
                    // Only track for main officer, not backup
                    if (marker && marker.id === 'officer-pos') {
                        clickStartTime = Date.now();
                        var clientX = e.touches ? e.touches[0].clientX : e.clientX;
                        var clientY = e.touches ? e.touches[0].clientY : e.clientY;
                        clickStartPos = { x: clientX, y: clientY };
                    }
                }

                // Handle click/tap (not drag) on officer
                function handleOfficerPointerEnd(e) {
                    var officerMarker = e.target.closest('.position-marker.officer');
                    // Only show menu for main officer, not backup
                    if (officerMarker && officerMarker.id === 'officer-pos' && !isOfficerMenuOpen) {
                        var timeDiff = Date.now() - clickStartTime;
                        var clientX = e.changedTouches ? e.changedTouches[0].clientX : e.clientX;
                        var clientY = e.changedTouches ? e.changedTouches[0].clientY : e.clientY;
                        var distX = Math.abs(clientX - clickStartPos.x);
                        var distY = Math.abs(clientY - clickStartPos.y);

                        // Only show menu if it was a quick tap without much movement (not a drag)
                        if (timeDiff < 300 && distX < 10 && distY < 10) {
                            var rect = officerMarker.getBoundingClientRect();
                            // On mobile, position menu centered above marker
                            var menuX = rect.left - 100;
                            var menuY = rect.top - 10;
                            if (window.innerWidth < 768) {
                                menuX = Math.max(10, Math.min(rect.left - 140, window.innerWidth - 290));
                                menuY = rect.bottom + 10;
                            }
                            showOfficerMenu(menuX, menuY);
                        }
                    }
                }

                document.addEventListener('mousedown', handleOfficerPointerStart);
                document.addEventListener('touchstart', handleOfficerPointerStart, { passive: true });
                document.addEventListener('mouseup', handleOfficerPointerEnd);
                document.addEventListener('touchend', handleOfficerPointerEnd);

                // Handle clicks within the menu
                document.addEventListener('click', function(e) {
                    // Weapon button click
                    var weaponBtn = e.target.closest('.officer-weapon-btn');
                    if (weaponBtn) {
                        e.preventDefault();
                        handleWeaponDraw(weaponBtn.dataset.weapon);
                        return;
                    }

                    // Send button click
                    if (e.target.closest('.officer-menu-send')) {
                        e.preventDefault();
                        handleOfficerSend();
                        return;
                    }

                    // Click elsewhere - close menu
                    if (isOfficerMenuOpen && !e.target.closest('.officer-action-menu') && !e.target.closest('.position-marker.officer')) {
                        hideOfficerMenu();
                    }
                });

                // Ctrl+Enter in menu inputs triggers send (Enter allows new lines in textarea)
                document.addEventListener('keydown', function(e) {
                    if ((e.ctrlKey || e.metaKey) && e.key === 'Enter' && isOfficerMenuOpen) {
                        var isInMenuInput = e.target.closest('.officer-action-menu textarea') || e.target.closest('.officer-action-menu input');
                        if (isInMenuInput) {
                            e.preventDefault();
                            handleOfficerSend();
                        }
                    }
                    if (e.key === 'Escape' && isOfficerMenuOpen) {
                        hideOfficerMenu();
                    }
                });
            })();

            // Keyboard shortcuts
            function handleKeydown(event) {
                if ((event.ctrlKey || event.metaKey) && event.key === 'Enter') {
                    event.preventDefault();
                    sendMessage();
                }
            }
            // Only Do input is visible now (Say/Radio in officer popup)
            inputDo.addEventListener('keydown', handleKeydown);

            // Arrow key navigation
            document.addEventListener('keydown', function(e) {
                if (scenarioSelectSection.style.display === 'none') return;

                var cards = Array.from(document.querySelectorAll('.scenario-card'));
                var selectedCard = document.querySelector('.scenario-card.selected');
                var currentIndex = cards.indexOf(selectedCard);

                if (e.key === 'ArrowRight' || e.key === 'ArrowDown') {
                    e.preventDefault();
                    var nextIndex = (currentIndex + 1) % cards.length;
                    cards.forEach(function(c) { c.classList.remove('selected'); });
                    cards[nextIndex].classList.add('selected');
                    cards[nextIndex].scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                    selectedScenario = cards[nextIndex].dataset.scenario;
                } else if (e.key === 'ArrowLeft' || e.key === 'ArrowUp') {
                    e.preventDefault();
                    var prevIndex = (currentIndex - 1 + cards.length) % cards.length;
                    cards.forEach(function(c) { c.classList.remove('selected'); });
                    cards[prevIndex].classList.add('selected');
                    cards[prevIndex].scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                    selectedScenario = cards[prevIndex].dataset.scenario;
                } else if (e.key === 'Enter' && !e.ctrlKey && !e.metaKey) {
                    document.getElementById('start-scenario-btn').click();
                }
            });

            // Initialize
            initScenarioGrid();
            initDifficultyGrid();
            updateProgress('select');

            // ========== PATROL CAR ROTATION ==========
            var carRotations = {}; // Track rotation for each car

            function initPatrolCarRotation() {
                var patrolCars = document.querySelectorAll('.patrol-car.draggable');
                patrolCars.forEach(function(car) {
                    // Add rotate button if not exists
                    if (!car.querySelector('.rotate-btn')) {
                        var rotateBtn = document.createElement('div');
                        rotateBtn.className = 'rotate-btn';
                        rotateBtn.innerHTML = 'â†»';
                        rotateBtn.title = 'Click to rotate 45Â°';

                        // Prevent drag when clicking rotate button
                        rotateBtn.addEventListener('mousedown', function(e) {
                            e.stopPropagation();
                            e.preventDefault();
                        });

                        rotateBtn.addEventListener('touchstart', function(e) {
                            e.stopPropagation();
                            e.preventDefault();
                        });

                        // Rotate car on click
                        rotateBtn.addEventListener('click', function(e) {
                            e.stopPropagation();
                            e.preventDefault();

                            var carId = car.id || 'car-default';
                            var currentAngle = carRotations[carId] || 0;
                            var newAngle = (currentAngle + 45) % 360;

                            car.style.transform = 'rotate(' + newAngle + 'deg)';
                            carRotations[carId] = newAngle;

                            console.log('Car rotated to', newAngle, 'degrees');
                        });

                        car.appendChild(rotateBtn);
                    }

                    // Initialize rotation
                    var carId = car.id || 'car-' + Math.random().toString(36).substr(2, 9);
                    if (!car.id) car.id = carId;
                    carRotations[carId] = 0;
                    car.style.transform = 'rotate(0deg)';
                });

                console.log('Patrol car rotation initialized for', patrolCars.length, 'cars');
            }

            // ========== POSITION OFFICER AT PATROL CAR ==========
            function positionOfficerAtPatrolCar() {
                var officer = document.getElementById('officer-pos');
                var patrolCar = document.querySelector('.patrol-car:not(.backup-car)');
                var scene = document.getElementById('position-scene');

                if (!officer || !patrolCar || !scene) return;

                // Get patrol car position
                var carRect = patrolCar.getBoundingClientRect();
                var sceneRect = scene.getBoundingClientRect();

                // Position officer just outside driver door of patrol car
                var carLeft = patrolCar.offsetLeft || parseInt(patrolCar.style.left) || 50;
                var carBottom = patrolCar.offsetTop + patrolCar.offsetHeight;

                // Set officer position near patrol car (driver side, slightly behind)
                officer.style.left = (carLeft + 60) + 'px';
                officer.style.top = 'auto';
                officer.style.bottom = '45px';
                officer.style.right = 'auto';
                officer.style.transform = 'translateX(-50%)';
            }

            // ========== SECOND PERSON STEPPING OUT ==========
            var secondPersonInside = false;
            var secondPersonOut = false;

            function initSecondPersonInside(scenarioType) {
                // Scenarios where second person starts inside
                var insideScenarios = ['domestic', 'domestic_weapons'];
                if (insideScenarios.indexOf(scenarioType) !== -1) {
                    secondPersonInside = true;
                    secondPersonOut = false;

                    var subject2 = document.getElementById('subject2-pos');
                    if (subject2) {
                        subject2.classList.add('inside-building');
                        subject2.classList.remove('stepping-out');
                    }

                    // Add indicator that someone is inside
                    var scene = document.getElementById('position-scene');
                    if (scene && !document.getElementById('inside-indicator')) {
                        var indicator = document.createElement('div');
                        indicator.className = 'inside-indicator';
                        indicator.id = 'inside-indicator';
                        indicator.innerHTML = 'ðŸ‘¤ Someone inside';
                        indicator.title = 'Ask them to step out';
                        scene.appendChild(indicator);
                    }
                }
            }

            function checkForStepOutCommand(message) {
                if (!secondPersonInside || secondPersonOut) return false;

                var stepOutKeywords = [
                    'step out', 'come out', 'come outside', 'step outside',
                    'who else', 'anyone else', 'is anyone', 'other person',
                    'bring them out', 'get them out', 'have them come',
                    'partner', 'spouse', 'wife', 'husband', 'boyfriend', 'girlfriend',
                    'other party', 'second person', 'the other'
                ];

                var lowerMsg = message.toLowerCase();
                for (var i = 0; i < stepOutKeywords.length; i++) {
                    if (lowerMsg.indexOf(stepOutKeywords[i]) !== -1) {
                        return true;
                    }
                }
                return false;
            }

            function makeSecondPersonStepOut() {
                if (secondPersonOut) return;
                secondPersonOut = true;

                var subject2 = document.getElementById('subject2-pos');
                if (subject2) {
                    subject2.classList.remove('inside-building');
                    subject2.classList.add('stepping-out');
                }

                // Remove inside indicator
                var indicator = document.getElementById('inside-indicator');
                if (indicator) {
                    indicator.remove();
                }

                // Add system message
                addMessage('system', 'ðŸ‘¤ A second person has stepped out of the residence.');
            }

            // ========== PASS/FAIL RESULT OVERLAY ==========
            function showResultOverlay(passed, score) {
                var overlay = document.createElement('div');
                overlay.className = 'result-overlay ' + (passed ? 'result-pass' : 'result-fail');
                overlay.id = 'result-overlay';

                var icon = document.createElement('div');
                icon.className = 'result-icon';
                icon.textContent = passed ? 'â˜•ðŸ©' : 'âŒ';

                var title = document.createElement('div');
                title.className = 'result-title';
                title.textContent = passed ? 'PASSED!' : 'FAILED';

                var scoreDiv = document.createElement('div');
                scoreDiv.className = 'result-score';
                scoreDiv.textContent = 'Score: ' + score + '/100';

                var message = document.createElement('div');
                message.className = 'result-message';
                message.textContent = passed
                    ? 'Great work, Officer! Enjoy your coffee and donuts!'
                    : 'Sorry, you failed. You got it next time!';

                var btn = document.createElement('button');
                btn.className = 'result-continue-btn';
                btn.textContent = 'View Detailed Debrief';
                btn.onclick = function() {
                    overlay.remove();
                };

                overlay.appendChild(icon);
                overlay.appendChild(title);
                overlay.appendChild(scoreDiv);
                overlay.appendChild(message);
                overlay.appendChild(btn);

                document.body.appendChild(overlay);

                // Add confetti for pass
                if (passed) {
                    for (var i = 0; i < 50; i++) {
                        setTimeout(function() {
                            var confetti = document.createElement('div');
                            confetti.className = 'confetti';
                            confetti.style.left = Math.random() * 100 + '%';
                            confetti.style.background = ['#FFD700', '#34D399', '#60A5FA', '#F472B6', '#FBBF24'][Math.floor(Math.random() * 5)];
                            confetti.style.animationDelay = Math.random() * 2 + 's';
                            overlay.appendChild(confetti);
                        }, i * 50);
                    }
                }
            }

            // ========== HELP TOGGLE SYSTEM ==========
            var helpVisible = false;

            function createHelpSystem() {
                // Help button
                var helpBtn = document.createElement('button');
                helpBtn.className = 'help-toggle-btn';
                helpBtn.id = 'help-toggle-btn';
                helpBtn.innerHTML = '?';
                helpBtn.title = 'Toggle Help';
                helpBtn.onclick = toggleHelp;

                // Help panel
                var helpPanel = document.createElement('div');
                helpPanel.className = 'help-panel';
                helpPanel.id = 'help-panel';
                helpPanel.innerHTML = `
                    <h4>ðŸ’¡ Training Tips</h4>
                    <p><strong>Click subjects</strong> to access force options</p>
                    <p><strong>Click officer</strong> to draw weapons or speak</p>
                    <p><strong>Request backup</strong> via radio for assistance</p>
                    <div class="help-hint" id="contextual-hint">
                        Start by identifying yourself and stating your purpose.
                    </div>
                `;

                document.body.appendChild(helpBtn);
                document.body.appendChild(helpPanel);
            }

            function toggleHelp() {
                helpVisible = !helpVisible;
                var panel = document.getElementById('help-panel');
                var btn = document.getElementById('help-toggle-btn');
                if (panel) panel.classList.toggle('visible', helpVisible);
                if (btn) btn.classList.toggle('active', helpVisible);
            }

            function updateContextualHint(hint) {
                var hintEl = document.getElementById('contextual-hint');
                if (hintEl && hint) {
                    hintEl.textContent = hint;
                }
            }

            // ========== POST-CUFF ACTIONS ==========
            var subjectCuffed = false;
            var mirandaRead = false;
            var transportedToSquad = false;

            function showPostCuffActions() {
                var container = document.getElementById('post-cuff-actions');
                if (container) {
                    container.classList.add('visible');
                }
            }

            function hidePostCuffActions() {
                var container = document.getElementById('post-cuff-actions');
                if (container) {
                    container.classList.remove('visible');
                }
            }

            function handleMirandaRights() {
                if (mirandaRead) return;
                mirandaRead = true;

                var mirandaBtn = document.getElementById('miranda-btn');
                if (mirandaBtn) mirandaBtn.classList.add('active');

                var mirandaText = "You have the right to remain silent. Anything you say can and will be used against you in a court of law. You have the right to an attorney. If you cannot afford an attorney, one will be appointed for you.";

                var inputSay = document.getElementById('input-say');
                if (inputSay) {
                    inputSay.value = mirandaText;
                }

                addMessage('officer', '[MIRANDA WARNING]: ' + mirandaText);
            }

            function handleTransportToSquad() {
                if (transportedToSquad) return;
                transportedToSquad = true;

                var transportBtn = document.getElementById('transport-btn');
                if (transportBtn) transportBtn.classList.add('active');

                var inputDo = document.getElementById('input-do');
                if (inputDo) {
                    inputDo.value = 'Transport subject to patrol vehicle and secure in back seat';
                }

                addMessage('officer', '[ACTION]: Transporting subject to patrol vehicle');

                // Move subject marker to near patrol car
                var subject = document.getElementById('subject-pos');
                var patrolCar = document.querySelector('.patrol-car:not(.backup-car)');
                if (subject && patrolCar) {
                    subject.style.transition = 'all 1s ease-in-out';
                    subject.style.left = '25%';
                    subject.style.top = '85%';
                }
            }

            // ========== FORCE EFFECT INDICATORS ==========
            function ensureStatusBadges(subject) {
                // Add all status badge elements if they don't exist
                var badges = ['cuffed', 'tazed', 'oc', 'shot', 'prone', 'fleeing'];
                var labels = {
                    'cuffed': 'ðŸ”— HANDCUFFED',
                    'tazed': 'âš¡ TAZED',
                    'oc': 'ðŸŒ¶ï¸ OC SPRAYED',
                    'shot': 'ðŸ©¸ SHOT',
                    'prone': 'âœ“ COMPLIANT',
                    'fleeing': 'ðŸƒ FLEEING'
                };

                badges.forEach(function(badge) {
                    if (!subject.querySelector('.subject-status-badge.' + badge + '-badge')) {
                        var badgeEl = document.createElement('div');
                        badgeEl.className = 'subject-status-badge ' + badge + '-badge';
                        badgeEl.textContent = labels[badge];
                        subject.appendChild(badgeEl);
                    }
                });
            }

            function applyForceEffect(action, targetId) {
                var subject = document.getElementById(targetId || 'subject-pos');
                if (!subject) return;

                // Ensure status badges exist
                ensureStatusBadges(subject);

                if (action === 'taze' || action === 'taser') {
                    // Animation effect
                    subject.classList.add('tazed');
                    setTimeout(function() { subject.classList.remove('tazed'); }, 900);
                    // Persistent status
                    subject.classList.add('tazed-status');
                    console.log('Subject TAZED - status applied');

                } else if (action === 'oc-spray' || action === 'oc' || action === 'pepper') {
                    // Animation effect
                    subject.classList.add('oc-sprayed');
                    setTimeout(function() { subject.classList.remove('oc-sprayed'); }, 500);
                    // Persistent status
                    subject.classList.add('oc-status');
                    console.log('Subject OC SPRAYED - status applied');

                } else if (action === 'cuff' || action === 'handcuff') {
                    subject.classList.add('cuffed');
                    subjectCuffed = true;
                    showPostCuffActions();
                    console.log('Subject HANDCUFFED - status applied');

                } else if (action === 'shoot' || action === 'shot' || action === 'firearm') {
                    subject.classList.add('shot');
                    console.log('Subject SHOT - status applied');

                } else if (action === 'prone' || action === 'ground' || action === 'comply') {
                    subject.classList.add('prone');
                    console.log('Subject PRONE/COMPLIANT - status applied');

                } else if (action === 'flee' || action === 'run' || action === 'fleeing') {
                    subject.classList.add('fleeing');
                    console.log('Subject FLEEING - status applied');
                }
            }

            // Clear all status effects (for scenario reset)
            function clearAllStatusEffects(subject) {
                if (!subject) subject = document.getElementById('subject-pos');
                if (!subject) return;

                var statuses = ['cuffed', 'tazed', 'tazed-status', 'oc-sprayed', 'oc-status', 'shot', 'prone', 'fleeing'];
                statuses.forEach(function(status) {
                    subject.classList.remove(status);
                });
            }

            // Parse AI response for status effects
            function parseResponseForStatusEffects(responseText) {
                if (!responseText) return;
                var lowerText = responseText.toLowerCase();

                // Fleeing/running away
                if (lowerText.match(/\b(flees?|runs?\s*away|takes?\s*off|bolts?|sprints?\s*away|running\s*away)\b/)) {
                    applyForceEffect('flee');
                }

                // Falls down / compliant / prone
                if (lowerText.match(/\b(falls?\s*(to|on)\s*(the\s*)?(ground|floor)|drops?\s*to|goes?\s*prone|lies?\s*down|complies?|compliant|surrenders?)\b/)) {
                    applyForceEffect('prone');
                }

                // Shot / wounded
                if (lowerText.match(/\b(shot|wounded|hit\s*by\s*(the\s*)?(bullet|round)|bullet\s*strikes?|collapses?\s*from|bleeding\s*from\s*gunshot)\b/)) {
                    applyForceEffect('shoot');
                }

                // Tazed effects
                if (lowerText.match(/\b(taser\s*(prongs?\s*)?(hit|strike|connect)|tased|tazed|electric\s*shock|falls?\s*shaking|convulses?|neuromuscular\s*incapacitation)\b/)) {
                    applyForceEffect('taze');
                }

                // OC spray effects
                if (lowerText.match(/\b(oc\s*(spray\s*)?(hits?|strikes?|connects?)|pepper\s*spray|eyes?\s*burning|can'?t\s*see|rubbing\s*(his|her|their)\s*eyes?|coughing\s*from\s*spray)\b/)) {
                    applyForceEffect('oc-spray');
                }
            }

            // ========== WEAPON DRAWN INDICATOR ==========
            function setOfficerWeaponDrawn(drawn, weaponType) {
                var officer = document.getElementById('officer-pos');
                if (officer) {
                    officer.classList.toggle('weapon-drawn', drawn);
                }
            }

            function setBackupWeaponDrawn(drawn) {
                var backup = document.getElementById('backup-pos');
                if (backup) {
                    backup.classList.toggle('weapon-drawn', drawn);
                }
            }

            // Initialize help system when chat starts
            var originalStartScenario = startScenario;
            startScenario = function() {
                originalStartScenario();

                // Create help system if not exists
                if (!document.getElementById('help-toggle-btn')) {
                    createHelpSystem();
                }

                // Clear any previous status effects
                if (typeof clearAllStatusEffects === 'function') {
                    clearAllStatusEffects(document.getElementById('subject-pos'));
                    clearAllStatusEffects(document.getElementById('subject2-pos'));
                }

                // Reset states
                subjectCuffed = false;
                mirandaRead = false;
                transportedToSquad = false;
                hidePostCuffActions();
            };


        })();
    </script>
</body>
</html>
